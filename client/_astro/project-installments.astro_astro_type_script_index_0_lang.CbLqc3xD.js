import{o as x,d as C,a as u,g as b,s as I,b as y,q as B,c as w,f as p,h as D}from"./client.xTG1qH6U.js";document.addEventListener("DOMContentLoaded",()=>{const s=document.getElementById("auth-loading-message"),e=document.getElementById("admin-login-container"),t=document.getElementById("page-content");x(y,async a=>{if(s&&(s.style.display="none"),a)try{const i=C(u,"users",a.uid),n=await b(i);n.exists()&&n.data().role==="admin"?(t&&(t.style.display="block"),e&&(e.style.display="none"),L()):(await I(y),e&&(e.style.display="block"),t&&(t.style.display="none"))}catch(i){console.error("Auth Check Error:",i),await I(y),e&&(e.style.display="block"),t&&(t.style.display="none")}else t&&(t.style.display="none"),e&&(e.style.display="block")})});async function L(){const s=document.getElementById("loader"),e=document.getElementById("error-display"),t=document.getElementById("error-message"),a=document.getElementById("no-contracts-message"),i=document.getElementById("add-contract-btn"),n=document.getElementById("notifications-btn"),o=new URLSearchParams(window.location.search).get("projectId");if(!o){s.style.display="none",t.textContent="لم يتم تحديد مشروع. الرجاء العودة والمحاولة مرة أخرى.",e.style.display="block";return}i.href=`/admin/add-contract?projectId=${o}`,n.href=`/admin/notifications?projectId=${o}`;const l=r=>(r||0).toLocaleString("ar-EG",{style:"currency",currency:"EGP"});try{const r=C(u,"projects",o),g=await b(r);if(!g.exists()){s.style.display="none",t.textContent="المشروع المحدد غير موجود.",e.style.display="block";return}const j=g.data();document.getElementById("project-name").textContent+=j.projectName||"غير مسمى";const k=B(w(u,"installments"),p("projectId","==",o)),f=await D(k);await N(o);const m=new Map;let h=0,E=0;f.empty?a.style.display="block":(f.forEach(A=>{const c=A.data();c.status==="paid"&&(h+=c.installmentAmount||0),m.has(c.customerName)||(m.set(c.customerName,{customerName:c.customerName,customerPhone:c.customerPhone,unitType:c.unitType,unitLocation:c.unitLocation,totalAmount:c.totalAmount}),E+=c.totalAmount||0)}),P(m,o,l)),document.getElementById("summary-total-contracts").textContent=m.size,document.getElementById("summary-total-amount").textContent=l(E),document.getElementById("summary-total-paid").textContent=l(h),s.style.display="none"}catch(r){console.error("Error fetching data: ",r),s.style.display="none",t.textContent="حدث خطأ أثناء تحميل البيانات. يرجى مراجعة الـ console لمعرفة التفاصيل.",e.style.display="block"}}async function N(s){const e=document.querySelector(".notification-badge");try{const t=new Date;t.setHours(0,0,0,0);const a=new Date;a.setDate(t.getDate()+7);const i=B(w(u,"installments"),p("projectId","==",s),p("status","==","pending")),o=(await D(i)).docs.map(l=>l.data()).filter(l=>{const r=l.dueDate.toDate();return r<t||r>=t&&r<=a}).length;o>0?(e.textContent=o,e.style.display="inline-block"):e.style.display="none"}catch(t){console.error("Error fetching notifications count: ",t),e.style.display="none"}}function P(s,e,t){const a=document.getElementById("contracts-list");a.innerHTML="";const i={apartment:"شقة",shop:"محل",basement:"بدروم",other:"أخرى"};s.forEach(n=>{const d=document.createElement("a");d.className="contract-item",d.href=`/admin/contract-details?projectId=${e}&customerName=${encodeURIComponent(n.customerName)}`;const o=i[n.unitType]||n.unitType||"غير محدد";d.innerHTML=`
                <div class="item-details">
                    <div class="item-customer-name">${n.customerName||"غير مسمى"}</div>
                    <div class="item-sub-details">
                        <span><strong>رقم الهاتف:</strong> ${n.customerPhone||"-"}</span>
                        <span><strong>نوع الوحدة:</strong> ${o}</span>
                        <span><strong>موقع الوحدة:</strong> ${n.unitLocation||"-"}</span>
                        <span><strong>المبلغ الإجمالي:</strong> ${t(n.totalAmount)}</span>
                    </div>
                </div>
                <div class="item-arrow">&lsaquo;</div>
            `,a.appendChild(d)})}
