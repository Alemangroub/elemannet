import{o as F,d as L,a as p,g as J,s as I,b as h,q as $,i as z,c as D,j as Q,u as T,f as W,h as G}from"./client.BqIP8IDN.js";document.addEventListener("DOMContentLoaded",()=>{const l=document.getElementById("auth-loading-message"),s=document.getElementById("admin-login-container"),o=document.getElementById("page-content");F(h,async r=>{if(l&&(l.style.display="none"),r)try{const u=L(p,"users",r.uid),m=await J(u);if(m.exists()&&m.data().role==="admin"){o&&(o.style.display="block"),s&&(s.style.display="none");const i=document.getElementById("logout-button");i&&i.addEventListener("click",async()=>{await I(h),window.location.href="/admin"}),K()}else await I(h),s&&(s.style.display="block"),o&&(o.style.display="none")}catch(u){console.error("Auth Check Error:",u),await I(h),s&&(s.style.display="block"),o&&(o.style.display="none")}else o&&(o.style.display="none"),s&&(s.style.display="block")})});function K(){const l=document.getElementById("projects-list"),s=document.getElementById("no-projects-message"),o=document.querySelector(".table-wrapper"),r=document.getElementById("edit-modal"),u=document.getElementById("edit-form"),m=document.getElementById("cancel-edit-btn"),i=document.getElementById("archive-modal"),H=document.getElementById("confirm-archive-btn"),q=document.getElementById("cancel-archive-btn"),B=document.getElementById("edit-project-name"),w=document.getElementById("edit-project-address"),c=document.getElementById("current-supervisors-list"),S=document.getElementById("add-supervisor-select"),C=document.getElementById("add-supervisor-btn");let v=null,f=null,y=[];async function N(){const e=$(D(p,"users"),W("role","==","supervisor"));y=(await G(e)).docs.map(t=>({id:t.id,name:t.data().name}))}const P=$(D(p,"projects"),z("createdAt","desc"));Q(P,e=>{const n=e.docs.filter(t=>!t.data().archived);o.style.display=n.length===0?"none":"",s.textContent=n.length===0?'لم تتم إضافة أي مشاريع بعد. انقر على زر "إضافة مشروع جديد" للبدء.':"",l&&(l.innerHTML=n.map(t=>{const d=t.data(),a=d.supervisors?d.supervisors.map(g=>g.name).join(", "):"-";return`
            <tr data-id="${t.id}" data-project='${JSON.stringify(d).replace(/'/g,"&apos;")}'>
              <td data-label="اسم المشروع" class="project-name-cell">${d.projectName||"-"}</td>
              <td data-label="العنوان">${d.projectAddress||"-"}</td>
              <td data-label="المشرفون">${a}</td>
              <td data-label="الإجراءات" class="btn-action-cell">
                <a href="/admin/project-installments?projectId=${t.id}" class="btn btn-installments-custom">الأقساط</a>
                <button class="btn btn-edit-custom">تعديل</button>
                <button class="btn btn-archive-custom">أرشفة</button>
              </td>
            </tr>
          `}).join(""))});function M(e){e.classList.add("visible"),document.body.style.overflow="hidden"}function A(e){e.classList.remove("visible"),document.body.style.overflow=""}l.addEventListener("click",e=>{const n=e.target.closest("tr");if(n)if(e.target.classList.contains("btn-edit-custom")){e.stopPropagation(),v=n.dataset.id;const t=JSON.parse(n.dataset.project.replace(/&apos;/g,"'"));O(t)}else if(e.target.classList.contains("btn-archive-custom"))e.stopPropagation(),f=n.dataset.id,M(i);else if(e.target.closest(".btn-installments-custom"))e.stopPropagation();else{const t=n.dataset.id;t&&(window.location.href=`/admin/projects/${t}`)}});function b(){A(i),f=null}q.addEventListener("click",b),i.addEventListener("click",e=>{e.target===i&&b()}),H.addEventListener("click",async()=>{if(f){try{const e=L(p,"projects",f);await T(e,{archived:!0}),window.location.href="/admin/archived-projects"}catch(e){console.error("Error archiving document: ",e),alert("حدث خطأ أثناء أرشفة المشروع.")}b()}});function O(e){B.value=e.projectName||"",w.value=e.projectAddress||"",c.innerHTML="",(e.supervisors||[]).forEach(n=>{c.insertAdjacentHTML("beforeend",k(n.id,n.name))}),j(),M(r)}function k(e,n){return`<div class="supervisor-item" data-id="${e}">
                  <span>${n}</span>
                  <button type="button" class="btn-delete-supervisor">حذف</button>
                </div>`}function j(){const e=Array.from(c.children).map(t=>t.dataset.id),n=y.filter(t=>!e.includes(t.id));S.innerHTML='<option value="">اختر مشرفًا...</option>'+n.map(t=>`<option value="${t.id}">${t.name}</option>`).join("")}C.addEventListener("click",()=>{const e=S.value;if(!e)return;const n=y.find(t=>t.id===e);n&&(c.insertAdjacentHTML("beforeend",k(n.id,n.name)),j())}),c.addEventListener("click",e=>{e.target.classList.contains("btn-delete-supervisor")&&(e.target.closest(".supervisor-item").remove(),j())});function E(){A(r),v=null,u.reset(),c.innerHTML=""}m.addEventListener("click",E),r.addEventListener("click",e=>{e.target===r&&E()}),u.addEventListener("submit",async e=>{if(e.preventDefault(),!v)return;const t=Array.from(c.children).map(a=>{const g=a.dataset.id,R=y.find(x=>x.id===g).name;return{id:g,name:R}}),d={projectName:B.value,projectAddress:w.value,supervisors:t,supervisorIds:t.map(a=>a.id)};try{const a=L(p,"projects",v);await T(a,d)}catch(a){console.error("Error updating project: ",a),alert("Failed to save changes.")}E()}),N()}
