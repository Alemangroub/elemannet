const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["_astro/jspdf.es.min.C-wzL9VK.js","_astro/preload-helper.BlTxHScW.js"])))=>i.map(i=>d[i]);
import{_ as q}from"./preload-helper.BlTxHScW.js";import{o as z,g as R,d as T,a as P,s as H,b as F,T as _,c as N,u as J,j as V,i as W,q as Q,e as U,h as K}from"./client.Ch7ienT3.js";import{utils as X,writeFile as Y}from"./xlsx.DGuHH-KN.js";const B=document.getElementById("page-content"),x=B.dataset.projectId,O=B.dataset.projectName;let S=null,L=[];const $=["حديد","اسمنت","رمله","زلط","طوب","كهرباء","سباكة","رخام","دهانات"];document.addEventListener("DOMContentLoaded",()=>{const o=document.getElementById("auth-loading-message"),e=document.getElementById("admin-login-container");z(F,async t=>{if(o.style.display="none",t){const n=await R(T(P,"users",t.uid));n.exists()&&n.data().role==="admin"?(B.style.display="block",e.style.display="none",Z()):(H(F),B.style.display="none",e.style.display="block")}else B.style.display="none",e.style.display="block"})});function Z(){x&&(ee(),oe())}const j=document.getElementById("add-import-btn"),E=document.getElementById("import-modal"),b=document.getElementById("delete-modal"),G=document.getElementById("cancel-import-btn"),v=document.getElementById("import-form"),A=document.getElementById("modal-title"),C=document.getElementById("imports-list");let w=null;function k(o){o.classList.add("visible")}function h(o){o.classList.remove("visible")}function ee(){const o=document.getElementById("item-category"),e=document.getElementById("other-item-name-group"),t=document.getElementById("item-name"),n=document.getElementById("item-quantity"),i=document.getElementById("item-unit-price"),a=document.getElementById("item-price");function m(){const l=parseFloat(n.value)||0,s=parseFloat(i.value)||0;a.value=(l*s).toFixed(2)}n&&n.addEventListener("input",m),i&&i.addEventListener("input",m),o&&o.addEventListener("change",()=>{o.value==="اخري"?(e.style.display="block",t.required=!0):(e.style.display="none",t.required=!1)}),j&&j.addEventListener("click",()=>{S=null,A.textContent="إضافة وارد جديد",v.reset(),e.style.display="none",t.required=!1,a.value="",document.getElementById("import-date").valueAsDate=new Date,k(E)}),G&&G.addEventListener("click",()=>h(E)),E&&E.addEventListener("click",l=>{l.target===E&&h(E)}),v&&v.addEventListener("submit",async l=>{l.preventDefault();const s=document.getElementById("item-category").value;let u=s;s==="اخري"&&(u=document.getElementById("item-name").value);const g={name:u,quantity:parseFloat(n.value),unitPrice:parseFloat(i.value),price:parseFloat(a.value),supplier:document.getElementById("item-supplier").value,date:_.fromDate(new Date(document.getElementById("import-date").value)),notes:document.getElementById("item-notes").value},c=N(P,"projects",x,"imports");S?await J(T(c,S),g):await V(c,{...g,createdAt:_.now()}),h(E),v.reset()}),C&&C.addEventListener("click",l=>{const s=l.target.closest("button");if(!s)return;const u=s.closest("tr"),g=u.dataset.id;if(s.classList.contains("btn-edit-custom")){const c=JSON.parse(u.dataset.import);ae(g,c)}s.classList.contains("btn-delete-custom")&&(w=g,k(b))});const f=document.getElementById("cancel-delete-btn"),p=document.getElementById("confirm-delete-btn");f&&f.addEventListener("click",()=>h(b)),b&&b.addEventListener("click",l=>{l.target===b&&h(b)}),p&&p.addEventListener("click",async()=>{if(w){const l=T(P,"projects",x,"imports",w);await W(l),h(b),w=null}});const I=document.getElementById("category-filter");I&&I.addEventListener("change",M);const d=document.getElementById("print-btn");d&&d.addEventListener("click",()=>window.print());const r=document.getElementById("export-pdf-btn");r&&r.addEventListener("click",te);const y=document.getElementById("export-excel-btn");y&&y.addEventListener("click",()=>{const l=document.getElementById("imports-table"),s=X.table_to_book(l,{sheet:"Sheet JS"});Y(s,`project-imports-${O}.xlsx`)})}async function te(o){const e=o.currentTarget;e.disabled=!0,e.textContent="جارٍ التصدير...";try{const{default:t}=await q(async()=>{const{default:c}=await import("./html2canvas.esm.B0tyYwQk.js");return{default:c}},[]),{jsPDF:n}=await q(async()=>{const{jsPDF:c}=await import("./jspdf.es.min.C-wzL9VK.js").then(D=>D.j);return{jsPDF:c}},__vite__mapDeps([0,1])),i=document.getElementById("imports-table");if(!i||i.style.display==="none"){alert("لا يوجد جدول لعرضه أو تصديره. يرجى اختيار فلتر لعرض البيانات أولاً.");return}const a=document.createElement("div");a.style.direction="rtl",a.style.padding="20px",a.style.backgroundColor="white",a.style.width="800px";const m=document.createElement("h1");m.textContent=document.querySelector(".page-header h1").textContent,m.style.textAlign="center",a.appendChild(m);const f=document.createElement("p");f.textContent=`فلترة حسب: ${document.getElementById("category-filter").selectedOptions[0].text}`,f.style.textAlign="center",a.appendChild(f);const p=i.cloneNode(!0);p.querySelectorAll(".actions-header, .btn-action-cell").forEach(c=>c.remove()),a.appendChild(p),document.body.appendChild(a);const I=await t(a,{scale:2,useCORS:!0,onclone:c=>{const D=c.createElement("style");D.innerHTML=`
                        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
                        body, div, table { font-family: 'Cairo', sans-serif !important; direction: rtl; }
                        h1 { font-size: 1.5rem; text-align: center; color: #333; margin-bottom: 0.5rem; }
                        p { font-size: 1rem; text-align: center; color: #666; margin-bottom: 1.5rem; }
                        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
                        th, td { border: 1px solid #ddd; padding: 10px; text-align: right; font-size: 0.9rem; }
                        th { background-color: #f2f2f2; font-weight: 700; }
                    `,c.body.appendChild(D)}});document.body.removeChild(a);const d=I.toDataURL("image/png"),r=new n({orientation:"p",unit:"mm",format:"a4"}),y=r.internal.pageSize.getWidth(),l=r.getImageProperties(d),s=l.height*y/l.width;let u=s,g=0;for(r.addImage(d,"PNG",10,g,y-20,s),u-=r.internal.pageSize.getHeight();u>=0;)g=u-s,r.addPage(),r.addImage(d,"PNG",10,g,y-20,s),u-=r.internal.pageSize.getHeight();r.save(`واردات - ${O}.pdf`)}catch(t){console.error("PDF Export Error:",t),alert("فشل تصدير PDF. يرجى المحاولة مرة أخرى.")}finally{e.disabled=!1,e.textContent="تصدير PDF"}}function ne(){const o=document.getElementById("grand-total-amount");if(!o)return;const e=L.reduce((t,n)=>t+(n.price||0),0);o.textContent=e.toLocaleString("ar-EG",{style:"currency",currency:"EGP"})}function M(){const e=document.getElementById("category-filter").value,t=C.querySelectorAll("tr"),n=document.getElementById("no-imports-message"),i=document.querySelector(".table-wrapper"),a=document.getElementById("filtered-total-card"),m=document.getElementById("filtered-total-label"),f=document.getElementById("filtered-total-amount");if(e==="none"){i.style.display="none",n.textContent="يرجى اختيار صنف لعرض الواردات.",n.style.display="block",a.style.display="none",t.forEach(d=>{d.style.display="none"});return}let p=0,I=0;t.forEach(d=>{const r=JSON.parse(d.dataset.import),y=r.name;let l=!1;e==="all"?l=!0:e==="اخري"?$.includes(y)||(l=!0):y===e&&(l=!0),l?(d.style.display="",p++,I+=r.price||0):d.style.display="none"}),e==="all"||p===0?a.style.display="none":(m.textContent=`إجمالي ${e==="اخري"?"الأصناف الأخرى":e}`,f.textContent=I.toLocaleString("ar-EG",{style:"currency",currency:"EGP"}),a.style.display="block"),p===0&&L.length>0?(i.style.display="none",n.textContent="لا توجد واردات تطابق هذا الفلتر.",n.style.display="block"):L.length===0?(i.style.display="none",n.textContent="لم يتم إضافة أي واردات لهذا المشروع بعد.",n.style.display="block"):(i.style.display="",n.style.display="none")}function oe(){if(!x)return;const o=Q(N(P,"projects",x,"imports"),U("date","desc"));K(o,e=>{L=e.docs.map(t=>({id:t.id,...t.data()})),ne(),e.empty?C.innerHTML="":C.innerHTML=L.map(t=>le(t.id,t)).join(""),M()})}function le(o,e){const t=e.date.toDate(),n=t.getTimezoneOffset()*6e4,a=new Date(t.getTime()-n).toISOString().split("T")[0],m={...e,date:a,notes:e.notes||"",unitPrice:e.unitPrice||""};return`
            <tr data-id="${o}" data-import='${JSON.stringify(m)}'>
                <td data-label="الصنف">${e.name}</td>
                <td data-label="الكمية">${e.quantity}</td>
                <td data-label="سعر الوحدة">${(e.unitPrice||0).toLocaleString("ar-EG",{style:"currency",currency:"EGP"})}</td>
                <td data-label="السعر الإجمالي">${(e.price||0).toLocaleString("ar-EG",{style:"currency",currency:"EGP"})}</td>
                <td data-label="المورد">${e.supplier||"-"}</td>
                <td data-label="التاريخ">${t.toLocaleDateString("ar-EG")}</td>
                <td data-label="الإجراءات" class="btn-action-cell">
                    <button class="btn btn-edit-custom">تعديل</button>
                    <button class="btn btn-delete-custom">حذف</button>
                </td>
            </tr>
        `}function ae(o,e){S=o,A.textContent="تعديل وارد",v.reset();const t=document.getElementById("item-category"),n=document.getElementById("other-item-name-group"),i=document.getElementById("item-name");$.includes(e.name)?(t.value=e.name,n.style.display="none",i.required=!1):(t.value="اخري",n.style.display="block",i.value=e.name||"",i.required=!0),document.getElementById("item-quantity").value=e.quantity||"",document.getElementById("item-unit-price").value=e.unitPrice||"",document.getElementById("item-price").value=e.price||"",document.getElementById("item-supplier").value=e.supplier||"",document.getElementById("import-date").value=e.date||"",document.getElementById("item-notes").value=e.notes||"",k(E)}
