const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["_astro/jspdf.es.min.C-wzL9VK.js","_astro/preload-helper.BlTxHScW.js"])))=>i.map(i=>d[i]);
import{_ as V}from"./preload-helper.BlTxHScW.js";import{o as ge,d as ne,a as z,g as he,s as ae,b as G,c as Ee,j as be,T as ve,i as Ce}from"./client.Ch7ienT3.js";document.addEventListener("DOMContentLoaded",()=>{const W=document.getElementById("auth-loading-message"),f=document.getElementById("admin-login-container"),p=document.getElementById("page-content");ge(G,async L=>{if(W&&(W.style.display="none"),!L){p&&(p.style.display="none"),f&&(f.style.display="block");return}try{const y=ne(z,"users",L.uid),r=await he(y);r.exists()&&r.data().role==="admin"?(p&&(p.style.display="block"),f&&(f.style.display="none"),oe()):(await ae(G),window.location.href="/admin")}catch(y){console.error("Auth Check Error:",y),f&&(f.style.display="block"),p&&(p.style.display="none")}});function oe(){const L=document.getElementById("logout-button");L&&L.addEventListener("click",async()=>{await ae(G),window.location.href="/admin"});const y=document.getElementById("add-item-form");y&&y.addEventListener("submit",async e=>{e.preventDefault();const n=y.querySelector('button[type="submit"]');n.disabled=!0,n.textContent="جارٍ الحفظ...";try{const t=document.getElementById("page-content").dataset.projectId;if(!t)throw new Error("Project ID is not available.");const o=document.getElementById("name").value,a=document.getElementById("personName").value,i=parseFloat(document.getElementById("quantity").value),l=parseFloat(document.getElementById("unitPrice").value),s=document.getElementById("itemDate").value,c=document.getElementById("notes").value;if(!o||!a||isNaN(i)||isNaN(l)||!s)throw new Error("يرجى ملء جميع الحقول المطلوبة والتأكد من صحة البيانات.");const d=Ee(z,"projects",t,"items");await be(d,{name:o,personName:a,quantity:i,unitPrice:l,totalPrice:i*l,notes:c,createdAt:ve.fromDate(new Date(s))}),window.location.reload()}catch(t){console.error("Error adding item:",t);const o=document.getElementById("error-message-box");o&&(o.textContent=t.message,o.style.display="block"),n.disabled=!1,n.textContent="حفظ البند"}});const r=document.getElementById("delete-confirm-modal"),g=document.getElementById("delete-modal-confirm-btn"),X=document.getElementById("delete-modal-cancel-btn"),h=document.getElementById("save-confirm-modal"),E=document.getElementById("save-modal-confirm-btn"),J=document.getElementById("save-modal-cancel-btn");let P=null,S=null,b=null;const U=document.getElementById("items-table-body");U&&U.addEventListener("click",e=>{const n=e.target.closest(".btn-action");if(!n)return;const t=n.closest(".item-row");t&&(n.classList.contains("btn-delete")?ie(n):n.classList.contains("btn-edit")?le(t):n.classList.contains("btn-cancel")?N(t):n.classList.contains("btn-save")?se(t):n.classList.contains("btn-print")?ce(t):n.classList.contains("btn-pdf")?de(t,n):n.classList.contains("btn-excel")&&re(t,n))});function ie(e){P={projectId:e.dataset.projectId,itemId:e.dataset.itemId},r&&(r.style.display="flex")}function le(e){b&&b!==e&&N(b),b=e,j(e,!0)}function N(e){j(e,!1),b=null}function se(e){S=e,h&&(h.style.display="flex")}function K(e,n){const t=document.querySelector("h1").textContent||"تفاصيل البند",o=e.querySelectorAll("td[data-label]");let a=`
                    <h1>${t}</h1>
                    <h2>${n}</h2>
                    <table>
                        <tbody>`;return o.forEach(i=>{const l=i.getAttribute("data-label");if(l==="إجراءات")return;const s=i.dataset.originalValue||i.textContent.trim();a+=`<tr><th>${l}</th><td>${s}</td></tr>`}),a+="</tbody></table>",a}function ce(e){const n=K(e,"تفاصيل البند"),t=window.open("","","height=700,width=800");if(!t){alert("فشل فتح نافذة الطباعة. يرجى التأكد من السماح بالنوافذ المنبثقة (Pop-ups) لهذا الموقع.");return}t.document.write(`<style>
                        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
                        body { font-family: 'Cairo', sans-serif; direction: rtl; margin: 20px; }
                        h1, h2 { text-align: center; color: #333; }
                        h1 { font-size: 1.5rem; }
                        h2 { font-size: 1.2rem; color: #555; margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                        tr { border-bottom: 1px solid #eee; }
                        th, td { padding: 12px 15px; text-align: right; }
                        th { background-color: #f8f8f8; font-weight: 700; color: #555; width: 30%; }
                        @media print { body { -webkit-print-color-adjust: exact; } h1 {color: #000;} }
                    </style>`+n),t.document.close(),t.focus(),setTimeout(()=>{t.print()},500)}async function de(e,n){n.disabled=!0,n.textContent="جارٍ...";try{const{default:t}=await V(async()=>{const{default:w}=await import("./html2canvas.esm.B0tyYwQk.js");return{default:w}},[]),{jsPDF:o}=await V(async()=>{const{jsPDF:w}=await import("./jspdf.es.min.C-wzL9VK.js").then(A=>A.j);return{jsPDF:w}},__vite__mapDeps([0,1])),a=document.createElement("div");a.innerHTML=K(e,"تفاصيل البند"),a.style.fontFamily="'Cairo', sans-serif",a.style.direction="rtl",document.body.appendChild(a);const i=await t(a,{scale:2,useCORS:!0,onclone:w=>{const A=w.createElement("style");A.innerHTML=`
                            @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
                            body, div { font-family: 'Cairo', sans-serif !important; direction: rtl;}
                            table { width: 100%; border-collapse: collapse; } h1, h2 { text-align: center; } h1{font-size: 1.2em;} h2{font-size: 1em;}
                            tr { border-bottom: 1px solid #ddd; } th, td { padding: 8px; text-align: right; }
                            th { background-color: #f2f2f2; width: 30%; }`,w.body.appendChild(A)}}),l=i.toDataURL("image/png"),s=new o({orientation:"p",unit:"mm",format:"a4"}),c=s.internal.pageSize.getWidth(),d=i.width,u=i.height,B=d/u,fe=c/B;s.addImage(l,"PNG",10,10,c-20,fe-10);const pe=e.querySelector('td[data-field="name"]').textContent.trim();s.save(`item-${pe}.pdf`),document.body.removeChild(a)}catch(t){console.error("PDF Export Error:",t),alert("فشل تصدير PDF. يرجى المحاولة مرة أخرى.")}finally{n.disabled=!1,n.textContent="تصدير PDF"}}async function re(e,n){n.disabled=!0,n.textContent="جارٍ...";try{const t=await V(()=>import("./xlsx.DGuHH-KN.js"),[]),o=[],a=[];e.querySelectorAll("td[data-label]").forEach(d=>{const u=d.getAttribute("data-label");u!=="إجراءات"&&(a.push(u),o.push(d.textContent.trim()))});const i=[a,o],l=t.utils.aoa_to_sheet(i),s=t.utils.book_new();t.utils.book_append_sheet(s,l,"Item Details");const c=e.querySelector('td[data-field="name"]').textContent.trim();t.writeFile(s,`item-${c}.xlsx`)}catch(t){console.error("Excel Export Error:",t),alert("فشل تصدير Excel. يرجى المحاولة مرة أخرى.")}finally{n.disabled=!1,n.textContent="تصدير Excel"}}async function ue(e){const n=e.dataset.itemId,t=e.dataset.projectId,o={};if(e.querySelectorAll("input, select").forEach(a=>{o[a.name]=a.value}),!o.name||!o.personName||!o.quantity||!o.unitPrice||!o.createdAt){alert("يرجى ملء جميع الحقول المطلوبة.");return}try{const a=await fetch("/api/updateItem",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:t,itemId:n,...o})}),i=await a.json();if(!a.ok)throw new Error(i.error||"فشل تحديث البند.");e.querySelectorAll("td[data-field]").forEach(l=>{const s=l.dataset.field;let c=i.data[s];(s==="unitPrice"||s==="totalPrice")&&(c=parseFloat(c).toFixed(2)),l.textContent=c,l.dataset.originalValue=c}),e.dataset.itemName=i.data.name,j(e,!1),b=null}catch(a){console.error("Save Error:",a),alert(`خطأ: ${a.message}`),N(e)}}function j(e,n){const t=e.querySelector(".action-buttons-view"),o=e.querySelector(".action-buttons-edit");if(n){t.style.display="none",o.style.display="flex",e.classList.add("editing"),e.querySelectorAll("td[data-field]").forEach(c=>{const d=c.dataset.field,u=c.textContent.trim();c.dataset.originalValue=u;let B;switch(d){case"createdAt":B=`<input type="date" name="createdAt" value="${u}" class="form-control-inline">`;break;case"quantity":case"unitPrice":B=`<input type="number" name="${d}" value="${u}" step="0.01" class="form-control-inline">`;break;case"name":case"personName":case"notes":B=`<input type="text" name="${d}" value="${u}" class="form-control-inline">`;break;case"totalPrice":return;default:return}c.innerHTML=B});const a=e.querySelector('input[name="quantity"]'),i=e.querySelector('input[name="unitPrice"]'),l=e.querySelector('td[data-field="totalPrice"]'),s=()=>{const c=parseFloat(a.value)||0,d=parseFloat(i.value)||0;l.textContent=(c*d).toFixed(2)};a&&i&&(a.addEventListener("input",s),i.addEventListener("input",s))}else t.style.display="flex",o.style.display="none",e.classList.remove("editing"),e.querySelectorAll("td[data-field]").forEach(a=>{a.querySelector("input, select")&&(a.textContent=a.dataset.originalValue)})}X&&X.addEventListener("click",()=>{r&&(r.style.display="none"),P=null}),g&&g.addEventListener("click",async()=>{if(!P)return;const{projectId:e,itemId:n}=P,t=document.getElementById(`item-row-${n}`);g.disabled=!0,g.textContent="جاري الحذف...";try{const o=ne(z,"projects",e,"items",n);await Ce(o),t&&t.remove()}catch(o){console.error("Error deleting item: ",o),alert("حدث خطأ أثناء محاولة الحذف. يرجى المحاولة مرة أخرى.")}finally{r&&(r.style.display="none"),P=null,g.disabled=!1,g.textContent="تأكيد الحذف"}}),J&&J.addEventListener("click",()=>{h&&(h.style.display="none"),S=null}),E&&E.addEventListener("click",async()=>{S&&(E.disabled=!0,E.textContent="جاري الحفظ...",await ue(S),h&&(h.style.display="none"),S=null,E.disabled=!1,E.textContent="تأكيد الحفظ")});const Q=document.getElementById("itemDate");Q&&(Q.value=new Date().toLocaleDateString("en-CA"));const k=document.getElementById("toggle-form-btn"),Y=document.getElementById("cancel-btn"),q=document.getElementById("add-item-form-container");k&&q&&k.addEventListener("click",()=>{const e=q.style.display==="none";q.style.display=e?"block":"none",k.textContent=e?"- إلغاء الإضافة":"+ إضافة بند جديد"}),Y&&q&&k&&Y.addEventListener("click",()=>{q.style.display="none",k.textContent="+ إضافة بند جديد"});const v={"بند العماله":["بند المصروف اليومي","بند اجرة العمال"],"بند المقاول":["بند لبشه عاديه","بند لبشه مسلحه"],"بند الخرسانه":["الاسمنت","الحديد","الزلط","الرمله","المقاول"],"بند المباني":["رمله","اسمنت","طوب","تشوين","اجرة مباني"],"بند الكهرباء":["بند الاساسيات","بند اجرة التركيب"],"بند السباكه":["بند الاساسيات","بند اجرة التركيب"],"بند المحاره":["الاسمنت","الرمله","اجرة عمال","تشوين"],"بند الرخام":["تمن الرخام","تمن التركيب"],"بند الدهانات":["مونه","اجره"],"بند تشطيبات الكهرباء":["مونه","اجره"],"بند المجلس":["مصروف الرخصه","التصالح","المحاضر"],"بند الحفر":["اجرة العمال","المعدات"],"بند الهدم":["اجرة عمال","المعدات"]},M=document.getElementById("main-category"),me=document.getElementById("sub-category-group"),F=document.getElementById("sub-category"),Z=document.getElementById("other-name-group"),_=document.getElementById("other-name"),$=document.getElementById("name");function T(){const e=M.value;e==="اخرى"?$.value=_.value:v[e]?$.value=F.value:$.value=e}M.addEventListener("change",()=>{const e=M.value;F.innerHTML="",Z.style.display="none",_.required=!1,v[e]?(v[e].forEach(n=>{const t=document.createElement("option");t.value=n,t.textContent=n,F.appendChild(t)}),me.style.display="block"):e==="اخرى"&&(Z.style.display="block",_.required=!0),T()}),F.addEventListener("change",T),_.addEventListener("input",T),T();const R=document.getElementById("quantity"),O=document.getElementById("unitPrice"),ye=document.getElementById("totalPrice");function ee(){const e=parseFloat(R.value)||0,n=parseFloat(O.value)||0;ye.value=(e*n).toFixed(2)}R&&O&&(R.addEventListener("input",ee),O.addEventListener("input",ee));const D=document.getElementById("main-category-filter"),C=document.getElementById("sub-category-filter-group"),m=document.getElementById("sub-category-filter"),I=document.getElementById("table-container"),x=document.getElementById("initial-message"),te=document.getElementById("filtered-total");function H(){const e=document.querySelectorAll("#items-table-body .item-row");let n=0;e.forEach(t=>{if(t.style.display!=="none"){const o=parseFloat(t.dataset.totalPrice)||0;n+=o}}),te&&(te.textContent=`${n.toFixed(2)} ج.م`)}if(D){const e=Array.from(document.querySelectorAll(".item-row"));Object.keys(v).forEach(t=>{const o=document.createElement("option");o.value=t,o.textContent=t,D.appendChild(o)}),D.addEventListener("change",()=>{const t=D.value;if(!t||t==="all"){C&&(C.style.display="none"),I&&(I.style.display=t==="all"?"block":"none"),x&&(x.style.display=t==="all"?"none":"block"),e.forEach(a=>a.style.display=""),H();return}const o=v[t];if(o&&o.length>0){if(m){m.innerHTML="";const a=document.createElement("option");a.value="all-subs",a.textContent=`جميع بنود ${t}`,m.appendChild(a),o.forEach(i=>{const l=document.createElement("option");l.value=i,l.textContent=i,m.appendChild(l)}),C&&(C.style.display="block"),m.dispatchEvent(new Event("change"))}}else C&&(C.style.display="none"),I&&(I.style.display="block"),x&&(x.style.display="none"),e.forEach(a=>{a.style.display=a.dataset.itemName===t?"":"none"}),H()}),m&&m.addEventListener("change",()=>{const t=D.value,o=m.value,a=v[t]||[];I&&(I.style.display="block"),x&&(x.style.display="none"),e.forEach(i=>{const l=i.dataset.itemName;let s=!1;o==="all-subs"?a.includes(l)&&(s=!0):l===o&&(s=!0),i.style.display=s?"":"none"}),H()})}}});
