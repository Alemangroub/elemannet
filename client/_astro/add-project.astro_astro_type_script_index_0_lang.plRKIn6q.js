import{o as E,d as L,a as g,g as w,s as f,b as y,j as B,c as b,q as D,f as C,k as I}from"./client.Ch7ienT3.js";document.addEventListener("DOMContentLoaded",()=>{const c=document.getElementById("auth-loading-message"),n=document.getElementById("admin-login-container"),t=document.getElementById("page-content");E(y,async s=>{if(c&&(c.style.display="none"),s)try{const i=L(g,"users",s.uid),p=await w(i);if(p.exists()&&p.data().role==="admin"){t&&(t.style.display="block"),n&&(n.style.display="none");const m=document.getElementById("logout-button");m&&m.addEventListener("click",async()=>{await f(y),window.location.href="/admin"}),S()}else await f(y),n&&(n.style.display="block"),t&&(t.style.display="none")}catch(i){console.error("Auth Check Error:",i),await f(y),n&&(n.style.display="block"),t&&(t.style.display="none")}else t&&(t.style.display="none"),n&&(n.style.display="block")})});function S(){const c=document.getElementById("add-project-form"),n=document.getElementById("add-person-btn"),t=document.getElementById("additional-persons-container"),s=document.getElementById("submit-btn");let i=[];function p(){const e=document.createElement("select");e.name="personName",e.className="supervisor-select",e.required=!0;let o='<option value="" disabled selected>اختر مشرفًا</option>';return i.forEach(a=>{o+=`<option value="${a.id}">${a.name}</option>`}),e.innerHTML=o,e}async function m(){const e=document.querySelectorAll(".supervisor-select");try{const o=D(b(g,"users"),C("role","==","supervisor"));i=(await I(o)).docs.map(r=>({id:r.id,name:r.data().name}));let d='<option value="" disabled selected>اختر مشرفًا</option>';i.forEach(r=>{d+=`<option value="${r.id}">${r.name}</option>`}),e.forEach(r=>{r.innerHTML=d})}catch(o){console.error("Error fetching supervisors: ",o),e.forEach(a=>{a.innerHTML='<option value="" disabled selected>خطأ في تحميل المشرفين</option>'})}}n.addEventListener("click",()=>{const e=document.createElement("div");e.className="person-group dynamic";const o=p();e.innerHTML=`
          <div class="form-group">
              <label>اسم المشرف الإضافي</label>
              ${o.outerHTML}
          </div>
          <div class="remove-btn-container">
            <button type="button" class="btn-remove">إزالة</button>
          </div>
      `,t.appendChild(e)}),t.addEventListener("click",e=>{e.target.classList.contains("btn-remove")&&e.target.closest(".person-group.dynamic").remove()}),c.addEventListener("submit",async e=>{e.preventDefault(),s.disabled=!0,s.textContent="جارٍ الحفظ...";const o=c.querySelectorAll(".person-group"),a=[];o.forEach(l=>{const u=l.querySelector('select[name="personName"]');if(u&&u.value){const v=u.options[u.selectedIndex];a.push({id:v.value,name:v.textContent})}});const d=a.map(l=>l.id);if(d.some((l,u)=>d.indexOf(l)!==u)){alert("لا يمكن تعيين نفس المشرف مرتين للمشروع."),s.disabled=!1,s.textContent="حفظ المشروع";return}const h={projectName:c.projectName.value,projectAddress:c.projectAddress.value,supervisors:a,supervisorIds:d,createdAt:new Date};try{await B(b(g,"projects"),h),window.location.href="/admin/projects"}catch(l){console.error("Error adding document: ",l),alert("حدث خطأ أثناء حفظ المشروع. يرجى المحاولة مرة أخرى."),s.disabled=!1,s.textContent="حفظ المشروع"}}),m()}
