import{l as k,m as A,o as D,d as B,g as L,s as E,b as f,n as x,p as M,r as $,t as T,v as z,x as V,q as H,e as S,c as N,h as O}from"./client.Ch7ienT3.js";const w=k(A);document.addEventListener("DOMContentLoaded",()=>{const l=document.getElementById("auth-loading-message"),t=document.getElementById("admin-login-container"),s=document.getElementById("page-content");D(f,async e=>{if(l&&(l.style.display="none"),e)try{const i=B(w,"users",e.uid),c=await L(i),u=c.data();if(e.role=u?.role,c.exists()&&u.role==="admin"){s&&(s.style.display="block"),t&&(t.style.display="none");const d=document.getElementById("logout-button");d&&d.addEventListener("click",async()=>{await E(f),window.location.href="/admin"}),P(e)}else await E(f),t&&(t.style.display="block"),s&&(s.style.display="none")}catch(i){console.error("Auth Check Error:",i),await E(f),t&&(t.style.display="block"),s&&(s.style.display="none")}else s&&(s.style.display="none"),t&&(t.style.display="block")})});function P(l){const t=document.getElementById("add-user-form"),s=document.getElementById("add-user-btn"),e=document.getElementById("add-user-feedback"),i=document.getElementById("users-list"),c=document.getElementById("no-users-message"),u=document.getElementById("delete-confirm-modal"),d=document.getElementById("modal-confirm-btn"),C=document.getElementById("modal-cancel-btn");let g=null;t.addEventListener("submit",async a=>{a.preventDefault(),s.disabled=!0,e.textContent="جاري إنشاء الحساب وتخزين البيانات...",e.className="feedback-message";const n=document.getElementById("user-name").value,o=document.getElementById("user-email").value,r=document.getElementById("user-password").value,h=document.getElementById("user-role").value,v=`secondary-app-${Date.now()}`,m=x(M,v),b=$(m);try{const y=(await T(b,o,r)).user.uid;await z(B(w,"users",y),{uid:y,name:n,email:o,role:h,createdAt:new Date}),e.textContent="تم إنشاء حساب المستخدم بنجاح!",e.classList.add("success"),t.reset()}catch(p){console.error("Error creating user:",p);let y="فشل إنشاء المستخدم.";p.code==="auth/email-already-in-use"?y="هذا البريد الإلكتروني مستخدم بالفعل.":p.code==="auth/weak-password"&&(y="كلمة السر ضعيفة جدًا."),e.textContent=y,e.classList.add("error")}finally{s.disabled=!1,await V(m),setTimeout(()=>{e.textContent=""},5e3)}});const I=H(N(w,"users"),S("createdAt","desc"));O(I,a=>{const n=a.docs.filter(o=>l&&o.id!==l.uid);n.length===0?(c.textContent="لا يوجد مستخدمون حاليًا.",c.style.display="block",i.innerHTML=""):(c.style.display="none",i.innerHTML=n.map(o=>{const r=o.data(),h=r.name?r.name.charAt(0).toUpperCase():"?",v=r.createdAt?.toDate?r.createdAt.toDate().toLocaleDateString("ar-EG"):"غير معروف",m=r.role||"N/A",b=m==="admin"?"مسؤول":m==="supervisor"?"مشرف":"غير محدد";return`
            <div class="user-card" data-id="${r.uid}">
              <div class="user-card-header">
                <div class="user-avatar">${h}</div>
                <div class="user-info"><h3 class="user-name">${r.name}</h3><p class="user-email">${r.email}</p></div>
              </div>
              <div class="user-card-body">
                <p>تاريخ الإنشاء: <strong>${v}</strong></p>
                <p>الصلاحية: <span class="role-badge ${m}">${b}</span></p>
              </div>
              <div class="user-card-footer">
                <button class="btn btn-danger delete-btn">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/></svg>
                  <span>حذف</span>
                </button>
              </div>
            </div>`}).join(""))}),i.addEventListener("click",a=>{const n=a.target.closest(".delete-btn");n&&(g=n.closest(".user-card").dataset.id,u.style.display="flex")}),C.addEventListener("click",()=>{u.style.display="none",g=null}),d.addEventListener("click",async()=>{if(!(!g||!l)){d.disabled=!0,d.textContent="جاري الحذف...";try{const a=await l.getIdToken(!0),n=await fetch("/api/delete-user",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({uid:g})}),o=await n.json();n.ok?alert("تم حذف المستخدم بنجاح!"):(console.error("Error deleting user:",o.error),alert(`فشل حذف المستخدم: ${o.error}`))}catch(a){console.error("API call failed: ",a),alert(`حدث خطأ أثناء الاتصال بالخادم: ${a.message}`)}finally{u.style.display="none",d.disabled=!1,d.textContent="تأكيد الحذف",g=null}}})}
