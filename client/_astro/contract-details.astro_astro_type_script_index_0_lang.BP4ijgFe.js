const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["_astro/jspdf.es.min.C-wzL9VK.js","_astro/preload-helper.BlTxHScW.js"])))=>i.map(i=>d[i]);
import{_ as x}from"./preload-helper.BlTxHScW.js";import{o as P,d as y,a as r,g as T,s as v,b as D,q as _,c as L,f as A,h as k,w as I,T as B,u as M}from"./client.BqIP8IDN.js";let g=null,w=null,d=[];document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("installments-table");e&&(e.addEventListener("click",o=>{const l=o.target.closest("button");l&&(l.classList.contains("btn-edit")||l.classList.contains("btn-save")?O(l):l.classList.contains("btn-partial")?q(l):l.classList.contains("btn-delete-installment")&&j(l))}),e.addEventListener("change",o=>{o.target&&o.target.classList.contains("status-select")&&F(o.target)}));const a=document.getElementById("delete-contract-btn");a&&a.addEventListener("click",G),document.getElementById("print-btn").addEventListener("click",()=>window.print()),document.getElementById("export-pdf-btn").addEventListener("click",R),document.getElementById("export-excel-btn").addEventListener("click",N);const n=document.getElementById("auth-loading-message"),t=document.getElementById("admin-login-container"),s=document.getElementById("page-content");P(D,async o=>{if(n&&(n.style.display="none"),o)try{const l=y(r,"users",o.uid),i=await T(l);i.exists()&&i.data().role==="admin"?(s&&(s.style.display="block"),t&&(t.style.display="none"),E()):(await v(D),t&&(t.style.display="block"),s&&(s.style.display="none"))}catch(l){console.error("Auth Check Error:",l),await v(D),t&&(t.style.display="block"),s&&(s.style.display="none")}else s&&(s.style.display="none"),t&&(t.style.display="block")})});async function E(){const e=document.getElementById("loader"),a=document.getElementById("contract-details-content"),n=document.getElementById("error-display"),t=document.getElementById("error-message"),s=new URLSearchParams(window.location.search);if(g=s.get("projectId"),w=s.get("customerName"),document.getElementById("back-link").href=`/admin/project-installments?projectId=${g}`,document.getElementById("edit-contract-btn").href=`/admin/edit-contract?projectId=${g}&customerName=${encodeURIComponent(w)}`,!g||!w){e.style.display="none",t.textContent="بيانات المشروع أو العميل غير متوفرة.",n.style.display="block";return}e.style.display="block",a.style.display="none";try{const o=_(L(r,"installments"),A("projectId","==",g),A("customerName","==",w)),l=await k(o);if(l.empty){e.style.display="none",t.textContent="لم يتم العثور على أقساط لهذا العقد. قد يكون تم حذفه بالكامل.",n.style.display="block",document.getElementById("delete-contract-btn").style.display="none",document.getElementById("edit-contract-btn").style.display="none";return}d=l.docs.map(i=>({id:i.id,...i.data()})),d.sort((i,c)=>i.dueDate.toDate()-c.dueDate.toDate()),W(d[0]),X(d),z(d,d[0].totalAmount),e.style.display="none",a.style.display="block"}catch(o){console.error("Error fetching details: ",o),e.style.display="none",t.textContent="حدث خطأ أثناء تحميل التفاصيل.",n.style.display="block"}}async function R(){const{jsPDF:e}=await x(async()=>{const{jsPDF:o}=await import("./jspdf.es.min.C-wzL9VK.js").then(l=>l.j);return{jsPDF:o}},__vite__mapDeps([0,1])),{default:a}=await x(async()=>{const{default:o}=await import("./html2canvas.esm.B0tyYwQk.js");return{default:o}},[]),n=document.getElementById("contract-details-content"),t=document.getElementById("info-customer-name").textContent||"contract",s=document.getElementById("export-pdf-btn");s.disabled=!0,s.textContent="جارٍ التصدير...";try{const o=await a(n,{scale:2,useCORS:!0,onclone:b=>{b.querySelectorAll(".actions-cell").forEach(S=>S.style.display="none");const $=b.querySelector("#installments-table th:last-child");$&&($.style.display="none")}}),l=o.toDataURL("image/png"),i=new e({orientation:"p",unit:"mm",format:"a4"}),c=i.internal.pageSize.getWidth(),u=o.width,m=o.height,f=u/m,p=c/f;i.addImage(l,"PNG",0,0,c,p),i.save(`${t}-contract.pdf`)}catch(o){console.error("PDF Export Error:",o),alert("حدث خطأ أثناء تصدير ملف PDF.")}finally{s.disabled=!1,s.textContent="تصدير PDF"}}async function N(){const e=await x(()=>import("./xlsx.DGuHH-KN.js"),[]),a=document.getElementById("installments-table"),n=document.getElementById("info-customer-name").textContent,t=document.getElementById("export-excel-btn");t.disabled=!0,t.textContent="جارٍ التصدير...";try{const s=e.utils.table_to_book(a,{sheet:"Installments"});e.writeFile(s,`installments-${n}.xlsx`)}catch(s){console.error("Excel Export Error:",s),alert("حدث خطأ أثناء تصدير ملف Excel.")}finally{t.disabled=!1,t.textContent="تصدير Excel"}}async function j(e){const a=e.dataset.id;if(!a)return;if(d.length<=1){alert('لا يمكن حذف القسط الأخير. لحذف العقد، استخدم زر "حذف العقد" الأحمر في أعلى الصفحة.');return}if(await window.showConfirmationModal("هل أنت متأكد من حذف هذا القسط؟ لا يمكن التراجع عن هذا الإجراء."))try{e.disabled=!0;const t=d.find(c=>c.id===a);if(!t)throw new Error("Installment not found");const s=t.installmentAmount,o=t.totalAmount-s,l=I(r),i=y(r,"installments",a);l.delete(i),d.forEach(c=>{if(c.id!==a){const u=y(r,"installments",c.id);l.update(u,{totalAmount:o})}}),await l.commit(),E()}catch(t){console.error("Error deleting installment: ",t),alert("حدث خطأ أثناء حذف القسط."),e.disabled=!1}}async function q(e){const a=e.dataset.id,n=d.find(s=>s.id===a);if(!n)return;const t=await window.showPartialPaymentModal(a,n.installmentAmount);if(t&&t>0&&t<n.installmentAmount){const s=n.installmentAmount-t,o=`سيتم تقسيم القسط إلى: 
- قسط مدفوع بقيمة: ${h(t)} 
- قسط جديد مستحق بقيمة: ${h(s)}. هل أنت متأكد؟`;if(await window.showConfirmationModal(o))try{const i=I(r),c=y(r,"installments",a);i.update(c,{installmentAmount:t,status:"paid",paymentDate:B.now()});const{id:u,...m}=n,f=y(L(r,"installments"));i.set(f,{...m,installmentAmount:s,installmentName:`بقية - ${n.installmentName||"القسط"}`,status:"pending",paymentDate:null}),await i.commit(),E()}catch(i){console.error("Error during partial payment: ",i),alert("حدث خطأ أثناء عملية السداد الجزئي.")}}}async function F(e){const a=e.dataset.id,n=e.value,t=e.dataset.currentStatus;if(n===t)return;const o=`هل أنت متأكد من تغيير حالة القسط إلى "${n==="paid"?"مدفوع":"مستحق"}"?`;if(await window.showConfirmationModal(o)){const i=y(r,"installments",a),c={status:n,paymentDate:n==="paid"?B.now():null};try{await M(i,c),E()}catch(u){console.error("Error updating status: ",u),e.value=t}}else e.value=t}function O(e){const a=e.closest("tr");a.classList.contains("is-editing")?V(a,e):H(a,e)}function H(e,a){e.classList.add("is-editing"),a.textContent="حفظ",a.classList.remove("btn-edit"),a.classList.add("btn-save");const n=e.querySelector('td[data-field="amount"]'),t=e.querySelector('td[data-field="dueDate"]'),s=n.dataset.originalValue,o=t.dataset.originalValue;n.innerHTML=`<input type="number" class="edit-input" value="${s}">`,t.innerHTML=`<input type="date" class="edit-input" value="${o}">`}async function V(e,a){const n=a.dataset.id,t=e.querySelector('td[data-field="amount"] input'),s=e.querySelector('td[data-field="dueDate"] input'),o=parseFloat(t.value),l=s.value;if(isNaN(o)||o<=0||!l){alert("الرجاء إدخال مبلغ وتاريخ صحيحين.");return}if(await window.showConfirmationModal("هل أنت متأكد من حفظ هذه التغييرات؟")){a.disabled=!0,a.textContent="جارٍ الحفظ...";try{const c=d.find(p=>p.id===n);if(!c)throw new Error("لم يتم العثور على القسط المراد تعديله.");const u=o-c.installmentAmount,m=c.totalAmount+u,f=I(r);d.forEach(p=>{const b=y(r,"installments",p.id);p.id===n?f.update(b,{installmentAmount:o,dueDate:B.fromDate(new Date(l)),totalAmount:m}):f.update(b,{totalAmount:m})}),await f.commit(),E()}catch(c){console.error("Error saving changes: ",c),alert(`فشل حفظ التغييرات: ${c.message}`),a.disabled=!1,a.textContent="حفظ"}}}async function G(){if(await window.showConfirmationModal("سيتم حذف العقد بالكامل بما في ذلك جميع الأقساط المرتبطة به. هل أنت متأكد من هذا الإجراء؟ لا يمكن التراجع عنه.")){const n=document.getElementById("delete-contract-btn");n.disabled=!0,n.textContent="جارٍ الحذف...";try{const t=I(r);d.forEach(s=>{const o=y(r,"installments",s.id);t.delete(o)}),await t.commit(),alert("تم حذف العقد بنجاح."),window.location.href=`/admin/project-installments?projectId=${g}`}catch(t){console.error("Error deleting contract: ",t),alert("حدث خطأ أثناء حذف العقد."),n.disabled=!1,n.textContent="حذف العقد"}}}const h=e=>(e||0).toLocaleString("ar-EG",{style:"currency",currency:"EGP"}),C=(e,a="long")=>{if(!e)return"-";const n=e.toDate();return a==="yyyy-mm-dd"?n.toISOString().split("T")[0]:n.toLocaleDateString("ar-EG",{year:"numeric",month:"long",day:"numeric"})},U={apartment:"شقة",shop:"محل",basement:"بدروم",other:"أخرى"};function W(e){document.getElementById("customer-name-header").textContent=`تفاصيل عقد: ${e.customerName}`,document.getElementById("info-customer-name").textContent=e.customerName||"-",document.getElementById("info-customer-phone").textContent=e.customerPhone||"-",document.getElementById("info-unit-type").textContent=U[e.unitType]||e.unitType||"-",document.getElementById("info-unit-location").textContent=e.unitLocation||"-"}function z(e,a){const n=e.filter(s=>s.status==="paid"&&s.installmentAmount).reduce((s,o)=>s+o.installmentAmount,0),t=a-n;document.getElementById("total-amount").textContent=h(a),document.getElementById("total-paid").textContent=h(n),document.getElementById("total-remaining").textContent=h(t)}function X(e){const a=document.querySelector("#installments-table tbody");if(a.innerHTML="",!e||e.length===0){document.getElementById("no-installments-message").style.display="block";return}const n={number:"م.",amount:"مبلغ القسط",dueDate:"تاريخ الاستحقاق",status:"الحالة",paymentDate:"تاريخ الدفع",name:"بيان القسط",actions:"إجراءات"};e.forEach((t,s)=>{const o=document.createElement("tr"),l=t.status==="paid";o.className=l?"status-paid":"status-pending";const i=`
                <select class="status-select" data-id="${t.id}" data-current-status="${t.status}">
                    <option value="pending" ${l?"":"selected"}>مستحق</option>
                    <option value="paid" ${l?"selected":""}>مدفوع</option>
                </select>
            `,c=t.installmentAmount||0,u=C(t.dueDate,"yyyy-mm-dd");let m="";l||(m+=`<button class="btn btn-partial btn-sm" data-id="${t.id}">سداد جزئي</button>`),m+=`<button class="btn btn-edit btn-sm" data-id="${t.id}">تعديل</button>`,m+=`<button class="btn btn-delete-installment btn-sm btn-danger" data-id="${t.id}">حذف</button>`,o.innerHTML=`
                <td data-label="${n.number}">${s+1}</td>
                <td data-label="${n.amount}" data-field="amount" data-original-value="${c}">${h(t.installmentAmount)}</td>
                <td data-label="${n.dueDate}" data-field="dueDate" data-original-value="${u}">${C(t.dueDate)}</td>
                <td data-label="${n.status}">${i}</td>
                <td data-label="${n.paymentDate}">${C(t.paymentDate)}</td>
                <td data-label="${n.name}">${t.installmentName}</td>
                <td data-label="${n.actions}" class="actions-cell">${m}</td>
            `,a.appendChild(o)})}
