import{o as k,d as B,a as h,g as A,s as w,b as f,l as D,m as L,n as x,p as M,r as $,t as V,q as z,i as U,c as H,j as T,k as N}from"./client.ocY2oErL.js";document.addEventListener("DOMContentLoaded",()=>{const m=document.getElementById("auth-loading-message"),e=document.getElementById("admin-login-container"),t=document.getElementById("page-content");k(f,async s=>{if(m&&(m.style.display="none"),s)try{const o=B(h,"users",s.uid),l=await A(o);if(l.exists()&&l.data().role==="admin"){t&&(t.style.display="block"),e&&(e.style.display="none");const i=document.getElementById("logout-button");i&&i.addEventListener("click",async()=>{await w(f),window.location.href="/admin"}),S(s)}else await w(f),e&&(e.style.display="block"),t&&(t.style.display="none")}catch(o){console.error("Auth Check Error:",o),await w(f),e&&(e.style.display="block"),t&&(t.style.display="none")}else t&&(t.style.display="none"),e&&(e.style.display="block")})});function S(m){const e=document.getElementById("add-user-form"),t=document.getElementById("add-user-btn"),s=document.getElementById("add-user-feedback"),o=document.getElementById("users-list"),l=document.getElementById("no-users-message"),i=document.getElementById("delete-confirm-modal"),y=document.getElementById("modal-confirm-btn"),C=document.getElementById("modal-cancel-btn");let g=null;e.addEventListener("submit",async n=>{n.preventDefault(),t.disabled=!0,s.textContent="جاري إنشاء الحساب وتخزين البيانات...",s.className="feedback-message";const d=document.getElementById("user-name").value,r=document.getElementById("user-email").value,a=document.getElementById("user-password").value,v=document.getElementById("user-role").value,b=`secondary-app-${Date.now()}`,c=D(L,b),E=x(c);try{const u=(await M(E,r,a)).user.uid;await $(B(h,"users",u),{uid:u,name:d,email:r,role:v,createdAt:new Date}),s.textContent="تم إنشاء حساب المستخدم بنجاح!",s.classList.add("success"),e.reset()}catch(p){console.error("Error creating user:",p);let u="فشل إنشاء المستخدم.";p.code==="auth/email-already-in-use"?u="هذا البريد الإلكتروني مستخدم بالفعل.":p.code==="auth/weak-password"&&(u="كلمة السر ضعيفة جدًا."),s.textContent=u,s.classList.add("error")}finally{t.disabled=!1,await V(c),setTimeout(()=>{s.textContent=""},5e3)}});const I=z(H(h,"users"),U("createdAt","desc"));T(I,n=>{const d=n.docs.filter(r=>m&&r.id!==m.uid);d.length===0?(l.textContent="لا يوجد مستخدمون حاليًا.",l.style.display="block",o.innerHTML=""):(l.style.display="none",o.innerHTML=d.map(r=>{const a=r.data(),v=a.name?a.name.charAt(0).toUpperCase():"?",b=a.createdAt?.toDate?a.createdAt.toDate().toLocaleDateString("ar-EG"):"غير معروف",c=a.role||"N/A",E=c==="admin"?"مسؤول":c==="supervisor"?"مشرف":"غير محدد";return`
            <div class="user-card" data-id="${a.uid}">
              <div class="user-card-header">
                <div class="user-avatar">${v}</div>
                <div class="user-info"><h3 class="user-name">${a.name}</h3><p class="user-email">${a.email}</p></div>
              </div>
              <div class="user-card-body">
                <p>تاريخ الإنشاء: <strong>${b}</strong></p>
                <p>الصلاحية: <span class="role-badge ${c}">${E}</span></p>
              </div>
              <div class="user-card-footer">
                <button class="btn btn-danger delete-btn">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/></svg>
                  <span>حذف</span>
                </button>
              </div>
            </div>`}).join(""))}),o.addEventListener("click",n=>{const d=n.target.closest(".delete-btn");d&&(g=d.closest(".user-card").dataset.id,i.style.display="flex")}),C.addEventListener("click",()=>{i.style.display="none",g=null}),y.addEventListener("click",async()=>{if(g){y.disabled=!0,y.textContent="جاري الحذف...";try{await N(B(h,"users",g)),alert("تم حذف المستخدم من القائمة بنجاح.")}catch(n){console.error("Error deleting user document: ",n),alert(`حدث خطأ أثناء حذف المستخدم: ${n.message}`)}finally{i.style.display="none",y.disabled=!1,y.textContent="تأكيد الحذف",g=null}}})}
