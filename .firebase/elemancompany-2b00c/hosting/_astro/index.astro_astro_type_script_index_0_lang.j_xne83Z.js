import{o as P,d as $,a as m,g as E,b as k,q as A,c as x,f as T,h as R,v as D,e as C,x as H,y as _,z as U,s as z,A as G}from"./client.ocY2oErL.js";function N(){let d={uid:null,name:""},c={};const S=document.getElementById("auth-loading-message"),v=document.getElementById("dashboard-content"),w=document.getElementById("user-name-placeholder"),u=document.getElementById("projects-list"),y=document.getElementById("no-projects-message"),q=document.getElementById("logout-button");if(!v||!u)return;u.addEventListener("click",e=>{const s=e.target,r=s.closest(".btn-submit");if(r){e.preventDefault();const t=r.closest("form");t.matches(".expense-form")&&F(t),t.matches(".report-form")&&M(t);return}const a=s.closest(".project-group");if(!a)return;const o=a.dataset.projectGroupId;if(s.matches(".btn-toggle-expense")){const t=a.querySelector(".expense-card"),i=a.querySelector(".report-card");t&&(t.style.display=t.style.display==="block"?"none":"block"),i&&(i.style.display="none")}if(s.matches(".btn-toggle-report")){const t=a.querySelector(".expense-card"),i=a.querySelector(".report-card");i&&(i.style.display=i.style.display==="block"?"none":"block"),t&&(t.style.display="none")}const n=a.querySelector(".expense-form");if(s.matches(".btn-cancel-expense")){const t=a.querySelector(".expense-card");t&&(t.style.display="none"),n&&n.reset(),c[o]=[],b(o,n)}if(s.matches(".btn-add-item")){const t=n.querySelector(".expense-item-select"),i=n.querySelector(".expense-item-amount"),p=n.querySelector(".expense-item-other-desc"),g=t.options[t.selectedIndex].text,f=t.value,h=parseFloat(i.value),I=p.value.trim();if(!f){alert("يرجى اختيار بند المصروف.");return}if(isNaN(h)||h<=0){alert("يرجى إدخال مبلغ صحيح.");return}if(f==="other"&&!I){alert('يرجى وصف بند "أخرى".');return}c[o].push({id:Date.now(),key:f,name:g,amount:h,description:f==="other"?I:null}),b(o,n),t.value="",i.value="",p.value="",n.querySelector(".other-description-group").style.display="none"}if(s.matches(".btn-delete-item")){const t=parseInt(s.getAttribute("data-id"),10);c[o]=c[o].filter(i=>i.id!==t),b(o,n)}const l=a.querySelector(".report-form");if(s.matches(".btn-cancel-report")){const t=a.querySelector(".report-card");t&&(t.style.display="none"),l&&l.reset()}}),u.addEventListener("change",e=>{const s=e.target;if(s.matches(".expense-item-select")){const r=s.closest(".expense-form").querySelector(".other-description-group");r&&(r.style.display=s.value==="other"?"block":"none")}}),P(k,async e=>{if(e){const s=$(m,"users",e.uid),r=await E(s);r.exists()&&r.data().role==="supervisor"?(d.uid=e.uid,d.name=r.data().name||"المشرف",w&&(w.textContent=d.name),await L(d.uid),S&&(S.style.display="none"),v&&(v.style.display="block")):window.location.href="/admin"}else window.location.href="/admin"});async function L(e){try{const s=A(x(m,"projects"),T("supervisorIds","array-contains",e)),a=(await R(s)).docs.map(t=>({id:t.id,...t.data()}));if(a.length===0){y&&(y.style.display="block"),u.innerHTML="";return}const o=[...new Set(a.flatMap(t=>t.supervisorIds||[]))],n=new Map;o.length>0&&(await Promise.all(o.map(i=>E($(m,"users",i))))).forEach(i=>{i.exists()&&n.set(i.id,i.data().name||"اسم غير معروف")});const l=a.map(t=>({...t,supervisorNames:(t.supervisorIds||[]).map(i=>n.get(i)||"اسم غير معروف")}));y&&(y.style.display="none"),u.innerHTML=l.map(B).join("")}catch(s){console.error("Error fetching supervisor projects:",s),u.innerHTML='<p class="error-message">حدث خطأ أثناء تحميل المشاريع.</p>'}}function B(e){c[e.id]=[];const s=e.supervisorNames.join(", ");return`
          <div class="project-group" data-project-group-id="${e.id}">
              <div class="project-card">
                  <div class="card-details">
                      <div class="card-item"><span class="item-label">اسم المشروع</span><p class="item-value">${e.projectName}</p></div>
                      <div class="card-item"><span class="item-label">عنوان المشروع</span><p class="item-value">${e.projectAddress||"غير محدد"}</p></div>
                      <div class="card-item"><span class="item-label">المشرفون</span><p class="item-value">${s}</p></div>
                  </div>
                  <div class="card-actions">
                      <button class="btn btn-action btn-toggle-expense">مصروفات يومية</button>
                      <button class="btn btn-action btn-toggle-report">تقرير يومي</button>
                  </div>
              </div>
              <div class="form-card expense-card" style="display: none;">
                   <form class="expense-form" data-project-id="${e.id}">
                      <header class="form-card-header"><h2>إضافة مصروفات يومية لمشروع: ${e.projectName}</h2></header>
                      <div class="form-section-title">إضافة بند مصروف</div>
                      <div class="add-item-container">
                          <div class="form-group"><label>اختر البند</label><select class="expense-item-select"><option value="" disabled selected>-- اختر --</option><option value="buffet_hospitality">بوفيه وضيافه</option><option value="bricks">طوب</option><option value="sand">رمله</option><option value="cement">اسمنت</option><option value="steel">حديد</option><option value="labor">عمال</option><option value="other">أخرى</option></select></div>
                          <div class="form-group"><label>المبلغ (ج.م)</label><input type="number" class="expense-item-amount" placeholder="0.00"></div>
                          <div class="form-group other-description-group" style="display: none;"><label>وصف بند 'أخرى'</label><input type="text" class="expense-item-other-desc" placeholder="يرجى التوضيح"></div>
                          <button type="button" class="btn btn-add-item">+ إضافة البند</button>
                      </div>
                      <div class="staged-items-container" style="display: none;"><div class="form-section-title">البنود المضافة</div><ul class="staged-expenses-list"></ul></div>
                      <div class="form-section-title">تفاصيل إضافية</div>
                      <div class="form-group"><label>ملاحظات (اختياري)</label><textarea class="expense-notes" rows="3"></textarea></div>
                      <div class="form-group"><label>إرفاق صور (اختياري)</label><input type="file" class="expense-images" multiple accept="image/*"></div>
                      <div class="upload-progress" style="display: none;"></div>
                      <div class="form-actions"><button type="submit" class="btn btn-submit">حفظ المصروفات</button><button type="button" class="btn btn-cancel-expense">إلغاء</button></div>
                  </form>
              </div>
              <div class="form-card report-card" style="display: none;">
                  <form class="report-form" data-project-id="${e.id}">
                      <header class="form-card-header"><h2>إضافة تقرير يومي لمشروع: ${e.projectName}</h2></header>
                      <div class="form-group"><label>نص التقرير</label><textarea class="report-text" rows="6" required placeholder="اكتب هنا تفاصيل سير العمل، المشاكل، التقدم المحرز..."></textarea></div>
                      <div class="form-group"><label>إرفاق صور (اختياري)</label><input type="file" class="report-images" multiple accept="image/*"></div>
                      <div class="upload-progress" style="display: none;"></div>
                      <div class="form-actions"><button type="submit" class="btn btn-submit">حفظ التقرير</button><button type="button" class="btn btn-cancel-report">إلغاء</button></div>
                  </form>
              </div>
          </div>
        `}async function F(e){const s=e.dataset.projectId,r=c[s];if(!r||r.length===0){alert("الرجاء إضافة بند مصروف واحد على الأقل.");return}const a=e.querySelector(".btn-submit"),o=e.querySelector(".upload-progress");a&&(a.disabled=!0),o&&(o.style.display="block",o.textContent="جارٍ حفظ البيانات...");const n={};r.forEach(l=>{const t=l.description?l.description.replace(/[.\*\/\[\]#$]/g,"_-"):"",i=l.key==="other"?`other_${t.replace(/\s+/g,"_")}`:l.key;n[i]=(n[i]||0)+l.amount});try{const l=await j(s,"expenses",e.querySelector(".expense-images").files,o),t={projectId:s,supervisorId:d.uid,supervisorName:d.name,createdAt:D(),expenses:n,totalAmount:r.reduce((i,p)=>i+p.amount,0),notes:e.querySelector(".expense-notes").value,imageUrls:l,isRead:!1};await C(x(m,"daily_expenses"),t),alert("تم حفظ المصروفات بنجاح!"),e.closest(".form-card").style.display="none",e.reset(),c[s]=[],b(s,e)}catch(l){console.error("Error during expense submission:",l),alert("حدث خطأ فادح أثناء حفظ المصروفات. تم تسجيل الخطأ في الكونسول للمراجعة.")}finally{a&&(a.disabled=!1),o&&(o.style.display="none")}}async function M(e){const s=e.dataset.projectId,r=e.querySelector(".report-text").value.trim();if(!r){alert("يرجى كتابة نص التقرير قبل الحفظ.");return}const a=e.querySelector(".btn-submit"),o=e.querySelector(".upload-progress");a&&(a.disabled=!0),o&&(o.style.display="block",o.textContent="جارٍ حفظ البيانات...");try{const n=await j(s,"reports",e.querySelector(".report-images").files,o);await C(x(m,"daily_reports"),{projectId:s,supervisorId:d.uid,supervisorName:d.name,createdAt:D(),report:r,notes:"",imageUrls:n,isRead:!1}),alert("تم حفظ التقرير بنجاح!"),e.closest(".form-card").style.display="none",e.reset()}catch(n){console.error("Error during report submission:",n),alert("حدث خطأ فادح أثناء حفظ التقرير. تم تسجيل الخطأ في الكونسول للمراجعة.")}finally{a&&(a.disabled=!1),o&&(o.style.display="none")}}async function j(e,s,r,a){const o=[];if(!r||r.length===0)return o;a&&(a.textContent="جارٍ رفع الصور...");for(let n=0;n<r.length;n++){a&&(a.textContent=`جارٍ رفع الصورة ${n+1} من ${r.length}`);const l=r[n],t=`${s}/${e}/${Date.now()}-${l.name}`,i=H(G,t),p=_(i,l);await p;const g=await U(p.snapshot.ref);o.push(g)}return o}function b(e,s){const r=s.querySelector(".staged-expenses-list"),a=s.querySelector(".staged-items-container");if(!(!r||!a)){if(r.innerHTML="",!c[e]||c[e].length===0){a.style.display="none";return}a.style.display="block",c[e].forEach(o=>{const n=document.createElement("li");n.className="staged-item",n.innerHTML=`<span>${o.name}${o.description?` <em>(${o.description})</em>`:""}</span> <span class="item-amount">${o.amount.toFixed(2)} ج.م</span><button type="button" class="btn-delete-item" data-id="${o.id}">&times;</button>`,r.appendChild(n)})}}q&&q.addEventListener("click",async()=>{try{await z(k),window.location.href="/admin"}catch(e){console.error("Logout Error:",e)}})}N();document.addEventListener("astro:after-swap",N);
