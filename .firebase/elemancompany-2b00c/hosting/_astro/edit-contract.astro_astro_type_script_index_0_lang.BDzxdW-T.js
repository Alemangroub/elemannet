import{o as g,b as h,q as i,c as u,a as m,f as d,h as y,w as I,d as E}from"./client.ocY2oErL.js";let r=null,s=null;document.addEventListener("DOMContentLoaded",()=>{const o=document.getElementById("auth-loading-message"),e=document.getElementById("admin-login-container"),t=document.getElementById("page-content");g(h,async c=>{o.style.display="none",c?(t.style.display="block",e.style.display="none",b()):(e.style.display="block",t.style.display="none")})});async function b(){const o=document.getElementById("loader"),e=document.getElementById("edit-contract-form"),t=document.getElementById("error-display"),c=new URLSearchParams(window.location.search);if(r=c.get("projectId"),s=decodeURIComponent(c.get("customerName")),document.getElementById("cancel-btn").href=`/admin/contract-details?projectId=${r}&customerName=${encodeURIComponent(s)}`,!r||!s){o.style.display="none",t.textContent="بيانات العقد غير مكتملة في الرابط.",t.style.display="block";return}document.getElementById("form-subheader").textContent=`يتم تعديل العقد الخاص بـ: ${s}`;try{const n=i(u(m,"installments"),d("projectId","==",r),d("customerName","==",s)),l=await y(n);if(l.empty)throw new Error("لم يتم العثور على العقد.");const a=l.docs[0].data();document.getElementById("customer-name").value=a.customerName||"",document.getElementById("customer-phone").value=a.customerPhone||"",document.getElementById("total-amount").value=a.totalAmount||0,document.getElementById("unit-type").value=a.unitType||"apartment",document.getElementById("unit-location").value=a.unitLocation||"",o.style.display="none",e.style.display="block"}catch(n){console.error("Error loading contract data: ",n),o.style.display="none",t.textContent=`حدث خطأ: ${n.message}`,t.style.display="block"}e.addEventListener("submit",f)}async function f(o){o.preventDefault();const e=document.getElementById("submit-btn");e.disabled=!0,e.textContent="جاري الحفظ...";const t=new FormData(o.target),c={customerName:t.get("customerName"),customerPhone:t.get("customerPhone"),totalAmount:parseFloat(t.get("totalAmount")),unitType:t.get("unitType"),unitLocation:t.get("unitLocation")};try{const n=i(u(m,"installments"),d("projectId","==",r),d("customerName","==",s)),l=await y(n);if(l.empty)throw new Error("لم يتم العثور على أقساط لتحديثها.");const a=I(m);l.docs.forEach(p=>{a.update(E(m,"installments",p.id),c)}),await a.commit(),alert("تم تحديث بيانات العقد بنجاح!"),window.location.href=`/admin/contract-details?projectId=${r}&customerName=${encodeURIComponent(c.customerName)}`}catch(n){console.error("Error updating contract: ",n),alert(`فشل تحديث العقد: ${n.message}`),e.disabled=!1,e.textContent="حفظ التعديلات"}}
