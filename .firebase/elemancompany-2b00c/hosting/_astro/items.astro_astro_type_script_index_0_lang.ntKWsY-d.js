const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["_astro/jspdf.es.min.CVfWhEC0.js","_astro/preload-helper.BlTxHScW.js"])))=>i.map(i=>d[i]);
import{_ as V}from"./preload-helper.BlTxHScW.js";import{o as ge,d as te,a as ne,g as he,s as ae,b as z,k as Ee}from"./client.ocY2oErL.js";document.addEventListener("DOMContentLoaded",()=>{const G=document.getElementById("auth-loading-message"),f=document.getElementById("admin-login-container"),p=document.getElementById("page-content");ge(z,async L=>{if(G&&(G.style.display="none"),!L){p&&(p.style.display="none"),f&&(f.style.display="block");return}try{const d=te(ne,"users",L.uid),u=await he(d);u.exists()&&u.data().role==="admin"?(p&&(p.style.display="block"),f&&(f.style.display="none"),oe()):(await ae(z),window.location.href="/admin")}catch(d){console.error("Auth Check Error:",d),f&&(f.style.display="block"),p&&(p.style.display="none")}});function oe(){const L=document.getElementById("logout-button");L&&L.addEventListener("click",async()=>{await ae(z),window.location.href="/admin"});const d=document.getElementById("delete-confirm-modal"),u=document.getElementById("delete-modal-confirm-btn"),W=document.getElementById("delete-modal-cancel-btn"),g=document.getElementById("save-confirm-modal"),h=document.getElementById("save-modal-confirm-btn"),U=document.getElementById("save-modal-cancel-btn");let w=null,S=null,E=null;const X=document.getElementById("items-table-body");X&&X.addEventListener("click",e=>{const n=e.target.closest(".btn-action");if(!n)return;const t=n.closest(".item-row");t&&(n.classList.contains("btn-delete")?ie(n):n.classList.contains("btn-edit")?le(t):n.classList.contains("btn-cancel")?A(t):n.classList.contains("btn-save")?se(t):n.classList.contains("btn-print")?ce(t):n.classList.contains("btn-pdf")?de(t,n):n.classList.contains("btn-excel")&&re(t,n))});function ie(e){w={projectId:e.dataset.projectId,itemId:e.dataset.itemId},d&&(d.style.display="flex")}function le(e){E&&E!==e&&A(E),E=e,M(e,!0)}function A(e){M(e,!1),E=null}function se(e){S=e,g&&(g.style.display="flex")}function J(e,n){const t=document.querySelector("h1").textContent||"تفاصيل البند",o=e.querySelectorAll("td[data-label]");let a=`
                    <h1>${t}</h1>
                    <h2>${n}</h2>
                    <table>
                        <tbody>`;return o.forEach(i=>{const l=i.getAttribute("data-label");if(l==="إجراءات")return;const s=i.dataset.originalValue||i.textContent.trim();a+=`<tr><th>${l}</th><td>${s}</td></tr>`}),a+="</tbody></table>",a}function ce(e){const n=J(e,"تفاصيل البند"),t=window.open("","","height=700,width=800");if(!t){alert("فشل فتح نافذة الطباعة. يرجى التأكد من السماح بالنوافذ المنبثقة (Pop-ups) لهذا الموقع.");return}t.document.write(`<style>
                        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
                        body { font-family: 'Cairo', sans-serif; direction: rtl; margin: 20px; }
                        h1, h2 { text-align: center; color: #333; }
                        h1 { font-size: 1.5rem; }
                        h2 { font-size: 1.2rem; color: #555; margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                        tr { border-bottom: 1px solid #eee; }
                        th, td { padding: 12px 15px; text-align: right; }
                        th { background-color: #f8f8f8; font-weight: 700; color: #555; width: 30%; }
                        @media print { body { -webkit-print-color-adjust: exact; } h1 {color: #000;} }
                    </style>`+n),t.document.close(),t.focus(),setTimeout(()=>{t.print()},500)}async function de(e,n){n.disabled=!0,n.textContent="جارٍ...";try{const{default:t}=await V(async()=>{const{default:B}=await import("./html2canvas.esm.B0tyYwQk.js");return{default:B}},[]),{jsPDF:o}=await V(async()=>{const{jsPDF:B}=await import("./jspdf.es.min.CVfWhEC0.js").then(T=>T.j);return{jsPDF:B}},__vite__mapDeps([0,1])),a=document.createElement("div");a.innerHTML=J(e,"تفاصيل البند"),a.style.fontFamily="'Cairo', sans-serif",a.style.direction="rtl",document.body.appendChild(a);const i=await t(a,{scale:2,useCORS:!0,onclone:B=>{const T=B.createElement("style");T.innerHTML=`
                            @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
                            body, div { font-family: 'Cairo', sans-serif !important; direction: rtl;}
                            table { width: 100%; border-collapse: collapse; } h1, h2 { text-align: center; } h1{font-size: 1.2em;} h2{font-size: 1em;}
                            tr { border-bottom: 1px solid #ddd; } th, td { padding: 8px; text-align: right; }
                            th { background-color: #f2f2f2; width: 30%; }`,B.body.appendChild(T)}}),l=i.toDataURL("image/png"),s=new o({orientation:"p",unit:"mm",format:"a4"}),c=s.internal.pageSize.getWidth(),r=i.width,m=i.height,I=r/m,fe=c/I;s.addImage(l,"PNG",10,10,c-20,fe-10);const pe=e.querySelector('td[data-field="name"]').textContent.trim();s.save(`item-${pe}.pdf`),document.body.removeChild(a)}catch(t){console.error("PDF Export Error:",t),alert("فشل تصدير PDF. يرجى المحاولة مرة أخرى.")}finally{n.disabled=!1,n.textContent="تصدير PDF"}}async function re(e,n){n.disabled=!0,n.textContent="جارٍ...";try{const t=await V(()=>import("./xlsx.DGuHH-KN.js"),[]),o=[],a=[];e.querySelectorAll("td[data-label]").forEach(r=>{const m=r.getAttribute("data-label");m!=="إجراءات"&&(a.push(m),o.push(r.textContent.trim()))});const i=[a,o],l=t.utils.aoa_to_sheet(i),s=t.utils.book_new();t.utils.book_append_sheet(s,l,"Item Details");const c=e.querySelector('td[data-field="name"]').textContent.trim();t.writeFile(s,`item-${c}.xlsx`)}catch(t){console.error("Excel Export Error:",t),alert("فشل تصدير Excel. يرجى المحاولة مرة أخرى.")}finally{n.disabled=!1,n.textContent="تصدير Excel"}}async function ue(e){const n=e.dataset.itemId,t=e.dataset.projectId,o={};if(e.querySelectorAll("input, select").forEach(a=>{o[a.name]=a.value}),!o.name||!o.personName||!o.quantity||!o.unitPrice||!o.createdAt){alert("يرجى ملء جميع الحقول المطلوبة.");return}try{const a=await fetch("/api/updateItem",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:t,itemId:n,...o})}),i=await a.json();if(!a.ok)throw new Error(i.error||"فشل تحديث البند.");e.querySelectorAll("td[data-field]").forEach(l=>{const s=l.dataset.field;let c=i.data[s];(s==="unitPrice"||s==="totalPrice")&&(c=parseFloat(c).toFixed(2)),l.textContent=c,l.dataset.originalValue=c}),e.dataset.itemName=i.data.name,M(e,!1),E=null}catch(a){console.error("Save Error:",a),alert(`خطأ: ${a.message}`),A(e)}}function M(e,n){const t=e.querySelector(".action-buttons-view"),o=e.querySelector(".action-buttons-edit");if(n){t.style.display="none",o.style.display="flex",e.classList.add("editing"),e.querySelectorAll("td[data-field]").forEach(c=>{const r=c.dataset.field,m=c.textContent.trim();c.dataset.originalValue=m;let I;switch(r){case"createdAt":I=`<input type="date" name="createdAt" value="${m}" class="form-control-inline">`;break;case"quantity":case"unitPrice":I=`<input type="number" name="${r}" value="${m}" step="0.01" class="form-control-inline">`;break;case"name":case"personName":case"notes":I=`<input type="text" name="${r}" value="${m}" class="form-control-inline">`;break;case"totalPrice":return;default:return}c.innerHTML=I});const a=e.querySelector('input[name="quantity"]'),i=e.querySelector('input[name="unitPrice"]'),l=e.querySelector('td[data-field="totalPrice"]'),s=()=>{const c=parseFloat(a.value)||0,r=parseFloat(i.value)||0;l.textContent=(c*r).toFixed(2)};a&&i&&(a.addEventListener("input",s),i.addEventListener("input",s))}else t.style.display="flex",o.style.display="none",e.classList.remove("editing"),e.querySelectorAll("td[data-field]").forEach(a=>{a.querySelector("input, select")&&(a.textContent=a.dataset.originalValue)})}W&&W.addEventListener("click",()=>{d&&(d.style.display="none"),w=null}),u&&u.addEventListener("click",async()=>{if(!w)return;const{projectId:e,itemId:n}=w,t=document.getElementById(`item-row-${n}`);u.disabled=!0,u.textContent="جاري الحذف...";try{const o=te(ne,"projects",e,"items",n);await Ee(o),t&&t.remove()}catch(o){console.error("Error deleting item: ",o),alert("حدث خطأ أثناء محاولة الحذف. يرجى المحاولة مرة أخرى.")}finally{d&&(d.style.display="none"),w=null,u.disabled=!1,u.textContent="تأكيد الحذف"}}),U&&U.addEventListener("click",()=>{g&&(g.style.display="none"),S=null}),h&&h.addEventListener("click",async()=>{S&&(h.disabled=!0,h.textContent="جاري الحفظ...",await ue(S),g&&(g.style.display="none"),S=null,h.disabled=!1,h.textContent="تأكيد الحفظ")});const K=document.getElementById("itemDate");K&&(K.value=new Date().toLocaleDateString("en-CA"));const k=document.getElementById("toggle-form-btn"),Q=document.getElementById("cancel-btn"),P=document.getElementById("add-item-form");k&&P&&k.addEventListener("click",()=>{const e=P.style.display==="none";P.style.display=e?"block":"none",k.textContent=e?"- إلغاء الإضافة":"+ إضافة بند جديد"}),Q&&P&&k&&Q.addEventListener("click",()=>{P.style.display="none",k.textContent="+ إضافة بند جديد"});const b={"بند العماله":["بند المصروف اليومي","بند اجرة العمال"],"بند المقاول":["بند لبشه عاديه","بند لبشه مسلحه"],"بند الخرسانه":["الاسمنت","الحديد","الزلط","الرمله","المقاول"],"بند المباني":["رمله","اسمنت","طوب","تشوين","اجرة مباني"],"بند الكهرباء":["بند الاساسيات","بند اجرة التركيب"],"بند السباكه":["بند الاساسيات","بند اجرة التركيب"],"بند المحاره":["الاسمنت","الرمله","اجرة عمال","تشوين"],"بند الرخام":["تمن الرخام","تمن التركيب"],"بند الدهانات":["مونه","اجره"],"بند تشطيبات الكهرباء":["مونه","اجره"],"بند المجلس":["مصروف الرخصه","التصالح","المحاضر"],"بند الحفر":["اجرة العمال","المعدات"],"بند الهدم":["اجرة عمال","المعدات"]},N=document.getElementById("main-category"),me=document.getElementById("sub-category-group"),F=document.getElementById("sub-category"),Y=document.getElementById("other-name-group"),_=document.getElementById("other-name"),$=document.getElementById("name");function D(){const e=N.value;e==="اخرى"?$.value=_.value:b[e]?$.value=F.value:$.value=e}N.addEventListener("change",()=>{const e=N.value;F.innerHTML="",Y.style.display="none",_.required=!1,b[e]?(b[e].forEach(n=>{const t=document.createElement("option");t.value=n,t.textContent=n,F.appendChild(t)}),me.style.display="block"):e==="اخرى"&&(Y.style.display="block",_.required=!0),D()}),F.addEventListener("change",D),_.addEventListener("input",D),D();const j=document.getElementById("quantity"),R=document.getElementById("unitPrice"),ye=document.getElementById("totalPrice");function Z(){const e=parseFloat(j.value)||0,n=parseFloat(R.value)||0;ye.value=(e*n).toFixed(2)}j&&R&&(j.addEventListener("input",Z),R.addEventListener("input",Z));const q=document.getElementById("main-category-filter"),v=document.getElementById("sub-category-filter-group"),y=document.getElementById("sub-category-filter"),C=document.getElementById("table-container"),x=document.getElementById("initial-message"),ee=document.getElementById("filtered-total");function O(){const e=document.querySelectorAll("#items-table-body .item-row");let n=0;e.forEach(t=>{if(t.style.display!=="none"){const o=parseFloat(t.dataset.totalPrice)||0;n+=o}}),ee&&(ee.textContent=`${n.toFixed(2)} ج.م`)}if(q){const e=Array.from(document.querySelectorAll(".item-row"));Object.keys(b).forEach(t=>{const o=document.createElement("option");o.value=t,o.textContent=t,q.appendChild(o)}),q.addEventListener("change",()=>{const t=q.value;if(!t||t==="all"){v&&(v.style.display="none"),C&&(C.style.display=t==="all"?"block":"none"),x&&(x.style.display=t==="all"?"none":"block"),e.forEach(a=>a.style.display=""),O();return}const o=b[t];if(o&&o.length>0){if(y){y.innerHTML="";const a=document.createElement("option");a.value="all-subs",a.textContent=`جميع بنود ${t}`,y.appendChild(a),o.forEach(i=>{const l=document.createElement("option");l.value=i,l.textContent=i,y.appendChild(l)}),v&&(v.style.display="block"),y.dispatchEvent(new Event("change"))}}else v&&(v.style.display="none"),C&&(C.style.display="block"),x&&(x.style.display="none"),e.forEach(a=>{a.style.display=a.dataset.itemName===t?"":"none"}),O()}),y&&y.addEventListener("change",()=>{const t=q.value,o=y.value,a=b[t]||[];C&&(C.style.display="block"),x&&(x.style.display="none"),e.forEach(i=>{const l=i.dataset.itemName;let s=!1;o==="all-subs"?a.includes(l)&&(s=!0):l===o&&(s=!0),i.style.display=s?"":"none"}),O()})}const H=document.querySelector(".success-message");H&&setTimeout(()=>{H.style.opacity="0",setTimeout(()=>{H.remove();const e=new URL(window.location);e.searchParams.delete("success"),history.replaceState(null,"",e.toString())},500)},5e3)}});
