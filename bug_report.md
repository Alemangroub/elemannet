# Bug Report: فشل حذف قسط

**معرف فريد:** BUG-INSTALLMENT-DELETE-001

**تاريخ الإبلاغ:** 2024-07-27

**المُبلغ:** Gemini AI (بناءً على ملاحظات المستخدم)

**الأهمية:** عالية (يؤثر على وظيفة أساسية لإدارة البيانات)

---

## وصف المشكلة

عند محاولة حذف قسط فردي من جدول الأقساط في صفحة تفاصيل العقد، لا يتم حذف القسط من واجهة المستخدم أو من قاعدة بيانات Firestore. لا تظهر رسائل خطأ واضحة للمستخدم، مما يعطي انطباعًا بأن العملية لم تتم.

## خطوات إعادة إنتاج الخطأ (Steps to Reproduce)

1.  انتقل إلى صفحة تفاصيل عقد يحتوي على أكثر من قسط واحد (`/admin/contract-details?projectId=...&customerName=...`).
2.  من جدول الأقساط، اضغط على زر "حذف" بجوار أي قسط.
3.  في نافذة التأكيد المنبثقة، اضغط على "تأكيد".

## السلوك المتوقع (Expected Behavior)

-   يجب حذف القسط المحدد من قاعدة بيانات Firestore.
-   يجب تحديث المبلغ الإجمالي للعقد في جميع الأقساط المتبقية ليعكس الحذف.
-   يجب تحديث واجهة المستخدم فورًا لإزالة صف القسط المحذوف من الجدول.
-   يجب إعادة حساب وعرض ملخص المبالغ (الإجمالي، المدفوع، المتبقي) بشكل صحيح.

## السلوك الفعلي (Actual Behavior)

-   لا يتم حذف القسط من Firestore.
-   لا يتم تحديث واجهة المستخدم، ويظل القسط ظاهرًا في الجدول.
-   لا تحدث أي تغييرات على ملخص المبالغ.

## تحليل السبب الجذري المحتمل (Root Cause Analysis)

بعد مراجعة الكود في `src/pages/admin/contract-details.astro`، يبدو أن هناك خطأ منطقيًا في دالة `handleDeleteInstallment`. 

المشكلة تكمن في أن الكود يحاول العثور على القسط المراد حذفه في مصفوفة `allInstallments` التي يتم جلبها عند تحميل الصفحة. إذا تم إجراء أي تعديلات على الصفحة (مثل تغيير الحالة أو السداد الجزئي) والتي تؤدي إلى إعادة تحميل البيانات (`initializeApp`), قد لا يكون معرف الزر متزامنًا مع البيانات الموجودة في المصفوفة، أو قد يكون هناك خطأ في كيفية التعامل مع الـ `batch` الخاص بـ Firestore.

من المحتمل أيضًا أن هناك خطأ في كيفية استهداف المستند (document reference) في عملية الحذف داخل الـ `batch`.

## الإصلاح المقترح

1.  **إعادة كتابة `handleDeleteInstallment`:** تبسيط منطق الدالة.
2.  **التحقق المباشر:** التأكد من وجود القسط المراد حذفه في قاعدة البيانات قبل محاولة حذفه.
3.  **تحديث واجهة المستخدم:** بعد التأكد من نجاح عملية الحذف من قاعدة البيانات، يتم استدعاء `initializeApp()` لإعادة تحميل وعرض البيانات المحدثة، وهو ما يضمن اتساق الواجهة مع قاعدة البيانات.

## معلومات إضافية

-   **بيئة الاختبار:** Firebase Studio (Project IDX)
-   **المتصفح:** Web Preview
-   **الملف المتأثر:** `src/pages/admin/contract-details.astro`
