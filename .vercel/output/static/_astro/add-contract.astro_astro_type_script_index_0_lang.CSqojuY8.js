import{o as L,d as b,a as I,g as v,s as C,b as h,w as D,c as B,T as f}from"./client.ocY2oErL.js";let r=null;document.addEventListener("DOMContentLoaded",()=>{const l=document.getElementById("auth-loading-message"),e=document.getElementById("admin-login-container"),t=document.getElementById("page-content");L(h,async s=>{if(l&&(l.style.display="none"),s)try{const n=b(I,"users",s.uid),o=await v(n);o.exists()&&o.data().role==="admin"?(t&&(t.style.display="block"),e&&(e.style.display="none"),_()):(await C(h),e&&(e.style.display="block"),t&&(t.style.display="none"))}catch(n){console.error("Auth Check Error:",n),await C(h),e&&(e.style.display="block"),t&&(t.style.display="none")}else t&&(t.style.display="none"),e&&(e.style.display="block")})});function _(){if(r=new URLSearchParams(window.location.search).get("projectId"),!r){document.getElementById("page-content").innerHTML="<p>خطأ: لم يتم تحديد المشروع.</p>";return}document.getElementById("cancel-btn").href=`/admin/project-installments?projectId=${r}`,document.getElementById("add-contract-form").addEventListener("submit",$),document.getElementById("total-amount").addEventListener("input",E),document.getElementById("down-payment").addEventListener("input",E),document.getElementById("number-of-installments").addEventListener("change",P),E()}function E(){const l=document.getElementById("total-amount"),e=document.getElementById("down-payment"),t=document.getElementById("remaining-amount"),s=parseInt(l.value.replace(/[^0-9]/g,""))||0,n=parseInt(e.value.replace(/[^0-9]/g,""))||0,o=s-n;t.value=o}function P(){const l=document.getElementById("number-of-installments"),e=document.getElementById("dynamic-installments-container"),t=parseInt(l.value);if(e.innerHTML="",!t)return;const s=document.createElement("h3");s.textContent="تفاصيل الأقساط",e.appendChild(s);for(let n=0;n<t;n++){const o=document.createElement("div");o.className="installment-row";const c=document.createElement("label");c.textContent=`القسط ${n+1}`,c.style.fontWeight="bold";const a=document.createElement("div");a.className="installment-input-group";const u=document.createElement("label");u.textContent="المبلغ";const m=document.createElement("input");m.type="text",m.inputMode="numeric",m.name=`installment_amount_${n}`,m.placeholder="ادخل المبلغ",m.required=!0,a.appendChild(u),a.appendChild(m);const i=document.createElement("div");i.className="installment-input-group";const p=document.createElement("label");p.textContent="تاريخ الاستحقاق";const d=document.createElement("input");d.type="date",d.name=`installment_date_${n}`,d.required=!0,i.appendChild(p),i.appendChild(d);const g=document.createElement("div");g.className="installment-input-group";const w=document.createElement("label");w.textContent="الحالة";const y=document.createElement("select");y.name=`installment_status_${n}`,y.innerHTML='<option value="pending">مستحق</option><option value="paid">مدفوع</option>',y.required=!0,g.appendChild(w),g.appendChild(y),o.appendChild(c),o.appendChild(a),o.appendChild(i),o.appendChild(g),e.appendChild(o)}}async function $(l){l.preventDefault();const e=document.getElementById("submit-btn");e.disabled=!0,e.textContent="جارٍ إنشاء العقد...";const t=new FormData(l.target);t.get("customerName");const s=parseInt(t.get("numberOfInstallments")),n={projectId:r,customerName:t.get("customerName"),customerPhone:t.get("customerPhone"),totalAmount:parseInt(t.get("totalAmount").replace(/[^0-9]/g,""))||0,unitType:t.get("unitType"),unitLocation:t.get("unitLocation")},o=parseInt(t.get("downPayment").replace(/[^0-9]/g,""))||0,c=D(I);if(o>0){const a=b(B(I,"installments"));c.set(a,{...n,installmentAmount:o,installmentName:"دفعة مقدمة",status:"paid",paymentDate:f.now(),dueDate:f.now()})}for(let a=0;a<s;a++){const u=b(B(I,"installments")),m=t.get(`installment_status_${a}`),i=t.get(`installment_amount_${a}`).replace(/[^0-9]/g,""),p=parseInt(i)||0,d=new Date(t.get(`installment_date_${a}`));c.set(u,{...n,installmentAmount:p,installmentName:`القسط ${a+1}`,status:m,paymentDate:m==="paid"?f.now():null,dueDate:f.fromDate(d)})}try{await c.commit(),alert("تم إنشاء العقد والأقساط بنجاح!"),window.location.href=`/admin/project-installments?projectId=${r}`}catch(a){console.error("Error creating contract: ",a),alert("فشل إنشاء العقد. الرجاء المحاولة مرة أخرى."),e.disabled=!1,e.textContent="إنشاء العقد"}}
