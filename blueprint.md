# Blueprint: نظام متابعة المشاريع للمقاولات

## نظرة عامة

هذا المشروع هو تطبيق ويب تم بناؤه باستخدام Astro.js ومُحسَّن للعمل على Firebase Studio. الهدف منه هو توفير نظام متكامل للمقاولات لإدارة ومتابعة المشاريع الهندسية.

- **المدراء:** يمكنهم إضافة المشاريع، تعيين المشرفين، والاطلاع على التقارير والمصروفات اليومية التي يقدمها المشرفون.
- **المشرفون:** يمكنهم عرض المشاريع المعينين لها وتقديم تقارير يومية وتقارير مصروفات لكل مشروع.

## الميزات والوظائف

### 1. قسم المدير (Admin)

- **لوحة تحكم المشاريع (`/admin/projects`):**
  - تعرض قائمة بجميع المشاريع مع تفاصيلها الأساسية.
  - تسمح للمدير بإضافة مشاريع جديدة وتعيين مشرفين عليها.
- **صفحة تفاصيل المشروع (`/admin/projects/[id]`):**
  - صفحة **للعرض فقط** مخصصة للمدراء لمراجعة كل الأنشطة المتعلقة بمشروع معين.
  - تعرض التقارير اليومية والمصروفات التي يقدمها المشرفون، مرتبة زمنيًا من الأحدث للأقدم.
  - تستخدم **فهارس مركبة (Composite Indexes)** في Firestore لضمان جلب البيانات وترتيبها بكفاءة.

### 2. قسم المشرف (Supervisor)

- **لوحة التحكم (`/dashboard`):**
  - تعرض للمشرف قائمة بالمشاريع التي تم تعيينه للإشراف عليها.
- **صفحة تقديم التقارير (`/dashboard/[id]`):**
  - نموذج متكامل يسمح للمشرف بتقديم:
    - **تقرير يومي:** نص وصفي لسير العمل مع إمكانية رفع صور.
    - **تقرير مصروفات:** قائمة بالبنود والمبالغ المصروفة، ملاحظات، وإمكانية رفع صور فواتير.
  - يتم حفظ البيانات في مجموعات `daily_reports` و `daily_expenses` مع ربطها بالمشروع والمشرف.

### 3. المصادقة والصلاحيات

- **تسجيل الدخول (`/admin`):** صفحة موحدة لتسجيل دخول المدراء والمشرفين.
- **توجيه الأدوار:** بعد تسجيل الدخول، يتم توجيه المستخدم إلى لوحة التحكم المناسبة لدوره (`/admin/projects` للمدير أو `/dashboard` للمشرف).
- **قواعد أمان Firestore (`firestore.rules`):**
  - **المدراء:** لديهم صلاحيات كاملة للقراءة والكتابة على جميع البيانات.
  - **المشرفون:** يمكنهم **فقط** إنشاء (`create`) تقارير ومصروفات جديدة، ولا يمكنهم تعديلها أو حذفها أو قراءة تقارير المشرفين الآخرين.
  - تم نشر القواعد وتفعيلها على خوادم Firebase.

## التصميم والواجهة

- **اللغة العربية (RTL):** الواجهة موجهة بالكامل للغة العربية.
- **الخطوط:** استخدام خط 'Cairo' لتحسين تجربة القراءة.
- **تصميم احترافي:** واجهات نظيفة تعتمد على البطاقات، الظلال، والأيقونات لتسهيل الاستخدام.
- **متجاوب (Responsive):** يعمل بشكل جيد على الشاشات المختلفة.

## الخطة الحالية والتغييرات الأخيرة

**المهمة: حل مشكلة عدم ظهور تقارير المشرف في صفحة المدير.**

**ملخص رحلة الإصلاح المعقدة:**

1.  **المشكلة الأولية:** بعد أن يقوم المشرف بحفظ تقرير، لا يظهر هذا التقرير في صفحة تفاصيل المشروع الخاصة بالمدير.
2.  **التشخيص الخاطئ الأول (صلاحيات):** كان الاعتقاد الأولي أن المشكلة في صلاحيات الكتابة. تم مراجعة وتصحيح ملف `firestore.rules` عدة مرات.
3.  **الاكتشاف الحاسم (خطأ النشر):** تبين أن ملف `firestore.rules` كان يتم تعديله محليًا **دون نشره (deploy)** إلى خوادم Firebase، مما جعل كل تعديلات الصلاحيات غير فعّالة.
4.  **إجراء الإصلاح (نشر الصلاحيات):** تم استخدام أمر `firebase deploy --only firestore:rules` لنشر القواعد الصحيحة، مما حل مشكلة "رفض الصلاحيات".
5.  **ظهور مشكلة جديدة (البيانات لا تظهر):** بعد حل مشكلة الصلاحيات، استمرت البيانات في عدم الظهور في صفحة المدير.
6.  **التشخيص الصحيح (فهارس Firestore):** تبين أن الكود يطلب من قاعدة البيانات "البحث" (`where`) و"الترتيب" (`orderBy`) في نفس الوقت، وهو طلب يتطلب وجود **"فهرس مركب" (Composite Index)**. بدون هذا الفهرس، كان Firestore يرفض تنفيذ الطلب بصمت.
7.  **الحل النهائي (إنشاء الفهارس):**
    - تم إنشاء ملف `firestore.indexes.json` لتعريف الفهارس المطلوبة بشكل صريح.
    - تم نشر ملف الفهارس باستخدام `firebase deploy --only firestore:indexes`.
    - بعد بناء الفهارس بواسطة Firebase، تم حل المشكلة نهائيًا، وأصبحت البيانات تظهر مرتبة بشكل صحيح.

