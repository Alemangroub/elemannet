---
import Layout from '../../layouts/Layout.astro';
import AdminLogin from '../../components/AdminLogin.astro';
import ConfirmModal from '../../components/ConfirmModal.astro';
import PartialPaymentModal from '../../components/PartialPaymentModal.astro';
---

<Layout title="تفاصيل العقد">
    <div id="auth-loading-message" class="auth-container">
        <p>جارٍ التحقق من صلاحيات الدخول...</p>
    </div>

    <div id="admin-login-container" class="auth-container" style="display: none;">
      <AdminLogin />
    </div>

    <main id="page-content" style="display: none;">
        <div class="details-container">
            <div class="details-header">
                <h1 id="customer-name-header">تفاصيل العقد</h1>
                <div class="header-buttons">
                    <a id="edit-contract-btn" href="#" class="btn btn-warning">تعديل العقد</a>
                    <button id="delete-contract-btn" class="btn btn-danger">حذف العقد</button>
                    <a id="back-link" href="#" class="btn btn-secondary">&larr; العودة لقائمة العقود</a>
                </div>
            </div>

            <div id="loader">جاري تحميل البيانات...</div>
            <div id="error-display" class="message-card" style="display: none;">
                <h1>حدث خطأ</h1>
                <p id="error-message"></p>
            </div>

            <div id="contract-details-content" style="display: none;">
                <!-- Financial Summary -->
                <div class="summary-dashboard">
                    <div class="stat-card">
                        <h4>المبلغ الإجمالي للعقد</h4>
                        <p id="total-amount">0 ج.م.</p>
                    </div>
                    <div class="stat-card">
                        <h4 class="paid">إجمالي المدفوع</h4>
                        <p id="total-paid" class="paid">0 ج.م.</p>
                    </div>
                    <div class="stat-card">
                        <h4 class="remaining">المبلغ المتبقي</h4>
                        <p id="total-remaining" class="remaining">0 ج.م.</p>
                    </div>
                </div>

                <!-- Customer and Unit Info -->
                <div class="info-grid">
                    <div class="info-card">
                        <h3>بيانات العميل</h3>
                        <p><strong>الاسم:</strong> <span id="info-customer-name">-</span></p>
                        <p><strong>رقم الهاتف:</strong> <span id="info-customer-phone">-</span></p>
                    </div>
                    <div class="info-card">
                        <h3>بيانات الوحدة</h3>
                        <p><strong>نوع الوحدة:</strong> <span id="info-unit-type">-</span></p>
                        <p><strong>موقع/رقم الوحدة:</strong> <span id="info-unit-location">-</span></p>
                    </div>
                </div>

                <!-- Installments Table -->
                <div class="installments-section">
                    <h3>جدول الأقساط</h3>
                    <div class="table-responsive">
                        <table id="installments-table">
                            <thead>
                                <tr>
                                    <th>م.</th>
                                    <th>مبلغ القسط</th>
                                    <th>تاريخ الاستحقاق</th>
                                    <th>الحالة</th>
                                    <th>تاريخ الدفع</th>
                                    <th>بيان القسط</th>
                                    <th>إجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Rows will be inserted here dynamically -->
                            </tbody>
                        </table>
                    </div>
                    <p id="no-installments-message" class="message-card" style="display: none;">لا توجد أقساط مسجلة لهذا العقد.</p>
                </div>
            </div>
        </div>
    </main>
    
    <ConfirmModal />
    <PartialPaymentModal />

</Layout>

<style is:global>
    :root {
        --primary-color: #2c3e50;
        --secondary-color: #7f8c8d;
        --success-color: #27ae60;
        --warning-color: #f39c12;
        --danger-color: #c0392b;
        --info-color: #3498db;
        --light-bg: #f7f9fc;
        --white-bg: #ffffff;
        --border-color: #e0e0e0;
        --shadow: 0 4px 12px rgba(0,0,0,0.06);
        --green-bg: #e8f8ef;
        --yellow-bg: #fef9e7;
    }
    .auth-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; width: 100%; font-family: 'Cairo', sans-serif; }
    main#page-content { padding: 2rem 1rem; background-color: var(--light-bg); min-height: 100vh; direction: rtl; font-family: 'Cairo', sans-serif; }
    .details-container { width: 100%; max-width: 1200px; margin: 0 auto; }
    .details-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); }
    h1 { margin: 0; font-size: 2.2rem; color: var(--primary-color); }
    .header-buttons { display: flex; gap: 1rem; }
    .btn { padding: 0.7rem 1.4rem; border-radius: 8px; text-decoration: none; border: none; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
    .btn-sm { font-size: 0.8rem; padding: 0.4rem 0.8rem; }
    .actions-cell { display: flex; flex-direction: column; gap: 0.5rem; justify-content: center; }
    .btn-secondary { background-color: var(--secondary-color); color: white; }
    .btn-secondary:hover { background-color: #6a7374; }
    .btn-danger { background-color: var(--danger-color); color: white; }
    .btn-danger:hover { background-color: #a93226; }
    .btn-warning { background-color: var(--warning-color); color: white; }
    .btn-warning:hover { background-color: #d68910; }
    .btn-edit, .btn-save { font-size: 0.9rem; padding: 0.5rem 1rem; width: 100%; }
    .btn-edit { background-color: var(--info-color); color: white; }
    .btn-edit:hover { background-color: #2980b9; }
    .btn-save { background-color: var(--success-color); color: white; }
    .btn-save:hover { background-color: #219d52; }
    .btn-partial { background-color: var(--warning-color); color: white; width: 100%;}
    .btn-partial:hover { background-color: #d68910; }

    #loader, .message-card { text-align: center; padding: 3rem; margin-top: 2rem; background: var(--white-bg); border-radius: 10px; box-shadow: var(--shadow); color: var(--secondary-color); font-size: 1.2rem; }
    #error-display { color: var(--danger-color); border-left: 5px solid var(--danger-color); }

    .summary-dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
    .stat-card { background: var(--white-bg); padding: 1.5rem; border-radius: 10px; box-shadow: var(--shadow); }
    .stat-card h4 { margin: 0 0 0.5rem 0; font-size: 1rem; color: var(--secondary-color); font-weight: 600; }
    .stat-card p { margin: 0; font-size: 2rem; font-weight: 700; color: var(--primary-color); }
    .stat-card .paid { color: var(--success-color); }
    .stat-card .remaining { color: var(--danger-color); }

    .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2.5rem; }
    .info-card { background: var(--white-bg); padding: 1.5rem; border-radius: 10px; box-shadow: var(--shadow); }
    .info-card h3 { margin: 0 0 1rem 0; font-size: 1.2rem; color: var(--primary-color); border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; }
    .info-card p { margin: 0.5rem 0; font-size: 1rem; line-height: 1.6; }
    .info-card p span { color: var(--secondary-color); font-weight: 500; }

    .installments-section { background: var(--white-bg); padding: 2rem; border-radius: 10px; box-shadow: var(--shadow); }
    .installments-section h3 { margin: 0 0 1.5rem 0; font-size: 1.5rem; color: var(--primary-color); }
    .table-responsive { overflow-x: auto; }
    #installments-table { width: 100%; border-collapse: collapse; }
    #installments-table th, #installments-table td { padding: 1rem; text-align: right; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
    #installments-table th { font-size: 0.9rem; color: var(--secondary-color); text-transform: uppercase; }
    #installments-table td { font-size: 1rem; color: var(--primary-color); }
    #installments-table select, #installments-table .edit-input { padding: 0.5rem; border-radius: 6px; border: 1px solid var(--border-color); font-family: 'Cairo', sans-serif; width: 100%; box-sizing: border-box; }
    #installments-table tr.status-paid { background-color: var(--green-bg); }
    #installments-table tr.status-pending { background-color: var(--yellow-bg); }

</style>

<script>
    import { auth, db } from '../../firebase/client';
    import { onAuthStateChanged } from "firebase/auth";
    import { doc, collection, query, where, getDocs, writeBatch, Timestamp, updateDoc, addDoc } from 'firebase/firestore';

    let currentProjectId = null;
    let currentCustomerName = null;
    let allInstallments = [];

    document.addEventListener('DOMContentLoaded', () => {
        const table = document.getElementById('installments-table');
        
        table.addEventListener('change', (e) => {
            if (e.target && e.target.classList.contains('status-select')) {
                handleStatusChange(e.target);
            }
        });

        table.addEventListener('click', (e) => {
            const target = e.target;
            if (target && (target.classList.contains('btn-edit') || target.classList.contains('btn-save'))) {
                handleEditToggle(target);
            } else if (target && target.classList.contains('btn-partial')) {
                handlePartialPayment(target);
            }
        });

        const deleteBtn = document.getElementById('delete-contract-btn');
        if(deleteBtn) {
            deleteBtn.addEventListener('click', handleDeleteContract);
        }

        onAuthStateChanged(auth, async (user) => {
            const authLoadingMessage = document.getElementById('auth-loading-message');
            const loginContainer = document.getElementById('admin-login-container');
            const pageContent = document.getElementById('page-content');
            authLoadingMessage.style.display = 'none';
            if (user) {
                pageContent.style.display = 'block';
                loginContainer.style.display = 'none';
                initializeApp();
            } else {
                loginContainer.style.display = 'block';
                pageContent.style.display = 'none';
            }
        });
    });

    async function initializeApp() {
        const loader = document.getElementById('loader');
        const content = document.getElementById('contract-details-content');
        const errorDisplay = document.getElementById('error-display');
        const errorMessage = document.getElementById('error-message');

        const urlParams = new URLSearchParams(window.location.search);
        currentProjectId = urlParams.get('projectId');
        currentCustomerName = urlParams.get('customerName');

        document.getElementById('back-link').href = `/admin/project-installments?projectId=${currentProjectId}`;
        document.getElementById('edit-contract-btn').href = `/admin/edit-contract?projectId=${currentProjectId}&customerName=${encodeURIComponent(currentCustomerName)}`;

        if (!currentProjectId || !currentCustomerName) {
            loader.style.display = 'none';
            errorMessage.textContent = 'بيانات المشروع أو العميل غير متوفرة.';
            errorDisplay.style.display = 'block';
            return;
        }

        loader.style.display = 'block';
        content.style.display = 'none';

        try {
            const q = query(collection(db, 'installments'), where('projectId', '==', currentProjectId), where('customerName', '==', currentCustomerName));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                loader.style.display = 'none';
                errorMessage.textContent = 'لم يتم العثور على أقساط لهذا العقد.';
                errorDisplay.style.display = 'block';
                return;
            }

            allInstallments = querySnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            allInstallments.sort((a, b) => a.dueDate.toDate() - b.dueDate.toDate());
            
            renderContractInfo(allInstallments[0]);
            renderInstallmentsTable(allInstallments);
            calculateSummary(allInstallments, allInstallments[0].totalAmount);
            
            loader.style.display = 'none';
            content.style.display = 'block';

        } catch (error) {
            console.error("Error fetching details: ", error);
            loader.style.display = 'none';
            errorMessage.textContent = 'حدث خطأ أثناء تحميل التفاصيل.';
            errorDisplay.style.display = 'block';
        }
    }

    async function handlePartialPayment(button) {
        const installmentId = button.dataset.id;
        const installment = allInstallments.find(inst => inst.id === installmentId);

        if (!installment) return;

        const paidAmount = await window.showPartialPaymentModal(installmentId, installment.installmentAmount);

        if (paidAmount && paidAmount > 0 && paidAmount < installment.installmentAmount) {
            const remainingAmount = installment.installmentAmount - paidAmount;

            const confirmationMessage = `سيتم تقسيم القسط إلى: 
- قسط مدفوع بقيمة: ${formatCurrency(paidAmount)} 
- قسط جديد مستحق بقيمة: ${formatCurrency(remainingAmount)}. هل أنت متأكد؟`;

            const confirmed = await window.showConfirmationModal(confirmationMessage);

            if (confirmed) {
                try {
                    const batch = writeBatch(db);

                    // 1. Update original installment to be the paid part
                    const originalInstallmentRef = doc(db, 'installments', installmentId);
                    batch.update(originalInstallmentRef, {
                        installmentAmount: paidAmount,
                        status: 'paid',
                        paymentDate: Timestamp.now()
                    });

                    // 2. Create new installment for the remaining part
                    const newInstallmentRef = doc(collection(db, 'installments'));
                    batch.set(newInstallmentRef, {
                        ...installment, // Copy all original data
                        installmentAmount: remainingAmount,
                        installmentName: `بقية - ${installment.installmentName || 'القسط'}`,
                        status: 'pending',
                        paymentDate: null, // Ensure new part is not marked as paid
                        // dueDate remains the same as the original
                    });

                    await batch.commit();
                    initializeApp(); // Refresh view

                } catch (error) {
                    console.error("Error during partial payment: ", error);
                    alert("حدث خطأ أثناء عملية السداد الجزئي.");
                }
            }
        }
    }

    async function handleStatusChange(selectElement) {
        // ... (code unchanged)
        const id = selectElement.dataset.id;
        const newStatus = selectElement.value;
        const oldStatus = selectElement.dataset.currentStatus;

        if (newStatus === oldStatus) return;
        
        const newStatusText = newStatus === 'paid' ? 'مدفوع' : 'مستحق';
        const confirmationMessage = `هل أنت متأكد من تغيير حالة القسط إلى "${newStatusText}"؟`;

        const confirmed = await window.showConfirmationModal(confirmationMessage);

        if (confirmed) {
            const installmentRef = doc(db, 'installments', id);
            const updateData = { status: newStatus, paymentDate: newStatus === 'paid' ? Timestamp.now() : null };
            try {
                await updateDoc(installmentRef, updateData);
                initializeApp();
            } catch (error) {
                console.error("Error updating status: ", error);
                alert("فشل تحديث الحالة.");
                selectElement.value = oldStatus;
            }
        } else {
            selectElement.value = oldStatus;
        }
    }

    function handleEditToggle(button) {
        // ... (code unchanged)
        const row = button.closest('tr');
        const isEditing = row.classList.contains('is-editing');

        if (isEditing) {
            saveInstallmentChanges(row, button);
        } else {
            enterEditMode(row, button);
        }
    }

    function enterEditMode(row, button) {
        // ... (code unchanged)
        row.classList.add('is-editing');
        button.textContent = 'حفظ';
        button.classList.remove('btn-edit');
        button.classList.add('btn-save');

        const amountCell = row.querySelector('td[data-field="amount"]');
        const dateCell = row.querySelector('td[data-field="dueDate"]');

        const currentAmount = amountCell.dataset.originalValue;
        const currentDate = dateCell.dataset.originalValue;

        amountCell.innerHTML = `<input type="number" class="edit-input" value="${currentAmount}">`;
        dateCell.innerHTML = `<input type="date" class="edit-input" value="${currentDate}">`;
    }

    async function saveInstallmentChanges(row, button) {
        // ... (code unchanged)
        const installmentId = button.dataset.id;
        const amountInput = row.querySelector('td[data-field="amount"] input');
        const dateInput = row.querySelector('td[data-field="dueDate"] input');

        const newAmount = parseFloat(amountInput.value);
        const newDate = dateInput.value;

        if (isNaN(newAmount) || newAmount <= 0 || !newDate) {
            alert('الرجاء إدخال مبلغ وتاريخ صحيحين.');
            return;
        }

        const confirmed = await window.showConfirmationModal('هل أنت متأكد من حفظ هذه التغييرات؟');

        if (confirmed) {
            button.disabled = true;
            button.textContent = 'جارٍ الحفظ...';
            const installmentRef = doc(db, 'installments', installmentId);
            const updateData = {
                installmentAmount: newAmount,
                dueDate: Timestamp.fromDate(new Date(newDate))
            };

            try {
                await updateDoc(installmentRef, updateData);
                initializeApp();
            } catch (error) {
                console.error("Error saving changes: ", error);
                alert('فشل حفظ التغييرات.');
                button.disabled = false;
                button.textContent = 'حفظ';
            }
        }
    }

    async function handleDeleteContract() {
        // ... (code unchanged)
        const confirmed = await window.showConfirmationModal(`هل أنت متأكد من حذف هذا العقد بالكامل؟ سيتم حذف جميع الأقساط المرتبطة به. لا يمكن التراجع عن هذا الإجراء.`);
        if (confirmed) {
            // ... delete logic ...
        }
    }

    const formatCurrency = (num) => (num || 0).toLocaleString('ar-EG', { style: 'currency', currency: 'EGP' });
    const formatDate = (timestamp, format = 'long') => {
        if (!timestamp) return '-';
        const date = timestamp.toDate();
        if (format === 'yyyy-mm-dd') {
            return date.toISOString().split('T')[0];
        }
        return date.toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' });
    };
    const unitTypeTranslations = { apartment: 'شقة', shop: 'محل', basement: 'بدروم', other: 'أخرى' };

    function renderContractInfo(data) {
        // ... (code unchanged)
        document.getElementById('customer-name-header').textContent = `تفاصيل عقد: ${data.customerName}`;
        document.getElementById('info-customer-name').textContent = data.customerName || '-';
        document.getElementById('info-customer-phone').textContent = data.customerPhone || '-';
        document.getElementById('info-unit-type').textContent = unitTypeTranslations[data.unitType] || data.unitType || '-';
        document.getElementById('info-unit-location').textContent = data.unitLocation || '-';
    }

    function calculateSummary(installments, totalAmount) {
        // ... (code unchanged)
        const totalPaid = installments
            .filter(inst => inst.status === 'paid' && inst.installmentAmount)
            .reduce((sum, inst) => sum + inst.installmentAmount, 0);
        const totalRemaining = totalAmount - totalPaid;
        document.getElementById('total-amount').textContent = formatCurrency(totalAmount);
        document.getElementById('total-paid').textContent = formatCurrency(totalPaid);
        document.getElementById('total-remaining').textContent = formatCurrency(totalRemaining);
    }

    function renderInstallmentsTable(installments) {
        const tableBody = document.querySelector('#installments-table tbody');
        tableBody.innerHTML = '';
        if (!installments || installments.length === 0) {
             document.getElementById('no-installments-message').style.display = 'block';
            return;
        }

        installments.forEach((inst, index) => {
            const row = document.createElement('tr');
            const isPaid = inst.status === 'paid';

            row.className = isPaid ? 'status-paid' : 'status-pending';
            
            const statusSelect = `
                <select class="status-select" data-id="${inst.id}" data-current-status="${inst.status}">
                    <option value="pending" ${!isPaid ? 'selected' : ''}>مستحق</option>
                    <option value="paid" ${isPaid ? 'selected' : ''}>مدفوع</option>
                </select>
            `;

            const amountForInput = inst.installmentAmount || 0;
            const dateForInput = formatDate(inst.dueDate, 'yyyy-mm-dd');

            let actionsCell = `<button class="btn btn-edit btn-sm" data-id="${inst.id}">تعديل</button>`;
            if (!isPaid) {
                actionsCell += `<button class="btn btn-partial btn-sm" data-id="${inst.id}">سداد جزئي</button>`;
            }

            row.innerHTML = `
                <td>${index + 1}</td>
                <td data-field="amount" data-original-value="${amountForInput}">${formatCurrency(inst.installmentAmount)}</td>
                <td data-field="dueDate" data-original-value="${dateForInput}">${formatDate(inst.dueDate)}</td>
                <td>${statusSelect}</td>
                <td>${formatDate(inst.paymentDate)}</td>
                <td>${inst.installmentName}</td>
                <td class="actions-cell">${actionsCell}</td>
            `;
            tableBody.appendChild(row);
        });
    }

</script>
