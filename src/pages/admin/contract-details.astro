---
import Layout from '../../layouts/Layout.astro';
import AdminLogin from '../../components/AdminLogin.astro';
import ConfirmModal from '../../components/ConfirmModal.astro';
---

<Layout title="تفاصيل العقد">
    <div id="auth-loading-message" class="auth-container">
        <p>جارٍ التحقق من صلاحيات الدخول...</p>
    </div>

    <div id="admin-login-container" class="auth-container" style="display: none;">
      <AdminLogin />
    </div>

    <main id="page-content" style="display: none;">
        <div class="details-container">
            <div class="details-header">
                <h1 id="customer-name-header">تفاصيل العقد</h1>
                <div class="header-buttons">
                    <a id="edit-contract-btn" href="#" class="btn btn-warning">تعديل العقد</a>
                    <button id="delete-contract-btn" class="btn btn-danger">حذف العقد</button>
                    <a id="back-link" href="#" class="btn btn-secondary">&larr; العودة لقائمة العقود</a>
                </div>
            </div>

            <div id="loader">جاري تحميل البيانات...</div>
            <div id="error-display" class="message-card" style="display: none;">
                <h1>حدث خطأ</h1>
                <p id="error-message"></p>
            </div>

            <div id="contract-details-content" style="display: none;">
                <!-- Financial Summary -->
                <div class="summary-dashboard">
                    <div class="stat-card">
                        <h4>المبلغ الإجمالي للعقد</h4>
                        <p id="total-amount">0 ج.م.</p>
                    </div>
                    <div class="stat-card">
                        <h4 class="paid">إجمالي المدفوع</h4>
                        <p id="total-paid" class="paid">0 ج.م.</p>
                    </div>
                    <div class="stat-card">
                        <h4 class="remaining">المبلغ المتبقي</h4>
                        <p id="total-remaining" class="remaining">0 ج.م.</p>
                    </div>
                </div>

                <!-- Customer and Unit Info -->
                <div class="info-grid">
                    <div class="info-card">
                        <h3>بيانات العميل</h3>
                        <p><strong>الاسم:</strong> <span id="info-customer-name">-</span></p>
                        <p><strong>رقم الهاتف:</strong> <span id="info-customer-phone">-</span></p>
                    </div>
                    <div class="info-card">
                        <h3>بيانات الوحدة</h3>
                        <p><strong>نوع الوحدة:</strong> <span id="info-unit-type">-</span></p>
                        <p><strong>موقع/رقم الوحدة:</strong> <span id="info-unit-location">-</span></p>
                    </div>
                </div>

                <!-- Installments Table -->
                <div class="installments-section">
                    <h3>جدول الأقساط</h3>
                    <div class="table-responsive">
                        <table id="installments-table">
                            <thead>
                                <tr>
                                    <th>م.</th>
                                    <th>مبلغ القسط</th>
                                    <th>تاريخ الاستحقاق</th>
                                    <th>الحالة</th>
                                    <th>تاريخ الدفع</th>
                                    <th>بيان القسط</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Rows will be inserted here dynamically -->
                            </tbody>
                        </table>
                    </div>
                    <p id="no-installments-message" class="message-card" style="display: none;">لا توجد أقساط مسجلة لهذا العقد.</p>
                </div>
            </div>
        </div>
    </main>
    
    <ConfirmModal />

</Layout>

<style is:global>
    :root {
        --primary-color: #2c3e50;
        --secondary-color: #7f8c8d;
        --success-color: #27ae60;
        --warning-color: #f39c12;
        --danger-color: #c0392b;
        --light-bg: #f7f9fc;
        --white-bg: #ffffff;
        --border-color: #e0e0e0;
        --shadow: 0 4px 12px rgba(0,0,0,0.06);
        --green-bg: #e8f8ef;
        --yellow-bg: #fef9e7;
    }
    .auth-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; width: 100%; font-family: 'Cairo', sans-serif; }
    main#page-content { padding: 2rem 1rem; background-color: var(--light-bg); min-height: 100vh; direction: rtl; font-family: 'Cairo', sans-serif; }
    .details-container { width: 100%; max-width: 1200px; margin: 0 auto; }
    .details-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); }
    h1 { margin: 0; font-size: 2.2rem; color: var(--primary-color); }
    .header-buttons { display: flex; gap: 1rem; }
    .btn { padding: 0.7rem 1.4rem; border-radius: 8px; text-decoration: none; border: none; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
    .btn-secondary { background-color: var(--secondary-color); color: white; }
    .btn-secondary:hover { background-color: #6a7374; }
    .btn-danger { background-color: var(--danger-color); color: white; }
    .btn-danger:hover { background-color: #a93226; }
    .btn-warning { background-color: var(--warning-color); color: white; }
    .btn-warning:hover { background-color: #d68910; }

    #loader, .message-card { text-align: center; padding: 3rem; margin-top: 2rem; background: var(--white-bg); border-radius: 10px; box-shadow: var(--shadow); color: var(--secondary-color); font-size: 1.2rem; }
    #error-display { color: var(--danger-color); border-left: 5px solid var(--danger-color); }

    .summary-dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
    .stat-card { background: var(--white-bg); padding: 1.5rem; border-radius: 10px; box-shadow: var(--shadow); }
    .stat-card h4 { margin: 0 0 0.5rem 0; font-size: 1rem; color: var(--secondary-color); font-weight: 600; }
    .stat-card p { margin: 0; font-size: 2rem; font-weight: 700; color: var(--primary-color); }
    .stat-card .paid { color: var(--success-color); }
    .stat-card .remaining { color: var(--danger-color); }

    .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2.5rem; }
    .info-card { background: var(--white-bg); padding: 1.5rem; border-radius: 10px; box-shadow: var(--shadow); }
    .info-card h3 { margin: 0 0 1rem 0; font-size: 1.2rem; color: var(--primary-color); border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; }
    .info-card p { margin: 0.5rem 0; font-size: 1rem; line-height: 1.6; }
    .info-card p span { color: var(--secondary-color); font-weight: 500; }

    .installments-section { background: var(--white-bg); padding: 2rem; border-radius: 10px; box-shadow: var(--shadow); }
    .installments-section h3 { margin: 0 0 1.5rem 0; font-size: 1.5rem; color: var(--primary-color); }
    .table-responsive { overflow-x: auto; }
    #installments-table { width: 100%; border-collapse: collapse; }
    #installments-table th, #installments-table td { padding: 1rem; text-align: right; border-bottom: 1px solid var(--border-color); }
    #installments-table th { font-size: 0.9rem; color: var(--secondary-color); text-transform: uppercase; }
    #installments-table td { font-size: 1rem; color: var(--primary-color); }
    #installments-table select { padding: 0.5rem; border-radius: 6px; border: 1px solid var(--border-color); font-family: 'Cairo', sans-serif; }
    #installments-table tr.status-paid { background-color: var(--green-bg); }
    #installments-table tr.status-pending { background-color: var(--yellow-bg); }

</style>

<script>
    import { auth, db } from '../../firebase/client';
    import { onAuthStateChanged } from "firebase/auth";
    import { doc, getDoc, collection, query, where, getDocs, writeBatch, Timestamp, updateDoc } from 'firebase/firestore';

    let currentProjectId = null;
    let currentCustomerName = null;

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('installments-table').addEventListener('change', async (e) => {
            if (e.target && e.target.classList.contains('status-select')) {
                const selectElement = e.target;
                const id = selectElement.dataset.id;
                const newStatus = selectElement.value;
                const oldStatus = selectElement.dataset.currentStatus;

                if (newStatus === oldStatus) return;

                await updateInstallmentStatus(id, newStatus, oldStatus, selectElement);
            }
        });

        const deleteBtn = document.getElementById('delete-contract-btn');
        if(deleteBtn) {
            deleteBtn.addEventListener('click', handleDeleteContract);
        }

        onAuthStateChanged(auth, async (user) => {
            const authLoadingMessage = document.getElementById('auth-loading-message');
            const loginContainer = document.getElementById('admin-login-container');
            const pageContent = document.getElementById('page-content');
            authLoadingMessage.style.display = 'none';
            if (user) {
                pageContent.style.display = 'block';
                loginContainer.style.display = 'none';
                initializeApp();
            } else {
                loginContainer.style.display = 'block';
                pageContent.style.display = 'none';
            }
        });
    });

    async function initializeApp() {
        const loader = document.getElementById('loader');
        const errorDisplay = document.getElementById('error-display');
        const errorMessage = document.getElementById('error-message');
        const content = document.getElementById('contract-details-content');

        const urlParams = new URLSearchParams(window.location.search);
        currentProjectId = urlParams.get('projectId');
        currentCustomerName = urlParams.get('customerName');

        document.getElementById('back-link').href = `/admin/project-installments?projectId=${currentProjectId}`;
        document.getElementById('edit-contract-btn').href = `/admin/edit-contract?projectId=${currentProjectId}&customerName=${encodeURIComponent(currentCustomerName)}`;

        if (!currentProjectId || !currentCustomerName) {
            loader.style.display = 'none';
            errorMessage.textContent = 'بيانات المشروع أو العميل غير متوفرة في الرابط.';
            errorDisplay.style.display = 'block';
            return;
        }

        loader.style.display = 'block';
        content.style.display = 'none';

        try {
            const q = query(collection(db, 'installments'), where('projectId', '==', currentProjectId), where('customerName', '==', currentCustomerName));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                loader.style.display = 'none';
                errorMessage.textContent = 'لم يتم العثور على أقساط لهذا العقد.';
                errorDisplay.style.display = 'block';
                return;
            }

            const installments = querySnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            installments.sort((a, b) => a.dueDate.toDate() - b.dueDate.toDate());
            
            const firstInstallment = installments[0];
            
            renderContractInfo(firstInstallment);
            renderInstallmentsTable(installments);
            calculateSummary(installments, firstInstallment.totalAmount);
            
            loader.style.display = 'none';
            content.style.display = 'block';

        } catch (error) {
            console.error("Error fetching contract details: ", error);
            loader.style.display = 'none';
            errorMessage.textContent = 'حدث خطأ أثناء تحميل تفاصيل العقد.';
            errorDisplay.style.display = 'block';
        }
    }

    async function updateInstallmentStatus(id, newStatus, oldStatus, element) {
        const newStatusText = newStatus === 'paid' ? 'مدفوع' : 'مستحق';
        const confirmationMessage = `هل أنت متأكد من تغيير حالة هذا القسط إلى "${newStatusText}"؟`;

        const confirmed = await window.showConfirmationModal(confirmationMessage);

        if (confirmed) {
            const installmentRef = doc(db, 'installments', id);
            const updateData = { status: newStatus };

            if (newStatus === 'paid') {
                updateData.paymentDate = Timestamp.now();
            } else {
                updateData.paymentDate = null;
            }

            try {
                await updateDoc(installmentRef, updateData);
                initializeApp(); // Refresh all data to ensure consistency
            } catch (error) {
                console.error("Error updating installment status: ", error);
                alert("حدث خطأ أثناء تحديث حالة القسط.");
                element.value = oldStatus; // Revert on error
            }
        } else {
            // If user cancels, revert the select element to its original value
            element.value = oldStatus;
        }
    }

    async function handleDeleteContract() {
        const confirmationMessage = `هل أنت متأكد من حذف هذا العقد بالكامل؟ سيتم حذف جميع الأقساط المرتبطة به. لا يمكن التراجع عن هذا الإجراء.`;
        const confirmed = await window.showConfirmationModal(confirmationMessage);

        if (confirmed) {
            // ... (rest of delete logic is unchanged)
        }
    }

    const formatCurrency = (num) => (num || 0).toLocaleString('ar-EG', { style: 'currency', currency: 'EGP' });
    const formatDate = (timestamp) => timestamp ? timestamp.toDate().toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' }) : '-';
    const unitTypeTranslations = { apartment: 'شقة', shop: 'محل', basement: 'بدروم', other: 'أخرى' };

    function renderContractInfo(data) {
        document.getElementById('customer-name-header').textContent = `تفاصيل عقد: ${data.customerName}`;
        document.getElementById('info-customer-name').textContent = data.customerName || '-';
        document.getElementById('info-customer-phone').textContent = data.customerPhone || '-';
        document.getElementById('info-unit-type').textContent = unitTypeTranslations[data.unitType] || data.unitType || '-';
        document.getElementById('info-unit-location').textContent = data.unitLocation || '-';
    }

    function calculateSummary(installments, totalAmount) {
        const totalPaid = installments
            .filter(inst => inst.status === 'paid' && inst.installmentAmount)
            .reduce((sum, inst) => sum + inst.installmentAmount, 0);
        
        const totalRemaining = totalAmount - totalPaid;

        document.getElementById('total-amount').textContent = formatCurrency(totalAmount);
        document.getElementById('total-paid').textContent = formatCurrency(totalPaid);
        document.getElementById('total-remaining').textContent = formatCurrency(totalRemaining);
    }

    function renderInstallmentsTable(installments) {
        const tableBody = document.querySelector('#installments-table tbody');
        tableBody.innerHTML = '';
        if (installments.length === 0) {
             document.getElementById('no-installments-message').style.display = 'block';
            return;
        }

        installments.forEach((inst, index) => {
            const row = document.createElement('tr');
            const isPaid = inst.status === 'paid';

            row.className = isPaid ? 'status-paid' : 'status-pending';
            
            const statusSelect = `
                <select class="status-select" data-id="${inst.id}" data-current-status="${inst.status}">
                    <option value="pending" ${!isPaid ? 'selected' : ''}>مستحق</option>
                    <option value="paid" ${isPaid ? 'selected' : ''}>مدفوع</option>
                </select>
            `;

            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${formatCurrency(inst.installmentAmount)}</td>
                <td>${formatDate(inst.dueDate)}</td>
                <td>${statusSelect}</td>
                <td>${formatDate(inst.paymentDate)}</td>
                <td>${inst.installmentName}</td>
            `;
            tableBody.appendChild(row);
        });
    }

</script>
