---
import Layout from '../../layouts/Layout.astro';
import AdminLogin from '../../components/AdminLogin.astro';
---

<Layout title="أقساط العقد">
  <div id="auth-loading-message" class="auth-container">
    <p>جارٍ التحقق من صلاحيات الدخول...</p>
  </div>

  <div id="admin-login-container" class="auth-container" style="display: none;">
    <AdminLogin />
  </div>

  <main id="page-content" style="display: none;">
    <div class="details-container">
        <div class="details-header">
            <h1>أقساط العقد</h1>
            <a id="back-link" href="#" class="btn btn-secondary">&larr; العودة لعقود المشروع</a>
        </div>
        <p>هنا سيتم عرض أقساط العقد المحدد.</p>
        <!-- محتوى أقساط العقد هيتحط هنا -->
    </div>
  </main>
</Layout>

<style>
    .auth-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; width: 100%; font-family: 'Cairo', sans-serif; }
    main#page-content { padding: 2rem; background-color: #f7f9fc; min-height: 100vh; direction: rtl; font-family: 'Cairo', sans-serif; }
    .details-container { width: 100%; max-width: 900px; margin: 0 auto; }
    .details-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
    h1 { margin: 0; font-size: 2.2rem; color: #2c3e50; }
    .btn { padding: 0.7rem 1.4rem; border-radius: 8px; text-decoration: none; border: none; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
    .btn-secondary { background-color: #6c757d; color: white; }
    .btn-secondary:hover { background-color: #5a6268; }
</style>

<script>
    import { auth, db } from '../../firebase/client';
    import { onAuthStateChanged } from "firebase/auth";
    import { doc, getDoc } from 'firebase/firestore';

    document.addEventListener('DOMContentLoaded', () => {
        const authLoadingMessage = document.getElementById('auth-loading-message');
        const loginContainer = document.getElementById('admin-login-container');
        const pageContent = document.getElementById('page-content');

        onAuthStateChanged(auth, async (user) => {
            if(authLoadingMessage) authLoadingMessage.style.display = 'none';
            if (user) {
                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists() && userDoc.data().role === 'admin') {
                        pageContent.style.display = 'block';
                        loginContainer.style.display = 'none';
                        initializePage();
                    } else {
                        await auth.signOut();
                        loginContainer.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Auth Check Error:', error);
                    await auth.signOut();
                    loginContainer.style.display = 'block';
                }
            } else {
                loginContainer.style.display = 'none';
                pageContent.style.display = 'none';
            }
        });
    });

    function initializePage() {
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('projectId');
        const backLink = document.getElementById('back-link');
        if (projectId) {
            backLink.href = `/admin/project-installments?projectId=${projectId}`;
        }
        // أي كود تاني هنحتاجه للصفحة دي هيتحط هنا
    }
</script>
