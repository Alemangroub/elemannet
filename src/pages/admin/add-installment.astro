---
import Layout from '../../layouts/Layout.astro';
import AdminLogin from '../../components/AdminLogin.astro';
--- 

<Layout title="إضافة عقد جديد">
  <div id="auth-loading-message" class="auth-container">
    <p>جارٍ التحقق من صلاحيات الدخول...</p>
  </div>

  <div id="admin-login-container" class="auth-container" style="display: none;">
    <AdminLogin />
  </div>

  <main id="page-content" class="add-installment-page" style="display: none;">
    <div class="container">
        <div class="page-header">
            <h1 id="project-name">إضافة عقد جديد للمشروع: </h1>
             <div class="header-actions">
                <a id="back-to-installments" href="#" class="btn btn-secondary">العودة إلى العقود</a>
            </div>
        </div>

        <div id="add-installment-form-container">
            <form id="add-installment-form">
                <div class="form-section-title">بيانات العقد الأساسية</div>
                <div class="grid-2-col">
                    <div class="form-group">
                        <label for="unitType">نوع الوحدة</label>
                        <select id="unitType" name="unitType" required>
                            <option value="" disabled selected>اختر نوع الوحدة</option>
                            <option value="apartment">شقة</option>
                            <option value="shop">محل</option>
                            <option value="basement">بدروم</option>
                            <option value="other">أخرى</option>
                        </select>
                    </div>
                     <div class="form-group">
                        <label for="unitLocation">موقع الوحدة</label>
                        <input type="text" id="unitLocation" name="unitLocation" required />
                    </div>
                    <div class="form-group">
                        <label for="customerName">اسم العميل</label>
                        <input type="text" id="customerName" name="customerName" required />
                    </div>
                    <div class="form-group">
                        <label for="customerPhone">رقم هاتف العميل</label>
                        <input type="tel" id="customerPhone" name="customerPhone" required />
                    </div>
                    <div class="form-group">
                        <label for="totalAmount">المبلغ الإجمالي (بالجنيه المصري)</label>
                        <input type="number" id="totalAmount" name="totalAmount" required />
                    </div>
                    <div class="form-group">
                        <label for="downPayment">الدفعة المقدمة (بالجنيه المصري)</label>
                        <input type="number" id="downPayment" name="downPayment" required />
                    </div>
                     <div class="form-group">
                        <label for="remainingPayment">الدفعة المتبقية (بالجنيه المصري)</label>
                        <input type="number" id="remainingPayment" name="remainingPayment" required />
                    </div>
                    <div class="form-group">
                        <label for="installmentsCount">عدد الاقساط</label>
                        <select id="installmentsCount" name="installmentsCount" required>
                            <option value="" disabled selected>اختر عدد الأقساط</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                        </select>
                    </div>
                </div>

                <!-- Container for dynamic installment fields -->
                <div id="installments-details-container"></div>

                <div class="form-actions">
                     <button type="submit" class="btn btn-primary" id="submit-button">إضافة العقد والأقساط</button>
                </div>
                 <p id="success-message" class="message success-message" style="display:none;">تمت إضافة العقد والأقساط بنجاح!</p>
                 <p id="error-message" class="message error-message" style="display:none;"></p>
            </form>
        </div>
         <div id="error-display" class="error-container" style="display: none;">
            <h1 class="error-title">حدث خطأ</h1>
            <p id="error-text"></p>
            <a href="/admin/projects" class="btn btn-primary">العودة إلى لوحة التحكم</a>
        </div>
    </div>
  </main>
</Layout>

<style is:global>
    /* General Styles */
    .auth-container, .error-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; text-align: center; }
    .add-installment-page { padding: 3rem 1.5rem; background-color: #f4f7f6; min-height: 100vh; direction: rtl; font-family: 'Cairo', sans-serif; }
    .add-installment-page .container { max-width: 900px; margin: 0 auto; }

    /* Header */
    .add-installment-page .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; border-bottom: 1px solid #e0e0e0; padding-bottom: 1.5rem; }
    .add-installment-page .page-header h1 { font-size: 1.8rem; color: #333; font-weight: 800; }
    .add-installment-page .header-actions { display: flex; gap: 1rem; }

    /* Form Styles */
    .add-installment-page #add-installment-form-container { background: #fff; padding: 2.5rem; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    .add-installment-page .form-section-title { font-size: 1.5rem; font-weight: 700; color: #3f51b5; margin-bottom: 2rem; padding-bottom: 0.75rem; border-bottom: 2px solid #3f51b5; }
    .add-installment-page .grid-2-col { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;}
    .add-installment-page .form-group { margin-bottom: 0; }
    .add-installment-page .form-group label { display: block; margin-bottom: 0.7rem; font-weight: 600; color: #555; font-size: 0.95rem; }
    .add-installment-page .form-group input, .add-installment-page .form-group select { width: 100%; padding: 0.8rem 1rem; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem; transition: border-color 0.2s, box-shadow 0.2s; background-color: #fafafa; }
    .add-installment-page .form-group input:focus, .add-installment-page .form-group select:focus { border-color: #3f51b5; box-shadow: 0 0 0 3px rgba(63, 81, 181, 0.15); outline: none; background-color: #fff; }
    .add-installment-page input[readonly] { background-color: #e9ecef; cursor: not-allowed; }
    
    /* Installments Section */
    .add-installment-page #installments-details-container { margin-top: 2.5rem; }
    .add-installment-page .installments-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
    .add-installment-page .installment-card { background-color: #f9f9fb; padding: 1.5rem; border-radius: 12px; border: 1px solid #e8e8e8; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    .add-installment-page .installment-card h4 { margin: 0 0 1.5rem 0; padding-bottom: 1rem; border-bottom: 1px solid #ddd; font-size: 1.2rem; color: #3f51b5; text-align: right; font-weight: 700; }
    .add-installment-page .installment-fields-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; align-items: flex-start; }

    /* Messages & Buttons */
    .add-installment-page .message { text-align: center; padding: 1rem; margin-top: 1.5rem; border-radius: 8px; font-weight: 600; }
    .add-installment-page .success-message { background-color: #d4edda; color: #155724; }
    .add-installment-page .error-message { background-color: #f8d7da; color: #721c24; }
    .add-installment-page .btn { padding: 0.8rem 1.75rem; color: #fff; text-decoration: none; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: all 0.2s; }
    .add-installment-page .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    .add-installment-page .btn-primary { background-color: #3f51b5; }
    .add-installment-page .btn-primary:hover { background-color: #3645a3; }
    .add-installment-page .btn-secondary { background-color: #6c757d; }
    .add-installment-page .btn-secondary:hover { background-color: #5a6268; }
    .add-installment-page .form-actions { text-align: left; margin-top: 2.5rem; border-top: 1px solid #e0e0e0; padding-top: 2rem;}

</style>

<script>
    import { auth, db } from '../../firebase/client';
    import { onAuthStateChanged } from "firebase/auth";
    import { doc, getDoc, collection, writeBatch, serverTimestamp } from 'firebase/firestore';

    let projectId;

    document.addEventListener('DOMContentLoaded', () => {
        const authLoadingMessage = document.getElementById('auth-loading-message');
        const loginContainer = document.getElementById('admin-login-container');
        const pageContent = document.getElementById('page-content');

        onAuthStateChanged(auth, async (user) => {
            authLoadingMessage.style.display = 'none';
            if (user) {
                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists() && userDoc.data().role === 'admin') {
                        pageContent.style.display = 'block';
                        loginContainer.style.display = 'none';
                        initializeApp();
                    } else {
                        loginContainer.style.display = 'block';
                        pageContent.style.display = 'none';
                        if(auth.currentUser) await auth.signOut();
                    }
                } catch (error) {
                    console.error("Auth check error:", error);
                    loginContainer.style.display = 'block';
                    pageContent.style.display = 'none';
                }
            } else {
                loginContainer.style.display = 'block';
                pageContent.style.display = 'none';
            }
        });
    });

    function initializeApp() {
        const urlParams = new URLSearchParams(window.location.search);
        projectId = urlParams.get('projectId');

        // ... (error handling for projectId)

        document.getElementById('back-to-installments').href = `/admin/project-installments?projectId=${projectId}`;

        getDoc(doc(db, 'projects', projectId)).then(projectSnap => {
            if (projectSnap.exists()) {
                const project = projectSnap.data();
                document.getElementById('project-name').textContent += project.projectName || 'غير مسمى';
            }
        });

        const installmentsCountSelect = document.getElementById('installmentsCount');
        installmentsCountSelect.addEventListener('change', generateInstallmentFields);
    }

    function generateInstallmentFields() {
        const count = parseInt(document.getElementById('installmentsCount').value, 10);
        const container = document.getElementById('installments-details-container');
        container.innerHTML = '';

        if (isNaN(count) || count <= 0) return;

        const title = document.createElement('div');
        title.className = 'form-section-title';
        title.textContent = 'تفاصيل الأقساط';
        container.appendChild(title);
        
        const grid = document.createElement('div');
        grid.className = 'installments-grid';
        container.appendChild(grid);

        for (let i = 1; i <= count; i++) {
            const card = document.createElement('div');
            card.className = 'installment-card';

            const cardTitle = document.createElement('h4');
            cardTitle.textContent = `القسط رقم ${i}`;
            card.appendChild(cardTitle);

            const fieldsContainer = document.createElement('div');
            fieldsContainer.className = 'installment-fields-container';
            card.appendChild(fieldsContainer);

            // Amount Field
            const amountGroup = document.createElement('div');
            amountGroup.className = 'form-group';
            amountGroup.innerHTML = `
                <label for="installment_amount_${i}">مبلغ القسط</label>
                <input type="number" id="installment_amount_${i}" name="installment_amount_${i}" required placeholder="مثال: 5000">
            `;
            fieldsContainer.appendChild(amountGroup);

            // --- Date Fields (New Structure) ---

            // Day Field
            const dayGroup = document.createElement('div');
            dayGroup.className = 'form-group';
            dayGroup.innerHTML = `
                <label for="installment_day_${i}">اليوم</label>
                <select id="installment_day_${i}" name="installment_day_${i}" required>
                    <option value="" disabled selected>اختر</option>
                    ${Array.from({length: 31}, (_, k) => `<option value="${k+1}">${k+1}</option>`).join('')}
                </select>
            `;
            fieldsContainer.appendChild(dayGroup);

            // Month Field
            const monthGroup = document.createElement('div');
            monthGroup.className = 'form-group';
            monthGroup.innerHTML = `
                <label for="installment_month_${i}">الشهر</label>
                <select id="installment_month_${i}" name="installment_month_${i}" required>
                    <option value="" disabled selected>اختر</option>
                    ${Array.from({length: 12}, (_, k) => `<option value="${k+1}">${k+1}</option>`).join('')}
                </select>
            `;
            fieldsContainer.appendChild(monthGroup);
            
            // Year Field
            const yearGroup = document.createElement('div');
            yearGroup.className = 'form-group';
            const startYear = 2026;
            const endYear = 2050;
            yearGroup.innerHTML = `
                <label for="installment_year_${i}">السنة</label>
                <select id="installment_year_${i}" name="installment_year_${i}" required>
                    <option value="" disabled selected>اختر</option>
                    ${Array.from({length: endYear - startYear + 1}, (_, k) => `<option value="${startYear + k}">${startYear + k}</option>`).join('')}
                </select>
            `;
            fieldsContainer.appendChild(yearGroup);

            // Status Field
            const statusGroup = document.createElement('div');
            statusGroup.className = 'form-group';
            statusGroup.innerHTML = `
                <label for="installment_status_${i}">الحالة</label>
                <select id="installment_status_${i}" name="installment_status_${i}">
                    <option value="due" selected>مستحق</option>
                    <option value="paid">مدفوع</option>
                </select>
            `;
            fieldsContainer.appendChild(statusGroup);
            
            grid.appendChild(card);
        }
    }

    const form = document.getElementById('add-installment-form');
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitButton = document.getElementById('submit-button');
        const successMessage = document.getElementById('success-message');
        const errorMessage = document.getElementById('error-message');

        submitButton.disabled = true;
        submitButton.textContent = 'جارٍ الحفظ...';
        successMessage.style.display = 'none';
        errorMessage.style.display = 'none';

        try {
            const installmentsCount = parseInt(form.installmentsCount.value, 10);
            const batch = writeBatch(db);

            const totalAmount = parseFloat(form.totalAmount.value);
            const downPayment = parseFloat(form.downPayment.value);
            const remainingPayment = parseFloat(form.remainingPayment.value);

            if (Math.abs(totalAmount - (downPayment + remainingPayment)) > 0.01) {
                throw new Error('المبلغ الإجمالي لا يساوي مجموع الدفعة المقدمة والدفعة المتبقية. الرجاء مراجعة الأرقام.');
            }

            const commonData = {
                projectId: projectId,
                unitType: form.unitType.value,
                unitLocation: form.unitLocation.value, // Added unitLocation
                customerName: form.customerName.value,
                customerPhone: form.customerPhone.value,
                totalAmount: totalAmount,
                downPayment: downPayment,
                totalInstallments: installmentsCount,
                createdAt: serverTimestamp()
            };

            let totalInstallmentsAmount = 0;

            for (let i = 1; i <= installmentsCount; i++) {
                const amount = parseFloat(document.getElementById(`installment_amount_${i}`).value);
                const day = parseInt(document.getElementById(`installment_day_${i}`).value, 10);
                const month = parseInt(document.getElementById(`installment_month_${i}`).value, 10);
                const year = parseInt(document.getElementById(`installment_year_${i}`).value, 10);
                const status = document.getElementById(`installment_status_${i}`).value;

                if (isNaN(amount) || amount <= 0 || !day || !month || !year) {
                    throw new Error(`الرجاء إدخال بيانات صالحة وكاملة للقسط رقم ${i}.`);
                }
                
                const dueDate = new Date(year, month - 1, day);

                if (isNaN(dueDate.getTime()) || dueDate.getDate() !== day || dueDate.getMonth() !== month - 1 || dueDate.getFullYear() !== year) {
                    throw new Error(`التاريخ الذي أدخلته غير صالح للقسط رقم ${i} (مثال: يوم 31 في شهر فبراير).`);
                }

                totalInstallmentsAmount += amount;

                const installmentRef = doc(collection(db, 'installments')); 
                batch.set(installmentRef, {
                    ...commonData,
                    installmentNumber: i,
                    amount: amount,
                    dueDate: dueDate,
                    status: status
                });
            }
            
            if (Math.abs(totalInstallmentsAmount - remainingPayment) > 0.01) {
                 throw new Error(`مجموع مبالغ الأقساط (${totalInstallmentsAmount.toFixed(2)}) لا يساوي الدفعة المتبقية التي أدخلتها (${remainingPayment.toFixed(2)}).`);
            }

            await batch.commit();

            successMessage.style.display = 'block';
            form.reset();
            document.getElementById('installments-details-container').innerHTML = '';
            setTimeout(() => {
                 window.location.href = `/admin/project-installments?projectId=${projectId}`;
            }, 2000);

        } catch (error) {
            console.error("Error adding installments: ", error);
            errorMessage.textContent = error.message || 'حدث خطأ غير متوقع أثناء إضافة العقد.';
            errorMessage.style.display = 'block';
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = 'إضافة العقد والأقساط';
        }
    });
</script>
