---
import Layout from '../../layouts/Layout.astro';
import AdminLogin from '../../components/AdminLogin.astro';
--- 

<Layout title="تعديل العقد">
    <div id="auth-loading-message" class="auth-container">
        <p>جارٍ التحقق من صلاحيات الدخول...</p>
    </div>

    <div id="admin-login-container" class="auth-container" style="display: none;">
        <AdminLogin />
    </div>

    <main id="page-content" style="display: none;">
        <div class="form-container">
            <div class="form-header">
                <h1>تعديل العقد</h1>
                <button id="logout-button" class="btn-logout">تسجيل الخروج</button>
            </div>
            <div id="loader">جاري تحميل بيانات العقد...</div>
            <form id="edit-contract-form" style="display: none;">
                <!-- Basic Contract Details -->
                <div class="input-group">
                    <label for="customerName">اسم العميل</label>
                    <input type="text" id="customerName" required />
                </div>
                <div class="input-group">
                    <label for="customerPhone">رقم موبايل العميل</label>
                    <input type="tel" id="customerPhone" required />
                </div>
                <div class="input-group">
                    <label for="unitType">نوع الوحدة</label>
                    <input type="text" id="unitType" required />
                </div>
                <div class="input-group">
                    <label for="unitLocation">موقع الوحدة</label>
                    <input type="text" id="unitLocation" required />
                </div>
                
                <!-- Financial Details -->
                <div class="input-group">
                    <label for="totalAmount">المبلغ الإجمالي</label>
                    <input type="number" id="totalAmount" required />
                </div>
                <div class="input-group">
                    <label for="installmentsCount">عدد الأقساط</label>
                    <select id="installmentsCount" required>
                        {[...Array(24).keys()].map(i => <option value={i + 1}>{i + 1}</option>)}
                    </select>
                </div>

                <!-- Installments Section -->
                <h2 class="installments-title">تفاصيل الأقساط</h2>
                <div id="paid-installments-info"></div>
                <div id="installments-container"></div>

                <!-- Actions -->
                <div class="form-actions">
                     <button type="submit" class="btn">حفظ التعديلات</button>
                     <a id="cancel-btn" href="#" class="btn btn-secondary">إلغاء</a>
                </div>
            </form>
        </div>
    </main>
</Layout>

<style>
    /* Auth and Logout Styles */
    .auth-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; width: 100%; font-family: 'Cairo', sans-serif; }
    .auth-container p { font-size: 1.2rem; }
    .btn-logout { background-color: #e74c3c; color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: background-color 0.2s; font-size: 0.9rem;}
    .btn-logout:hover { background-color: #c0392b; }
    .form-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
    .form-header h1 { margin: 0; }

    main#page-content { padding: 2rem; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; background-color: #f4f7f6; font-family: 'Cairo', sans-serif; direction: rtl; }
    .form-container { width: 100%; max-width: 600px; background: #fff; padding: 2.5rem; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin-top: 2rem; }
    h1, .installments-title { text-align: center; margin-bottom: 2rem; color: #333; }
    .installments-title { margin-top: 2.5rem; border-top: 1px solid #eee; padding-top: 2rem; }
    .input-group { margin-bottom: 1.5rem; }
    .installment-entry { border: 1px solid #e0e0e0; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; background-color: #fafafa; }
    .installment-header { font-weight: bold; margin-bottom: 1rem; color: #3f51b5; }
    #paid-installments-info { margin-bottom: 2rem; padding: 1rem; background-color: #e8f4fd; border-radius: 8px; color: #31708f; }
    label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555; }
    input, select { width: 100%; padding: 0.8rem 1rem; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem; font-family: inherit; }
    .form-actions { display: flex; gap: 1rem; margin-top: 2rem; }
    .btn { flex: 1; padding: 0.9rem; border: none; border-radius: 8px; color: white; font-size: 1.1rem; font-weight: 700; cursor: pointer; text-decoration: none; text-align: center; }
    .btn[type="submit"] { background-color: #3498db; }
    .btn-secondary { background-color: #6c757d; }
    #loader { text-align: center; padding: 4rem; font-size: 1.2rem; color: #7f8c8d; }
</style>

<script>
    import { auth, db } from '../../firebase/client';
    import { onAuthStateChanged, signOut } from "firebase/auth";
    import { doc, getDoc, collection, query, where, getDocs, writeBatch, orderBy } from 'firebase/firestore';

    document.addEventListener('DOMContentLoaded', () => {
        const authLoadingMessage = document.getElementById('auth-loading-message');
        const loginContainer = document.getElementById('admin-login-container');
        const pageContent = document.getElementById('page-content');

        onAuthStateChanged(auth, async (user) => {
            if(authLoadingMessage) authLoadingMessage.style.display = 'none';

            if (user) {
                try {
                    const userDocRef = doc(db, "users", user.uid);
                    const userDoc = await getDoc(userDocRef);

                    if (userDoc.exists() && userDoc.data().role === 'admin') {
                        if(pageContent) pageContent.style.display = 'flex'; // Changed to flex
                        if(loginContainer) loginContainer.style.display = 'none';

                        const logoutButton = document.getElementById('logout-button');
                        if (logoutButton) {
                            logoutButton.addEventListener('click', async () => {
                                await signOut(auth);
                                window.location.href = '/admin';
                            });
                        }
                        
                        initializePage();

                    } else {
                        await signOut(auth);
                        if(loginContainer) loginContainer.style.display = 'block';
                        if(pageContent) pageContent.style.display = 'none';
                    }
                } catch (error) {
                    console.error('Auth Check Error:', error);
                    await signOut(auth);
                    if(loginContainer) loginContainer.style.display = 'block';
                    if(pageContent) pageContent.style.display = 'none';
                }
            } else {
                if(pageContent) pageContent.style.display = 'none';
                if(loginContainer) loginContainer.style.display = 'block';
            }
        });
    });

    function initializePage() {
        const urlParams = new URLSearchParams(window.location.search);
        const contractId = urlParams.get('id');

        const loader = document.getElementById('loader');
        const form = document.getElementById('edit-contract-form');
        const installmentsContainer = document.getElementById('installments-container');
        const paidInstallmentsInfo = document.getElementById('paid-installments-info');
        const totalAmountInput = document.getElementById('totalAmount');
        const installmentsCountSelect = document.getElementById('installmentsCount');

        let paidInstallments = [];
        let originalUnpaidIds = [];
        let paidAmount = 0;

        const generateUnpaidFields = () => {
            installmentsContainer.innerHTML = '';
            const totalAmount = parseFloat(totalAmountInput.value) || 0;
            const totalCount = parseInt(installmentsCountSelect.value) || 0;

            const unpaidCount = totalCount - paidInstallments.length;
            if (unpaidCount < 0) {
                installmentsContainer.innerHTML = `<p style="color: red;">خطأ: لا يمكن أن يكون إجمالي عدد الأقساط أقل من عدد الأقساط المدفوعة (${paidInstallments.length}).</p>`;
                return;
            }

            const remainingAmount = totalAmount - paidAmount;
            const unpaidInstallmentAmount = (unpaidCount > 0) ? (remainingAmount / unpaidCount).toFixed(2) : 0;

            for (let i = 0; i < unpaidCount; i++) {
                const entry = document.createElement('div');
                entry.className = 'installment-entry';
                const dueDate = new Date();
                dueDate.setMonth(dueDate.getMonth() + paidInstallments.length + i);
                const formattedDueDate = dueDate.toISOString().split('T')[0];
                entry.innerHTML = `
                    <div class="installment-header">القسط المستحق رقم ${i + 1}</div>
                    <div class="input-group"><label>مبلغ القسط</label><input type="number" step="0.01" class="unpaid-amount" value="${unpaidInstallmentAmount > 0 ? unpaidInstallmentAmount : '0.00'}" required /></div>
                    <div class="input-group"><label>تاريخ الاستحقاق</label><input type="date" class="unpaid-duedate" value="${formattedDueDate}" required /></div>
                `;
                installmentsContainer.appendChild(entry);
            }
        };

        async function loadContractData() {
            if (!contractId) { loader.textContent = 'خطأ: لم يتم العثور على مُعرّف العقد.'; return; }
            document.getElementById('cancel-btn').href = `/admin/contract-details?id=${contractId}`;

            try {
                const contractRef = doc(db, 'contracts', contractId);
                const contractSnap = await getDoc(contractRef);
                if (!contractSnap.exists()) { loader.textContent = 'خطأ: العقد غير موجود.'; return; }

                const contract = contractSnap.data();
                form.customerName.value = contract.customerName;
                form.customerPhone.value = contract.customerPhone;
                form.unitType.value = contract.unitType;
                form.unitLocation.value = contract.unitLocation;
                form.totalAmount.value = contract.totalAmount;
                form.installmentsCount.value = contract.installmentsCount;

                const qInstallments = query(collection(db, 'installments'), where('contractId', '==', contractId), orderBy('dueDate', 'asc'));
                const installmentsSnapshot = await getDocs(qInstallments);
                
                installmentsSnapshot.forEach(instDoc => {
                    const data = instDoc.data();
                    if (data.status === 'paid') {
                        paidInstallments.push({ id: instDoc.id, ...data });
                        paidAmount += data.amount;
                    } else {
                        originalUnpaidIds.push(instDoc.id);
                    }
                });

                if (paidInstallments.length > 0) {
                    paidInstallmentsInfo.innerHTML = `لديك ${paidInstallments.length} قسط مدفوع بإجمالي ${paidAmount.toFixed(2)} ج.م. هذه الأقساط لن تتأثر بالتعديل.`;
                } else {
                    paidInstallmentsInfo.style.display = 'none';
                }
                
                generateUnpaidFields();

                loader.style.display = 'none';
                form.style.display = 'block';
            } catch (error) {
                console.error('Error loading contract:', error);
                loader.textContent = 'حدث خطأ أثناء تحميل البيانات.';
            }
        }

        totalAmountInput.addEventListener('input', generateUnpaidFields);
        installmentsCountSelect.addEventListener('change', generateUnpaidFields);

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!confirm('هل أنت متأكد؟ سيتم حذف جميع الأقساط \"غير المدفوعة\" الحالية واستبدالها بالجدول الجديد.')) return;

            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'جاري الحفظ...';

            try {
                const batch = writeBatch(db);
                
                originalUnpaidIds.forEach(id => batch.delete(doc(db, 'installments', id)));

                const newTotalAmount = parseFloat(totalAmountInput.value);
                const newInstallmentsCount = parseInt(installmentsCountSelect.value);

                const contractRef = doc(db, 'contracts', contractId);
                batch.update(contractRef, {
                    customerName: form.customerName.value,
                    customerPhone: form.customerPhone.value,
                    unitType: form.unitType.value,
                    unitLocation: form.unitLocation.value,
                    totalAmount: newTotalAmount,
                    installmentsCount: newInstallmentsCount,
                });
                
                const unpaidAmountInputs = form.querySelectorAll('.unpaid-amount');
                const unpaidDueDateInputs = form.querySelectorAll('.unpaid-duedate');

                let calculatedUnpaidTotal = 0;
                for (let i = 0; i < unpaidAmountInputs.length; i++) {
                    const amount = parseFloat(unpaidAmountInputs[i].value);
                    calculatedUnpaidTotal += amount;
                    const newInstallmentRef = doc(collection(db, 'installments'));
                    batch.set(newInstallmentRef, {
                        contractId: contractId,
                        customerName: form.customerName.value,
                        unitLocation: form.unitLocation.value,
                        amount: amount,
                        dueDate: unpaidDueDateInputs[i].value,
                        status: 'unpaid'
                    });
                }

                if (Math.abs(newTotalAmount - (paidAmount + calculatedUnpaidTotal)) > 0.01 * (unpaidAmountInputs.length || 1)) {
                    throw new Error('مجموع الأقساط المدفوعة والمستحقة الجديدة لا يساوي المبلغ الإجمالي للعقد.');
                }

                await batch.commit();
                alert('تم تحديث العقد بنجاح!');
                window.location.href = `/admin/contract-details?id=${contractId}`;

            } catch (error) {
                console.error("Error updating document: ", error);
                alert(`حدث خطأ أثناء التحديث: ${error.message}`);
                submitButton.disabled = false;
                submitButton.textContent = 'حفظ التعديلات';
            }
        });

        loadContractData();
    }
</script>
