---
import Layout from '../../../layouts/Layout.astro';
import { db } from "../../../firebase/admin";

// Fetches all project IDs at build time to pre-render the pages.
export async function getStaticPaths() {
    try {
        const projectsSnapshot = await db.collection('projects').get();
        if (projectsSnapshot.empty) {
            console.warn('⚠️ No projects found in Firestore. No project detail pages will be generated.');
            return [];
        }
        return projectsSnapshot.docs.map(doc => ({
            params: { id: doc.id },
            props: { project: { id: doc.id, ...doc.data() } }
        }));
    } catch (error) {
        console.error('❌ Error in getStaticPaths fetching projects:', error);
        return [];
    }
}

const { project } = Astro.props;

// Redirect to a 404 page if project data is missing.
if (!project) {
    return Astro.redirect('/admin/404');
}

// Ensure supervisors is an array, default to empty if it doesn't exist.
const supervisors = Array.isArray(project.supervisors) ? project.supervisors : [];
---

<Layout title={`تفاصيل مشروع: ${project.projectName}`}>
  <main class="project-details-page">
    <div class="container">

      <header class="page-header">
        <h1>{project.projectName || 'اسم المشروع غير متاح'}</h1>
        <a href="/admin/projects" class="btn btn-secondary">
          &larr; العودة إلى قائمة المشاريع
        </a>
      </header>

      <!-- Redesigned Details Box -->
      <div class="details-box">
        <!-- Project Address -->
        <div class="detail-row">
            <div class="detail-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"></path><circle cx="12" cy="10" r="3"></circle></svg>
            </div>
            <div class="detail-text">
                <span class="label">عنوان المشروع:</span>
                <span class="value">{project.projectAddress || 'غير محدد'}</span>
            </div>
        </div>

        <hr class="row-divider" />

        <!-- Supervisors -->
        <div class="detail-row">
            <div class="detail-icon">
                 <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
            </div>
            <div class="detail-text">
                <span class="label">المشرفون:</span>
                {supervisors.length > 0 ? (
                    <span class="value">{supervisors.map(s => s.name).join(', ')}</span>
                ) : (
                    <span class="value">لا يوجد</span>
                )}
            </div>
        </div>
      </div>

    </div>
  </main>
</Layout>

<style>
  .project-details-page { 
      direction: rtl; 
      font-family: 'Cairo', sans-serif; 
      background-color: #f4f7f6; 
      padding: 3rem 1.5rem; 
  }
  .container { 
      max-width: 1100px; 
      margin: 0 auto; 
      display: flex; /* Use flexbox */
      flex-direction: column; /* Stack children vertically */
      gap: 2rem; /* Create space between header and details box */
  }
  .page-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      padding-bottom: 1.5rem; 
      border-bottom: 2px solid #e2e8f0; 
      width: 100%;
  }
  .page-header h1 { font-size: 2.5rem; color: #1a202c; font-weight: 800; }
  .btn-secondary { display: inline-block; padding: 0.7rem 1.4rem; border-radius: 8px; text-decoration: none; font-size: 0.95rem; font-weight: 700; background-color: #6c757d; color: #fff; transition: all 0.3s ease; flex-shrink: 0; }
  .btn-secondary:hover { background-color: #5a6268; transform: translateY(-2px); }
  
  /* Details Box Styling */
  .details-box { 
    background-color: #fff; 
    border-radius: 12px; 
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); 
    padding: 1.5rem 2rem;
    border: 1px solid #e2e8f0;
    width: 100%; /* Ensure it takes full width of the container */
  }

  .detail-row { 
    display: flex; 
    align-items: center; 
    gap: 1.25rem; 
  }

  .detail-icon { 
    color: #3f51b5; 
    flex-shrink: 0; 
  }

  .detail-text {
    font-size: 1.05rem;
    color: #4a5568;
  }
  
  .detail-text .label {
    font-weight: 700;
    margin-left: 0.5rem;
  }

  .detail-text .value {
    font-weight: 500;
    color: #1a202c;
  }
  
  .row-divider {
      border: 0;
      height: 1px;
      background-color: #e8edf2;
      margin: 1rem 0;
  }
  
  @media (max-width: 768px) {
    .page-header { flex-direction: column; align-items: flex-start; gap: 1rem; text-align: right; }
    .details-box { padding: 1rem 1.5rem; }
    .detail-text { font-size: 1rem; }
  }
</style>