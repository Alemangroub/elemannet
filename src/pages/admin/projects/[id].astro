---
import Layout from '../../../layouts/Layout.astro';
import { db } from "../../../firebase/admin";

// Fetches all project and user data at build time.
export async function getStaticPaths() {
    try {
        const projectsSnapshot = await db.collection('projects').get();
        if (projectsSnapshot.empty) {
            console.warn('⚠️ No projects found. No pages will be generated.');
            return [];
        }

        // CORRECTED: Fetch from the 'users' collection.
        const usersSnapshot = await db.collection('users').get();
        const allUsers = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        return projectsSnapshot.docs.map(doc => ({
            params: { id: doc.id },
            props: { 
                project: { id: doc.id, ...doc.data() },
                allSupervisors: allUsers // Pass all users as supervisors
            }
        }));
    } catch (error) {
        console.error('❌ Error in getStaticPaths:', error);
        return [];
    }
}

const { project, allSupervisors } = Astro.props;

if (!project) {
    return Astro.redirect('/admin/404');
}

const currentSupervisors = Array.isArray(project.supervisors) ? project.supervisors : [];
const currentSupervisorIds = new Set(currentSupervisors.map(s => s.id));
// CORRECTED: Filter the comprehensive list of all users.
const availableSupervisors = allSupervisors.filter(s => !currentSupervisorIds.has(s.id));
---

<Layout title={`تفاصيل مشروع: ${project.projectName}`}>
  <main class="project-details-page">
    <div class="container">

      <header class="page-header">
        <h1>{project.projectName || 'اسم المشروع غير متاح'}</h1>
        <a href="/admin/projects" class="btn btn-secondary">&larr; العودة إلى قائمة المشاريع</a>
      </header>

      <div class="details-box">
        <!-- Project Address -->
        <div class="detail-row">
            <div class="detail-icon"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg></div>
            <div class="detail-text"><span class="label">عنوان المشروع:</span> <span class="value">{project.projectAddress || 'غير محدد'}</span></div>
        </div>

        <hr class="row-divider" />

        <!-- Current Supervisors -->
        <div class="detail-row">
            <div class="detail-icon"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></div>
            <div class="detail-text"><span class="label">المشرفون:</span> <span class="value">{currentSupervisors.length > 0 ? currentSupervisors.map(s => s.name).join(', ') : 'لا يوجد'}</span></div>
        </div>

        <hr class="row-divider" />

        <!-- Assign Supervisor Form -->
        <form id="assign-supervisor-form" class="detail-row assign-form">
            <div class="detail-icon"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></svg></div>
            <input type="hidden" name="projectId" value={project.id} />
            <select name="supervisor" id="supervisor-select" required class="supervisor-select">
                <option value="" disabled selected>اختر مشرفًا لتعيينه...</option>
                {availableSupervisors.length > 0 ? (
                    availableSupervisors.map(supervisor => (
                        <option value={`${supervisor.id}:${supervisor.name}`}>{supervisor.name}</option>
                    ))
                ) : (
                    <option disabled>لا يوجد مشرفون متاحون</option>
                )}
            </select>
            <button type="submit" class="btn-add" aria-label="تعيين المشرف">+</button>
        </form>
      </div>

    </div>
  </main>
</Layout>

<script>
  document.getElementById('assign-supervisor-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const form = e.target;
    const button = form.querySelector('button[type="submit"]');
    const supervisorSelect = form.querySelector('#supervisor-select');
    
    if (!supervisorSelect.value) {
        alert('الرجاء اختيار مشرف أولاً.');
        return;
    }

    const formData = new FormData(form);
    const projectId = formData.get('projectId');
    const [supervisorId, supervisorName] = formData.get('supervisor').split(':');

    button.disabled = true;
    button.textContent = '...';

    try {
      const response = await fetch('/api/assign-supervisor', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ projectId, supervisorId, supervisorName }),
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || 'حدث خطأ أثناء التعيين');
      }
      
      location.reload();

    } catch (error) {
      console.error('Fetch Error:', error);
      alert(`فشل: ${error.message}`);
      button.disabled = false;
      button.textContent = '+';
    }
  });
</script>

<style>
  /* General page styles */
  .project-details-page { direction: rtl; font-family: 'Cairo', sans-serif; background-color: #f4f7f6; padding: 3rem 1.5rem; }
  .container { max-width: 1100px; margin: 0 auto; display: flex; flex-direction: column; gap: 2rem; }
  .page-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 1.5rem; border-bottom: 2px solid #e2e8f0; width: 100%; }
  .page-header h1 { font-size: 2.5rem; color: #1a202c; font-weight: 800; }
  .btn-secondary { display: inline-block; padding: 0.7rem 1.4rem; border-radius: 8px; text-decoration: none; font-size: 0.95rem; font-weight: 700; background-color: #6c757d; color: #fff; transition: all 0.3s ease; flex-shrink: 0; }
  .btn-secondary:hover { background-color: #5a6268; transform: translateY(-2px); }
  
  /* Details Box */
  .details-box { background-color: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); padding: 1.5rem 2rem; border: 1px solid #e2e8f0; width: 100%; }
  .detail-row { display: flex; align-items: center; gap: 1.25rem; }
  .detail-icon { color: #3f51b5; flex-shrink: 0; }
  .detail-text { font-size: 1.05rem; color: #4a5568; }
  .detail-text .label { font-weight: 700; margin-left: 0.5rem; }
  .detail-text .value { font-weight: 500; color: #1a202c; }
  .row-divider { border: 0; height: 1px; background-color: #e8edf2; margin: 1rem 0; }

  /* Assign Form Styles */
  .assign-form { gap: 1rem; }
  .supervisor-select {
    flex-grow: 1;
    font-size: 1rem;
    font-family: 'Cairo', sans-serif;
    color: #4a5568;
    padding: 0.5rem 0.75rem;
    border-radius: 8px;
    border: 1px solid #cbd5e0;
    background-color: #f8fafc;
    appearance: none;
    -webkit-appearance: none;
    background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="none" stroke="%239ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l4 4 4-4"/></svg>');
    background-repeat: no-repeat;
    background-position: left 0.5rem center;
    background-size: 1.25em;
    padding-left: 2.5rem; /* Space for the icon */
  }
  .supervisor-select:focus { outline: none; border-color: #3f51b5; box-shadow: 0 0 0 2px rgba(63,81,181,0.2); }
  .btn-add {
    flex-shrink: 0;
    width: 2.5rem; 
    height: 2.5rem;
    border-radius: 50%;
    border: none;
    background-color: #3f51b5;
    color: white;
    font-size: 1.5rem;
    font-weight: bold;
    cursor: pointer;
    display: flex; 
    align-items: center; 
    justify-content: center;
    transition: all 0.2s ease;
  }
  .btn-add:hover { background-color: #303f9f; transform: scale(1.05); }
  .btn-add:disabled { background-color: #9fa8da; cursor: not-allowed; }

  @media (max-width: 768px) {
    .page-header { flex-direction: column; align-items: flex-start; gap: 1rem; text-align: right; }
    .details-box { padding: 1rem 1.5rem; }
  }
</style>