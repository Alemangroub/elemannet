---
import Layout from '../../../layouts/Layout.astro';
import { db } from "../../../firebase/admin";

// This function runs at build time to generate static pages for each project.
export async function getStaticPaths() {
    try {
        const projectsSnapshot = await db.collection('projects').get();
        if (projectsSnapshot.empty) {
            console.warn('⚠️ No projects found. No pages will be generated.');
            return [];
        }

        return projectsSnapshot.docs.map(doc => {
            const projectData = doc.data();
            // Ensure supervisors is an array, even if it's missing
            const currentSupervisors = Array.isArray(projectData.supervisors) ? projectData.supervisors : [];
            
            return {
                params: { id: doc.id },
                props: { 
                    project: { id: doc.id, ...projectData, supervisors: currentSupervisors }
                }
            };
        });
    } catch (error) {
        // If there's an error fetching projects (e.g., Firestore not configured),
        // return an empty array so the build doesn't fail.
        console.error('❌ Error in getStaticPaths fetching projects:', error.message);
        return [];
    }
}

const { project } = Astro.props;

// If a project is not found for the given ID, Astro will automatically show a 404 page.
// We can provide a more user-friendly message if needed, but Astro's default is clean.
if (!project) {
    return new Response("المشروع غير موجود", { status: 404, statusText: "Not Found" });
}

const currentSupervisors = project.supervisors;
---

<Layout title={`تفاصيل مشروع: ${project.projectName}`}>
  <main class="project-details-page">
    <div class="container">

      <header class="page-header">
        <h1>{project.projectName || 'اسم المشروع غير متاح'}</h1>
        <a href="/admin/projects" class="btn btn-secondary">&larr; العودة إلى قائمة المشاريع</a>
      </header>

      <div class="details-box">
        <!-- Project Address -->
        <div class="detail-row">
            <div class="detail-icon"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg></div>
            <div class="detail-text"><span class="label">عنوان المشروع:</span> <span class="value">{project.projectAddress || 'غير محدد'}</span></div>
        </div>

        <hr class="row-divider" />

        <!-- Current Supervisors -->
        <div class="detail-row">
            <div class="detail-icon"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></div>
            <div class="detail-text">
                <span class="label">المشرفون:</span> 
                <span class="value">
                    {currentSupervisors.length > 0 ? currentSupervisors.map(s => s.name).join(', ') : 'لا يوجد'}
                </span>
            </div>
        </div>
      </div>
    </div>
  </main>
</Layout>

<style>
  /* General page styles */
  .project-details-page { 
    direction: rtl; 
    font-family: 'Cairo', sans-serif; 
    background-color: #f4f7f6; 
    padding: 3rem 1.5rem; 
    min-height: 100vh; 
  }
  .container { 
    max-width: 1100px; 
    margin: 0 auto; 
    display: flex; 
    flex-direction: column; 
    gap: 2rem; 
  }
  .page-header { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    padding-bottom: 1.5rem; 
    border-bottom: 2px solid #e2e8f0; 
    width: 100%; 
  }
  .page-header h1 { 
    font-size: 2.5rem; 
    color: #1a202c; 
    font-weight: 800; 
  }
  .btn-secondary { 
    display: inline-block; 
    padding: 0.7rem 1.4rem; 
    border-radius: 8px; 
    text-decoration: none; 
    font-size: 0.95rem; 
    font-weight: 700; 
    background-color: #6c757d; 
    color: #fff; 
    transition: all 0.3s ease; 
    flex-shrink: 0; 
  }
  .btn-secondary:hover { 
    background-color: #5a6268; 
    transform: translateY(-2px); 
  }
  
  /* Details Box */
  .details-box { 
    background-color: #fff; 
    border-radius: 12px; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
    padding: 1.5rem 2rem; 
    border: 1px solid #e8edf2; 
    width: 100%; 
  }
  .detail-row { 
    display: flex; 
    align-items: center; 
    gap: 1.25rem; 
    padding: 0.5rem 0;
  }
  .detail-icon { 
    color: #3f51b5; 
    flex-shrink: 0; 
  }
  .detail-text { 
    font-size: 1.05rem; 
    color: #4a5568; 
  }
  .detail-text .label { 
    font-weight: 700; 
    margin-left: 0.5rem; 
  }
  .detail-text .value { 
    font-weight: 500; 
    color: #1a202c; 
  }
  .row-divider { 
    border: 0; 
    height: 1px; 
    background-color: #e8edf2; 
    margin: 1rem 0; 
  }

  @media (max-width: 768px) {
    .page-header { 
      flex-direction: column; 
      align-items: flex-start; 
      gap: 1rem; 
      text-align: right; 
    }
    .details-box { 
      padding: 1rem 1.5rem; 
    }
  }
</style>
