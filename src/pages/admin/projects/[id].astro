---
import Layout from '../../../layouts/Layout.astro';
import { db } from "../../../firebase/admin"; // Import the server-side Firebase connection

/**
 * This server-side function runs at build time. Its purpose is to fetch all 
 * projects from Firebase and generate a unique, static page for each one.
 */
export async function getStaticPaths() {
    try {
        // Fetch all documents from the 'projects' collection in Firestore.
        const projectsSnapshot = await db.collection('projects').get();

        // If the snapshot is empty, log it and return an empty array.
        if (projectsSnapshot.empty) {
            console.log("No projects found in Firestore. No project pages will be generated.");
            return [];
        }

        // Map the Firebase documents to an array that Astro can use.
        const projects = projectsSnapshot.docs.map(doc => ({
            params: { id: doc.id }, // This will be the URL slug, e.g., /admin/projects/some-project-id
            props: { project: doc.data() } // This is the data passed to the page component below.
        }));

        console.log(`Successfully fetched ${projects.length} projects to generate static pages.`);
        return projects;

    } catch (error) {
        // This catch block is critical. If it runs, it means the server failed to connect to Firebase.
        // The most common cause is missing or incorrect .env variables.
        console.error(
            '\n❌ Critical Error in getStaticPaths ❌\n' + 
            'Astro could not fetch project data from Firebase to build the pages.\n' +
            '--> PLEASE CHECK YOUR .env FILE and ensure the server-side variables are correct.\n' +
            '--> Remember to RESTART your dev server after any changes to .env.\n'
        );
        // Return an empty array to prevent the build from crashing, allowing the developer to see the error message.
        return [];
    }
}

// Astro passes the 'project' data for this specific page from getStaticPaths.
const { project } = Astro.props;

// If for some reason the project data isn't available (e.g., build error), 
// this prevents the page from crashing when trying to access project properties.
if (!project) {
    // This will be visible on the server console, not the browser.
    console.error(`Error rendering page: Project data was not available for this route.`);
    // In a real app, you might redirect to a 404 page here.
}
---

<Layout title={project ? project.name : 'Project Not Found'}>
    <main class="container mx-auto px-4 py-12 md:py-16">

        {project ? (
            <article class="max-w-4xl mx-auto bg-white dark:bg-gray-800 rounded-2xl shadow-lg overflow-hidden">
                <!-- Project Image -->
                <img 
                    src={project.imageUrl || 'https://via.placeholder.com/1200x600/1F2937/FFFFFF?text=Project+Image'} 
                    alt={`Cover image for ${project.name}`}
                    class="w-full h-60 md:h-80 object-cover bg-gray-700"
                />
                
                <div class="p-6 md:p-10">
                    <!-- Project Name -->
                    <h1 class="text-3xl md:text-4xl lg:text-5xl font-extrabold text-gray-900 dark:text-white mb-4">
                        {project.name}
                    </h1>
                    
                    <!-- Project Description -->
                    <p class="text-base md:text-lg text-gray-600 dark:text-gray-300 leading-relaxed mb-10">
                        {project.description}
                    </p>

                    <!-- Additional Details Section -->
                    {project.details && project.details.length > 0 && (
                        <div class="border-t border-gray-200 dark:border-gray-700 pt-8">
                            <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6">Project Details</h2>
                            <ul class="space-y-4">
                                {project.details.map((detail: { label: string; value: string; }) => (
                                    <li class="flex flex-col sm:flex-row justify-between bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg shadow-sm">
                                        <span class="font-semibold text-gray-700 dark:text-gray-200">{detail.label}</span>
                                        <span class="text-gray-900 dark:text-white text-left sm:text-right mt-1 sm:mt-0">{detail.value}</span>
                                    </li>
                                ))}
                            </ul>
                        </div>
                    )}

                    <!-- Back Button -->
                    <div class="mt-12 pt-8 border-t border-gray-200 dark:border-gray-700 text-center">
                        <a href="/admin/projects" class="inline-block bg-blue-600 text-white font-semibold py-3 px-8 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-all duration-300 hover:scale-105">
                            &larr; Back to All Projects
                        </a>
                    </div>
                </div>
            </article>
        ) : (
            <!-- Fallback content if project data fails to load -->
            <div class="text-center py-20">
                <h1 class="text-3xl font-bold text-red-500">Error: Project Not Found</h1>
                <p class="text-lg text-gray-600 dark:text-gray-400 mt-4">Could not load the project data. This may be due to a build error. Please check the server console for details.</p>
                 <div class="mt-8 text-center">
                    <a href="/admin/projects" class="inline-block bg-blue-600 text-white font-semibold py-3 px-8 rounded-lg hover:bg-blue-700 transition-all duration-300">
                        &larr; Back to All Projects
                    </a>
                </div>
            </div>
        )}
    </main>
</Layout>
