---
import Layout from '../../../../layouts/Layout.astro';
import AdminLogin from '../../../../components/AdminLogin.astro';
import { db } from "../../../../firebase/admin";

export const prerender = false;

const { id } = Astro.params;
let project = null;

try {
    const projectDoc = await db.collection('projects').doc(id).get();

    if (projectDoc.exists) {
        const projectData = projectDoc.data();
        project = { 
            id: projectDoc.id, 
            projectName: projectData.projectName || 'اسم غير متوفر',
        };

    } else {
        return Astro.redirect('/404');
    }
} catch (error) {
    console.error("Error fetching project data in suppliers.astro:", error);
    project = null;
}
---

<Layout title={`موردو مشروع: ${project ? project.projectName : 'خطأ'}`}>
    <div id="auth-loading-message" class="auth-container">
        <p>جارٍ التحقق من صلاحيات الدخول...</p>
    </div>

    <div id="admin-login-container" class="auth-container" style="display: none;">
      <AdminLogin />
    </div>

    <main id="page-content" class="project-details-page" style="display: none;">
        <div class="container">
             {project ? (
                <>
                    <header class="page-header">
                        <div>
                            <h1>موردو المشروع: {project.projectName}</h1>
                            <p class="page-subtitle">هنا يمكنك عرض وإدارة موردي المشروع.</p>
                        </div>
                        <div>
                          <a href={`/admin/projects/${id}`} class="back-link">&larr; العودة إلى تفاصيل المشروع</a>
                          <button id="logout-button" class="btn-logout">تسجيل الخروج</button>
                        </div>
                    </header>

                    <section class="suppliers-content">
                       <div class="placeholder-card">
                         <p>سيتم هنا عرض وإدارة الموردين الخاصين بالمشروع.</p>
                         
                       </div>
                    </section>
                </>
            ) : (
                <div class="error-card">
                    <h2>خطأ في تحميل البيانات</h2>
                    <p>حدث خطأ حرج أثناء محاولة تحميل تفاصيل المشروع. برجاء المحاولة مرة أخرى لاحقاً.</p>
                    <a href="/admin/projects" class="back-link">العودة إلى قائمة المشاريع</a>
                </div>
            )}
        </div>
    </main>
</Layout>

<script>
    import { auth, db } from '../../../../firebase/client';
    import { onAuthStateChanged, signOut } from "firebase/auth";
    import { doc, getDoc } from "firebase/firestore";

    document.addEventListener('DOMContentLoaded', () => {
        const authLoadingMessage = document.getElementById('auth-loading-message');
        const loginContainer = document.getElementById('admin-login-container');
        const pageContent = document.getElementById('page-content');

        onAuthStateChanged(auth, async (user) => {
            if(authLoadingMessage) authLoadingMessage.style.display = 'none';

            if (user) {
                try {
                    const userDocRef = doc(db, "users", user.uid);
                    const userDoc = await getDoc(userDocRef);

                    if (userDoc.exists() && userDoc.data().role === 'admin') {
                        if(pageContent) pageContent.style.display = 'block';
                        if(loginContainer) loginContainer.style.display = 'none';

                        const logoutButton = document.getElementById('logout-button');
                        if (logoutButton) {
                            logoutButton.addEventListener('click', async () => {
                                await signOut(auth);
                                window.location.href = '/admin';
                            });
                        }

                    } else {
                        await signOut(auth);
                        window.location.href = '/admin';
                    }
                } catch (error) {
                    console.error('Auth Check Error:', error);
                    await signOut(auth);
                    if(loginContainer) loginContainer.style.display = 'block';
                    if(pageContent) pageContent.style.display = 'none';
                }
            } else {
                if(pageContent) pageContent.style.display = 'none';
                if(loginContainer) loginContainer.style.display = 'block';
            }
        });
    });
</script>

<style>
.auth-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; width: 100%; }
.auth-container p { font-size: 1.2rem; }
.btn-logout { background-color: #ef4444; color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: background-color 0.2s; }
.btn-logout:hover { background-color: #dc2626; }
.page-header div:last-child { display: flex; align-items: center; gap: 1rem; }

:root { 
    --primary-color: #007bff; 
    --border-color: #e9ecef; 
    --card-shadow: 0 4px 15px rgba(0,0,0,0.06);
    --danger-color: #dc3545;
}
.project-details-page { direction: rtl; font-family: 'Cairo', sans-serif; background-color: #f8f9fa; min-height: 100vh; padding: 2.5rem; }
.container { max-width: 1100px; margin: 0 auto; }

.page-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1.5rem; margin-bottom: 2.5rem; }
h1 { font-size: 2.25rem; font-weight: 800; }
.page-subtitle { color: #6c757d; }
.back-link { color: var(--primary-color); font-weight: 600; text-decoration: none; padding: 0.6rem 1rem; }

.suppliers-content { background: #fff; border-radius: 12px; box-shadow: var(--card-shadow); padding: 2rem; }
.placeholder-card { text-align: center; padding: 4rem; background-color: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 8px; }
.placeholder-card p { font-size: 1.2rem; color: #6c757d; margin:0; }

.error-card { text-align: center; padding: 4rem; background: #fff; border-radius: 12px; box-shadow: var(--card-shadow); border: 1px solid var(--border-color); }
.error-card h2 { color: var(--danger-color); font-size: 2rem; margin-bottom: 1rem; }
</style>
