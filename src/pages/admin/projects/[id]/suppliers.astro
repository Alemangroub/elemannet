
---
import Layout from '../../../../layouts/Layout.astro';
import AdminLogin from '../../../../components/AdminLogin.astro';
import { db } from "../../../../firebase/admin";

export const prerender = false;

const { id } = Astro.params;
let project = null;

try {
    const projectDoc = await db.collection('projects').doc(id).get();
    if (projectDoc.exists) {
        const projectData = projectDoc.data();
        project = { 
            id: projectDoc.id, 
            projectName: projectData.projectName || 'اسم غير متوفر',
        };
    } else {
        return Astro.redirect('/404');
    }
} catch (error) {
    console.error("Error fetching project data in suppliers.astro:", error);
    project = null;
}
---

<Layout title={`واردات المشروع: ${project ? project.projectName : ''}`}>
    <div id="auth-loading-message" class="auth-container">
        <p>جارٍ التحقق من صلاحيات الدخول...</p>
    </div>

    <div id="admin-login-container" class="auth-container" style="display: none;">
      <AdminLogin />
    </div>

    <main id="page-content" class="imports-admin-page" style="display: none;" data-project-id={project?.id} data-project-name={project?.projectName}>
        <div class="container">
             {project ? (
                <>
                    <header class="page-header">
                        <div>
                            <h1>واردات المشروع: {project.projectName}</h1>
                            <p class="page-subtitle">هنا يمكنك عرض وإدارة واردات ومشتريات المشروع.</p>
                        </div>
                        <div class="header-actions">
                           <button id="add-import-btn" class="btn btn-primary">+ إضافة وارد جديد</button>
                           <a href={`/admin/projects/${id}`} class="btn btn-secondary">&larr; العودة للتفاصيل</a>
                        </div>
                    </header>

                    <!-- Imports List -->
                    <div class="imports-list-container">
                        <div class="list-header">
                            <div class="title-and-summaries">
                                <h2>قائمة الواردات</h2>
                                <div class="summaries-inline">
                                    <div class="summary-card-inline" id="grand-total-card">
                                        <h5>الإجمالي الكلي</h5>
                                        <p id="grand-total-amount">0.00</p>
                                    </div>
                                    <div class="summary-card-inline" id="filtered-total-card" style="display: none;">
                                        <h5 id="filtered-total-label">إجمالي الصنف</h5>
                                        <p id="filtered-total-amount">0.00</p>
                                    </div>
                                </div>
                            </div>
                            <div class="controls-container">
                                <div class="filter-container">
                                    <label for="category-filter">فلترة حسب الصنف:</label>
                                    <select id="category-filter">
                                        <option value="none" selected>-- اختر صنفًا --</option>
                                        <option value="all">عرض الكل</option>
                                        <option value="حديد">حديد</option>
                                        <option value="اسمنت">اسمنت</option>
                                        <option value="رمله">رمله</option>
                                        <option value="زلط">زلط</option>
                                        <option value="طوب">طوب</option>
                                        <option value="كهرباء">كهرباء</option>
                                        <option value="سباكة">سباكة</option>
                                        <option value="رخام">رخام</option>
                                        <option value="دهانات">دهانات</option>
                                        <option value="اخري">أصناف أخرى</option>
                                    </select>
                                </div>
                                <div class="export-buttons">
                                    <button id="print-btn" class="btn btn-secondary">طباعة</button>
                                    <button id="export-pdf-btn" class="btn btn-primary">تصدير PDF</button>
                                    <button id="export-excel-btn" class="btn btn-secondary">تصدير Excel</button>
                                </div>
                            </div>
                        </div>
                        <div class="table-wrapper" style="display: none;">
                        <table id="imports-table">
                            <thead>
                            <tr>
                                <th>الصنف</th>
                                <th>الكمية</th>
                                <th>سعر الوحدة</th>
                                <th>السعر الإجمالي</th>
                                <th>المورد</th>
                                <th>التاريخ</th>
                                <th class="actions-header">الإجراءات</th>
                            </tr>
                            </thead>
                            <tbody id="imports-list">
                            </tbody>
                        </table>
                        </div>
                        <p id="no-imports-message">يرجى اختيار صنف لعرض الواردات.</p>
                    </div>
                </>
            ) : (
                <div class="error-card">
                    <h2>خطأ في تحميل البيانات</h2>
                    <p>حدث خطأ حرج أثناء محاولة تحميل تفاصيل المشروع. برجاء المحاولة مرة أخرى لاحقاً.</p>
                    <a href="/admin/projects" class="back-link">العودة إلى قائمة المشاريع</a>
                </div>
            )}
        </div>
    </main>

    <!-- Add/Edit Import Modal -->
    <div id="import-modal" class="modal-overlay">
      <div class="modal-box">
        <h3 id="modal-title">إضافة وارد جديد</h3>
        <form id="import-form">
            <div class="form-group">
                <label for="item-category">الصنف</label>
                <select id="item-category" required>
                    <option value="" disabled selected>-- اختر الصنف --</option>
                    <option value="حديد">حديد</option>
                    <option value="اسمنت">اسمنت</option>
                    <option value="رمله">رمله</option>
                    <option value="زلط">زلط</option>
                    <option value="طوب">طوب</option>
                    <option value="كهرباء">كهرباء</option>
                    <option value="سباكة">سباكة</option>
                    <option value="رخام">رخام</option>
                    <option value="دهانات">دهانات</option>
                    <option value="اخري">اخري</option>
                </select>
            </div>
            <div class="form-group" id="other-item-name-group" style="display: none;">
                <label for="item-name">اسم الصنف (آخر)</label>
                <input type="text" id="item-name">
            </div>

          <div class="form-grid">
                <div class="form-group">
                    <label for="item-quantity">الكمية</label>
                    <input type="number" id="item-quantity" required>
                </div>
                <div class="form-group">
                    <label for="item-unit-price">سعر الوحدة</label>
                    <input type="number" id="item-unit-price" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="item-price">السعر الإجمالي</label>
                    <input type="number" id="item-price" step="0.01" required readonly>
                </div>
          </div>
          <div class="form-group">
            <label for="item-supplier">المورد</label>
            <input type="text" id="item-supplier">
          </div>
          <div class="form-group">
            <label for="import-date">تاريخ التوريد</label>
            <input type="date" id="import-date" required>
          </div>
           <div class="form-group">
            <label for="item-notes">ملاحظات</label>
            <textarea id="item-notes" rows="3"></textarea>
          </div>
          <div class="modal-actions">
            <button type="button" id="cancel-import-btn" class="btn btn-secondary">إلغاء</button>
            <button type="submit" class="btn btn-primary">حفظ</button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal-overlay">
      <div class="modal-box">
        <h3>تأكيد الحذف</h3>
        <p>هل أنت متأكد من أنك تريد حذف هذا الصنف؟</p>
        <div class="modal-actions">
          <button id="cancel-delete-btn" class="btn btn-secondary">إلغاء</button>
          <button id="confirm-delete-btn" class="btn btn-danger">تأكيد الحذف</button>
        </div>
      </div>
    </div>
</Layout>

<script>
    import { auth, db } from '../../../../firebase/client';
    import { onAuthStateChanged, signOut } from "firebase/auth";
    import { collection, doc, getDoc, addDoc, onSnapshot, updateDoc, deleteDoc, query, orderBy, Timestamp } from 'firebase/firestore';
    import * as XLSX from 'xlsx';

    const pageContent = document.getElementById('page-content');
    const projectId = pageContent.dataset.projectId;
    const projectName = pageContent.dataset.projectName;

    let currentEditImportId = null;
    let allImportsData = []; // Cache for all imports data
    const predefinedCategories = ["حديد", "اسمنت", "رمله", "زلط", "طوب", "كهرباء", "سباكة", "رخام", "دهانات"];

    document.addEventListener('DOMContentLoaded', () => {
        const authLoadingMessage = document.getElementById('auth-loading-message');
        const loginContainer = document.getElementById('admin-login-container');

        onAuthStateChanged(auth, async (user) => {
            authLoadingMessage.style.display = 'none';
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists() && userDoc.data().role === 'admin') {
                    pageContent.style.display = 'block';
                    loginContainer.style.display = 'none';
                    initializePage();
                } else {
                    signOut(auth);
                    pageContent.style.display = 'none';
                    loginContainer.style.display = 'block';
                }
            } else {
                pageContent.style.display = 'none';
                loginContainer.style.display = 'block';
            }
        });
    });

    function initializePage() {
        if (!projectId) return;
        setupEventListeners();
        listenForImports();
    }

    const addImportBtn = document.getElementById('add-import-btn');
    const importModal = document.getElementById('import-modal');
    const deleteModal = document.getElementById('delete-modal');
    const cancelImportBtn = document.getElementById('cancel-import-btn');
    const importForm = document.getElementById('import-form');
    const modalTitle = document.getElementById('modal-title');
    const importsList = document.getElementById('imports-list');
    let importIdToDelete = null;

    function showModal(modal) { modal.classList.add('visible'); }
    function hideModal(modal) { modal.classList.remove('visible'); }

    function setupEventListeners() {
        const itemCategorySelect = document.getElementById('item-category');
        const otherItemGroup = document.getElementById('other-item-name-group');
        const itemNameInput = document.getElementById('item-name');
        
        const quantityInput = document.getElementById('item-quantity');
        const unitPriceInput = document.getElementById('item-unit-price');
        const totalPriceInput = document.getElementById('item-price');

        function calculateTotal() {
            const quantity = parseFloat(quantityInput.value) || 0;
            const unitPrice = parseFloat(unitPriceInput.value) || 0;
            totalPriceInput.value = (quantity * unitPrice).toFixed(2);
        }

        if(quantityInput) quantityInput.addEventListener('input', calculateTotal);
        if(unitPriceInput) unitPriceInput.addEventListener('input', calculateTotal);

        if (itemCategorySelect) {
             itemCategorySelect.addEventListener('change', () => {
                if (itemCategorySelect.value === 'اخري') {
                    otherItemGroup.style.display = 'block';
                    itemNameInput.required = true;
                } else {
                    otherItemGroup.style.display = 'none';
                    itemNameInput.required = false;
                }
            });
        }

        if (addImportBtn) {
            addImportBtn.addEventListener('click', () => {
                currentEditImportId = null;
                modalTitle.textContent = 'إضافة وارد جديد';
                importForm.reset();
                otherItemGroup.style.display = 'none';
                itemNameInput.required = false;
                totalPriceInput.value = '';
                document.getElementById('import-date').valueAsDate = new Date();
                showModal(importModal);
            });
        }

        if (cancelImportBtn) cancelImportBtn.addEventListener('click', () => hideModal(importModal));
        if (importModal) importModal.addEventListener('click', (e) => { if (e.target === importModal) hideModal(importModal); });
        
        if (importForm) {
            importForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const categoryValue = document.getElementById('item-category').value;
                let itemNameValue = categoryValue;
                if (categoryValue === 'اخري') {
                    itemNameValue = document.getElementById('item-name').value;
                }

                const importData = {
                    name: itemNameValue,
                    quantity: parseFloat(quantityInput.value),
                    unitPrice: parseFloat(unitPriceInput.value),
                    price: parseFloat(totalPriceInput.value),
                    supplier: document.getElementById('item-supplier').value,
                    date: Timestamp.fromDate(new Date(document.getElementById('import-date').value)),
                    notes: document.getElementById('item-notes').value,
                };

                const importsColRef = collection(db, 'projects', projectId, 'imports');
                if (currentEditImportId) {
                    await updateDoc(doc(importsColRef, currentEditImportId), importData);
                } else {
                    await addDoc(importsColRef, {
                        ...importData,
                        createdAt: Timestamp.now()
                    });
                }
                hideModal(importModal);
                importForm.reset();
            });
        }

        if (importsList) {
            importsList.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;

                const row = target.closest('tr');
                const importId = row.dataset.id;

                if (target.classList.contains('btn-edit-custom')) {
                    const importData = JSON.parse(row.dataset.import);
                    openEditModal(importId, importData);
                }
                if (target.classList.contains('btn-delete-custom')) {
                    importIdToDelete = importId;
                    showModal(deleteModal);
                }
            });
        }

        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        if (cancelDeleteBtn) cancelDeleteBtn.addEventListener('click', () => hideModal(deleteModal));
        if (deleteModal) deleteModal.addEventListener('click', (e) => { if (e.target === deleteModal) hideModal(deleteModal); });
        if (confirmDeleteBtn) {
            confirmDeleteBtn.addEventListener('click', async () => {
                if (importIdToDelete) {
                    const importRef = doc(db, 'projects', projectId, 'imports', importIdToDelete);
                    await deleteDoc(importRef);
                    hideModal(deleteModal);
                    importIdToDelete = null;
                }
            });
        }

        const filterSelect = document.getElementById('category-filter');
        if (filterSelect) {
            filterSelect.addEventListener('change', applyFilter);
        }

        // Export and Print Buttons
        const printBtn = document.getElementById('print-btn');
        if(printBtn) {
            printBtn.addEventListener('click', () => window.print());
        }

        const exportPdfBtn = document.getElementById('export-pdf-btn');
        if (exportPdfBtn) {
            exportPdfBtn.addEventListener('click', handlePdfExport);
        }

        const exportExcelBtn = document.getElementById('export-excel-btn');
        if(exportExcelBtn) {
            exportExcelBtn.addEventListener('click', () => {
                const table = document.getElementById('imports-table');
                const wb = XLSX.utils.table_to_book(table, { sheet: "Sheet JS" });
                XLSX.writeFile(wb, `project-imports-${projectName}.xlsx`);
            });
        }
    }
    
    async function handlePdfExport(e) {
        const button = e.currentTarget;
        button.disabled = true;
        button.textContent = 'جارٍ التصدير...';

        try {
            const { default: html2canvas } = await import('html2canvas');
            const { jsPDF } = await import('jspdf');

            const tableToExport = document.getElementById('imports-table');
            if (!tableToExport || tableToExport.style.display === 'none') {
                alert("لا يوجد جدول لعرضه أو تصديره. يرجى اختيار فلتر لعرض البيانات أولاً.");
                return;
            }
            
            // Create a container for the export content
            const exportContainer = document.createElement('div');
            exportContainer.style.direction = 'rtl';
            exportContainer.style.padding = '20px';
            exportContainer.style.backgroundColor = 'white';
            exportContainer.style.width = '800px'; // Fixed width for better canvas rendering

            const projectTitle = document.createElement('h1');
            projectTitle.textContent = document.querySelector('.page-header h1').textContent;
            projectTitle.style.textAlign = 'center';
            exportContainer.appendChild(projectTitle);

            const filterStatus = document.createElement('p');
            filterStatus.textContent = `فلترة حسب: ${document.getElementById('category-filter').selectedOptions[0].text}`;
            filterStatus.style.textAlign = 'center';
            exportContainer.appendChild(filterStatus);

            const clonedTable = tableToExport.cloneNode(true);
            // Remove the actions column from the cloned table
            clonedTable.querySelectorAll('.actions-header, .btn-action-cell').forEach(el => el.remove());
            exportContainer.appendChild(clonedTable);

            document.body.appendChild(exportContainer);

            const canvas = await html2canvas(exportContainer, {
                scale: 2,
                useCORS: true,
                onclone: (clonedDoc) => {
                    const style = clonedDoc.createElement('style');
                     style.innerHTML = `
                        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
                        body, div, table { font-family: 'Cairo', sans-serif !important; direction: rtl; }
                        h1 { font-size: 1.5rem; text-align: center; color: #333; margin-bottom: 0.5rem; }
                        p { font-size: 1rem; text-align: center; color: #666; margin-bottom: 1.5rem; }
                        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
                        th, td { border: 1px solid #ddd; padding: 10px; text-align: right; font-size: 0.9rem; }
                        th { background-color: #f2f2f2; font-weight: 700; }
                    `;
                    clonedDoc.body.appendChild(style);
                }
            });

            document.body.removeChild(exportContainer);

            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const imgProps = pdf.getImageProperties(imgData);
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            
            let heightLeft = pdfHeight;
            let position = 0;
            pdf.addImage(imgData, 'PNG', 10, position, pdfWidth - 20, pdfHeight);
            heightLeft -= pdf.internal.pageSize.getHeight();

            while (heightLeft >= 0) {
                position = heightLeft - pdfHeight;
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 10, position, pdfWidth - 20, pdfHeight);
                heightLeft -= pdf.internal.pageSize.getHeight();
            }
            
            pdf.save(`واردات - ${projectName}.pdf`);

        } catch (err) {
            console.error("PDF Export Error:", err);
            alert("فشل تصدير PDF. يرجى المحاولة مرة أخرى.");
        } finally {
            button.disabled = false;
            button.textContent = 'تصدير PDF';
        }
    }

    function calculateAndDisplayGrandTotal() {
        const grandTotalElement = document.getElementById('grand-total-amount');
        if (!grandTotalElement) return;

        const grandTotal = allImportsData.reduce((sum, imp) => sum + (imp.price || 0), 0);
        grandTotalElement.textContent = grandTotal.toLocaleString('ar-EG', { style: 'currency', currency: 'EGP' });
    }

    function applyFilter() {
        const filterSelect = document.getElementById('category-filter');
        const selectedCategory = filterSelect.value;
        const rows = importsList.querySelectorAll('tr');
        const noImportsMessage = document.getElementById('no-imports-message');
        const tableWrapper = document.querySelector('.table-wrapper');
        
        const filteredTotalCard = document.getElementById('filtered-total-card');
        const filteredTotalLabel = document.getElementById('filtered-total-label');
        const filteredTotalAmount = document.getElementById('filtered-total-amount');

        if (selectedCategory === 'none') {
            tableWrapper.style.display = 'none';
            noImportsMessage.textContent = 'يرجى اختيار صنف لعرض الواردات.';
            noImportsMessage.style.display = 'block';
            filteredTotalCard.style.display = 'none';
            rows.forEach(row => { row.style.display = 'none'; });
            return;
        }

        let visibleCount = 0;
        let filteredTotal = 0;

        rows.forEach(row => {
            const importData = JSON.parse(row.dataset.import);
            const itemName = importData.name;
            let matches = false;

            if (selectedCategory === 'all') {
                matches = true;
            } else if (selectedCategory === 'اخري') {
                if (!predefinedCategories.includes(itemName)) {
                    matches = true;
                }
            } else {
                if (itemName === selectedCategory) {
                    matches = true;
                }
            }

            if (matches) {
                row.style.display = ''; 
                visibleCount++;
                filteredTotal += importData.price || 0;
            } else {
                row.style.display = 'none';
            }
        });

        if (selectedCategory === 'all' || visibleCount === 0) {
            filteredTotalCard.style.display = 'none';
        } else {
            filteredTotalLabel.textContent = `إجمالي ${selectedCategory === 'اخري' ? 'الأصناف الأخرى' : selectedCategory}`;
            filteredTotalAmount.textContent = filteredTotal.toLocaleString('ar-EG', { style: 'currency', currency: 'EGP' });
            filteredTotalCard.style.display = 'block';
        }

        if (visibleCount === 0 && allImportsData.length > 0) {
            tableWrapper.style.display = 'none';
            noImportsMessage.textContent = 'لا توجد واردات تطابق هذا الفلتر.';
            noImportsMessage.style.display = 'block';
        } else if (allImportsData.length === 0) {
             tableWrapper.style.display = 'none';
            noImportsMessage.textContent = 'لم يتم إضافة أي واردات لهذا المشروع بعد.';
            noImportsMessage.style.display = 'block';
        } else {
            tableWrapper.style.display = '';
            noImportsMessage.style.display = 'none';
        }
    }

    function listenForImports() {
        if (!projectId) return;
        const importsQuery = query(collection(db, 'projects', projectId, 'imports'), orderBy('date', 'desc'));
        
        onSnapshot(importsQuery, (snapshot) => {
            allImportsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            calculateAndDisplayGrandTotal();

            if (snapshot.empty) {
                importsList.innerHTML = '';
            } else {
                importsList.innerHTML = allImportsData.map(data => renderImportRow(data.id, data)).join('');
            }
            
            applyFilter();
        });
    }

    function renderImportRow(id, data) {
        const date = data.date.toDate();
        const timezoneOffset = date.getTimezoneOffset() * 60000;
        const correctedDate = new Date(date.getTime() - timezoneOffset);
        const dateForInput = correctedDate.toISOString().split('T')[0];
        const storedData = { ...data, date: dateForInput, notes: data.notes || '', unitPrice: data.unitPrice || '' };

        return `
            <tr data-id="${id}" data-import='${JSON.stringify(storedData)}'>
                <td data-label="الصنف">${data.name}</td>
                <td data-label="الكمية">${data.quantity}</td>
                <td data-label="سعر الوحدة">${(data.unitPrice || 0).toLocaleString('ar-EG', { style: 'currency', currency: 'EGP' })}</td>
                <td data-label="السعر الإجمالي">${(data.price || 0).toLocaleString('ar-EG', { style: 'currency', currency: 'EGP' })}</td>
                <td data-label="المورد">${data.supplier || '-'}</td>
                <td data-label="التاريخ">${date.toLocaleDateString('ar-EG')}</td>
                <td data-label="الإجراءات" class="btn-action-cell">
                    <button class="btn btn-edit-custom">تعديل</button>
                    <button class="btn btn-delete-custom">حذف</button>
                </td>
            </tr>
        `;
    }
    
    function openEditModal(id, data) {
        currentEditImportId = id;
        modalTitle.textContent = 'تعديل وارد';
        importForm.reset(); // Reset form first

        const itemCategorySelect = document.getElementById('item-category');
        const otherItemGroup = document.getElementById('other-item-name-group');
        const itemNameInput = document.getElementById('item-name');

        if (predefinedCategories.includes(data.name)) {
            itemCategorySelect.value = data.name;
            otherItemGroup.style.display = 'none';
            itemNameInput.required = false;
        } else {
            itemCategorySelect.value = 'اخري';
            otherItemGroup.style.display = 'block';
            itemNameInput.value = data.name || '';
            itemNameInput.required = true;
        }

        document.getElementById('item-quantity').value = data.quantity || '';
        document.getElementById('item-unit-price').value = data.unitPrice || '';
        document.getElementById('item-price').value = data.price || '';
        document.getElementById('item-supplier').value = data.supplier || '';
        document.getElementById('import-date').value = data.date || '';
        document.getElementById('item-notes').value = data.notes || '';

        showModal(importModal);
    }
</script>

<style is:global>
:root {
    --primary-color: #3f51b5;
    --secondary-color: #6c757d;
    --danger-color: #d9534f;
    --success-color: #28a745;
    --light-gray: #f4f7f6;
    --dark-text: #333;
    --light-text: #555;
    --white: #fff;
    --border-color: #e0e0e0;
    --shadow: 0 4px 6px rgba(0,0,0,0.05);
}

/* General Styles */
.imports-admin-page { padding: 3rem 1.5rem; background-color: var(--light-gray); min-height: 100vh; direction: rtl; font-family: 'Cairo', sans-serif; }
.container { max-width: 1200px; margin: 0 auto; }

/* Auth & Error */
.auth-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; width: 100%; font-family: 'Cairo', sans-serif; }
.auth-container p { font-size: 1.2rem; }
.error-card { text-align: center; padding: 4rem; background: var(--white); border-radius: 12px; box-shadow: var(--shadow); }
.error-card h2 { color: var(--danger-color); }

/* Header */
.page-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 2.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); }
.page-header h1 { font-size: 2.2rem; color: var(--dark-text); font-weight: 900; }
.page-subtitle { color: var(--light-text); margin-top: 0.25rem; }
.header-actions { display: flex; gap: 1rem; }

/* General Button Styles */
.btn { display: inline-block; padding: 0.7rem 1.3rem; color: var(--white); text-decoration: none; border-radius: 8px; font-size: 0.95rem; font-weight: 700; transition: all 0.2s ease-in-out; text-align: center; border: 1px solid transparent; cursor: pointer; }
.btn:hover { transform: translateY(-2px); }
.btn-primary { background-color: var(--primary-color); border-color: var(--primary-color); }
.btn-primary:hover { background-color: #303f9f; }
.btn-secondary { background-color: var(--secondary-color); border-color: var(--secondary-color); color: var(--white); }
.btn-secondary:hover { background-color: #5a6268; }
.btn-danger { background-color: var(--danger-color); border-color: var(--danger-color); }
.btn-danger:hover { background-color: #c9302c; }

/* Imports List */
.imports-list-container { background-color: var(--white); padding: 2rem; border-radius: 12px; box-shadow: var(--shadow); }

.list-header { display: flex; flex-direction: column; gap: 1.5rem; margin-bottom: 1.5rem; border-bottom: 2px solid var(--border-color); padding-bottom: 1.5rem; }
.title-and-summaries { display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 1.5rem; }
.title-and-summaries h2 { font-size: 1.8rem; font-weight: 800; color: var(--primary-color); margin: 0; }

.summaries-inline { display: flex; flex-wrap: wrap; gap: 1rem; }
.summary-card-inline { padding: 0.5rem 1rem; border-radius: 8px; border: 1px solid var(--border-color); background-color: #f9fafb; text-align: center; }
.summary-card-inline h5 { font-size: 0.85rem; color: var(--light-text); font-weight: 700; margin: 0 0 0.25rem; }
.summary-card-inline p { font-size: 1.25rem; font-weight: 700; margin: 0; }
#grand-total-card p { color: var(--success-color); }
#filtered-total-card p { color: var(--primary-color); }

.controls-container { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 1rem; }
.filter-container { display: flex; align-items: center; gap: 0.75rem; }
.filter-container label { font-weight: 700; color: var(--light-text); font-size: 0.95rem; }
.filter-container select { padding: 0.5rem 1rem; border-radius: 6px; border: 1px solid var(--border-color); min-width: 200px; background-color: #fff; }

.export-buttons { display: flex; gap: 1rem; }

/* Table Styles */
.table-wrapper { overflow-x: auto; }
#imports-table { width: 100%; border-collapse: separate; border-spacing: 0 1rem; margin-top: 1rem; }
#imports-table thead { display: table-header-group; }
#imports-table th {
    padding: 1rem 1.25rem;
    font-size: 0.9rem;
    color: #666;
    font-weight: 700;
    text-align: right;
    background-color: #f9fafb;
}
#imports-table th:first-of-type { border-top-right-radius: 10px; border-bottom-right-radius: 10px; }
#imports-table th:last-of-type { border-top-left-radius: 10px; border-bottom-left-radius: 10px; }

#imports-table tbody tr { background-color: #fdfdfd; box-shadow: 0 1px 3px rgba(0,0,0,0.03); border-radius: 10px; transition: transform 0.2s ease, box-shadow 0.2s ease; overflow: hidden; }
#imports-table tbody tr:hover { transform: translateY(-3px); box-shadow: 0 8px 16px rgba(0,0,0,0.07); }
#imports-table td { padding: 1rem 1.25rem; font-size: 0.95rem; color: var(--light-text); vertical-align: middle; text-align: right; border-bottom: 1px solid var(--border-color); }
#imports-table tr td:first-child { border-top-right-radius: 10px; border-bottom-right-radius: 10px; }
#imports-table tr td:last-child { border-top-left-radius: 10px; border-bottom-left-radius: 10px; text-align: center; }
#imports-table tr:last-child td { border-bottom: none; }

.btn-action-cell { display: flex; gap: 0.5rem; justify-content: center; }
.btn-edit-custom, .btn-delete-custom { background: transparent; padding: 0.4rem 0.8rem; font-size: 0.85rem; border-radius: 6px; cursor: pointer; }
.btn-edit-custom { color: var(--primary-color); border: 1px solid var(--primary-color); }
.btn-edit-custom:hover { background-color: var(--primary-color); color: var(--white); }
.btn-delete-custom { color: var(--danger-color); border: 1px solid var(--danger-color); }
.btn-delete-custom:hover { background-color: var(--danger-color); color: var(--white); }

#no-imports-message { text-align: center; padding: 3rem 0; font-size: 1.1rem; color: #777; background-color: #f9fafb; border-radius: 8px; }

.modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); z-index: 1000; visibility: hidden; opacity: 0; transition: opacity 0.3s ease; display: flex; align-items: flex-start; justify-content: center; padding: 2rem 1rem; overflow-y: auto; }
.modal-overlay.visible { visibility: visible; opacity: 1; }
.modal-box { background: var(--white); padding: 2.5rem; border-radius: 12px; width: 100%; max-width: 550px; text-align: right; transform: scale(0.95); transition: transform 0.3s ease; margin: auto; }
.modal-overlay.visible .modal-box { transform: scale(1); }
.modal-box h3 { font-size: 1.8rem; margin: 0 0 2rem; color: var(--dark-text); text-align: center; font-weight: 800; }
.modal-actions { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem; }

#import-form { display: flex; flex-direction: column; gap: 1rem; }
.form-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
.form-group label { font-weight: 700; color: var(--light-text); margin-bottom: 0.5rem; display: block; }
.form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.8rem; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem; background-color: #fff; }
.form-group input[readonly] { background-color: #e9ecef; cursor: not-allowed; }

@media print {
  body > *:not(.imports-admin-page),
  .imports-admin-page > .container > *:not(.imports-list-container),
  .page-header, .header-actions, .list-header, .modal-overlay, .btn-action-cell, .actions-header {
    display: none !important;
  }
  .imports-list-container, .table-wrapper, #imports-table { display: block !important; width: 100% !important; box-shadow: none !important; border: none !important; }
  #imports-table th, #imports-table td { display: table-cell !important; font-size: 10pt; padding: 8px; }
  #imports-table thead { display: table-header-group !important; }
  #imports-table tbody tr { display: table-row !important; }
   h1, h2 { display: block !important; text-align: center; font-size: 16pt; }
}

@media (max-width: 768px) {
    .page-header, .controls-container, .title-and-summaries { flex-direction: column; align-items: stretch; gap: 1.5rem; }
    .form-grid { grid-template-columns: 1fr; }
    #imports-table thead { display: none; }
    #imports-table tr, #imports-table td { display: block; width: 100%; }
    #imports-table tr { margin-bottom: 1rem; box-shadow: none; border: 1px solid var(--border-color); }
    #imports-table td { text-align: right; padding-left: 50%; position: relative; border-bottom: 1px solid #f0f0f0; }
    #imports-table td:last-child { border-bottom: none; }
    #imports-table td::before { content: attr(data-label); position: absolute; left: 1rem; width: 40%; padding-right: 10px; font-weight: 700; text-align: left; color: var(--primary-color); }
}

</style>
