---
import Layout from '../../../../layouts/Layout.astro';
import AdminLogin from '../../../../components/AdminLogin.astro';
import { db } from "../../../../firebase/admin";

const { id } = Astro.params;
let project = null;
let remainsReports = [];
let feedback = { message: '', type: '' };

// Mark reports as read when the page is loaded
if (id) {
    try {
        const unreadReportsRef = db.collection('remains_reports').where('projectId', '==', id).where('isRead', '==', false);
        const unreadReportsSnapshot = await unreadReportsRef.get();
        if (!unreadReportsSnapshot.empty) {
            const batch = db.batch();
            unreadReportsSnapshot.docs.forEach(doc => {
                batch.update(doc.ref, { isRead: true });
            });
            await batch.commit();
        }
    } catch (error) {
        console.error("Error marking remains reports as read:", error);
    }
}

// Handle Delete
const reportIdToDelete = Astro.url.searchParams.get('delete');
if (reportIdToDelete) {
    try {
        await db.collection('remains_reports').doc(reportIdToDelete).delete();
        return Astro.redirect(`/admin/projects/${id}/remains-reports?feedback=deleted`);
    } catch (error) {
        console.error("Error deleting report:", error);
        return Astro.redirect(`/admin/projects/${id}/remains-reports?feedback=error`);
    }
}

// Handle feedback messages
const feedbackParam = Astro.url.searchParams.get('feedback');
if (feedbackParam === 'deleted') feedback = { message: 'تم حذف تقرير البواقي بنجاح.', type: 'success' };
if (feedbackParam === 'error') feedback = { message: 'حدث خطأ أثناء حذف التقرير.', type: 'error' };

const formatTimestamp = (timestamp) => {
    if (!timestamp || !timestamp.toDate) return 'تاريخ غير متوفر';
    return timestamp.toDate().toLocaleDateString('ar-EG', { day: 'numeric', month: 'long', year: 'numeric', hour: 'numeric', minute: '2-digit' });
};

try {
    const projectDoc = await db.collection('projects').doc(id).get();
    if (!projectDoc.exists) return Astro.redirect('/404');
    
    project = { id: projectDoc.id, ...projectDoc.data() };
    const reportsSnapshot = await db.collection('remains_reports').where('projectId', '==', id).get();
    
    remainsReports = reportsSnapshot.docs.map(doc => {
        const data = doc.data();
        return { 
            id: doc.id, 
            ...data, 
            createdAtFormatted: formatTimestamp(data.createdAt) 
        };
    }).sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));

} catch (error) {
    console.error("Error fetching data:", error);
    project = { projectName: "خطأ في تحميل البيانات" };
}
---

<Layout title={`تقارير البواقي: ${project?.projectName}`}>
    <div id="auth-loading-message" class="auth-container">
        <p>جارٍ التحقق من صلاحيات الدخول...</p>
    </div>

    <div id="admin-login-container" class="auth-container" style="display: none;">
      <AdminLogin />
    </div>

    <main id="page-content" class="reports-display-page" style="display: none;">
        <div class="container">
             <header class="page-header">
                <div>
                    <h1>تقارير بواقي مشروع: {project.projectName}</h1>
                    <p class="page-subtitle">عرض وحذف تقارير المواد المتبقية.</p>
                </div>
                 <div>
                    <a href={`/admin/projects/${id}`} class="back-link">&larr; العودة للتفاصيل</a>
                    <button id="logout-button" class="btn-logout">تسجيل الخروج</button>
                 </div>
            </header>

            {feedback.message && <div class={`feedback-banner ${feedback.type}`}>{feedback.message}</div>}

            <section class="reports-section">
                {remainsReports.length === 0 ? (
                    <div class="no-items-card"><p>لا توجد تقارير بواقي لهذا المشروع بعد.</p></div>
                ) : (
                    <div class="list-container">
                        {remainsReports.map(report => (
                            <article class="card remains-report-card" data-report-id={report.id}>
                                <div class="card-header"><span>بواسطة: {report.supervisorName}</span><time>{report.createdAtFormatted}</time></div>

                                <div class="card-content">
                                    <div class="card-body">
                                        <div class="remains-item-display">
                                            <p class="item-name"><strong>الصنف:</strong> {report.itemName}</p>
                                            <p class="item-quantity"><strong>الكمية:</strong> {report.quantity}</p>
                                        </div>

                                        {report.notes && <div class="notes-section"><h4>ملاحظات:</h4><p>{report.notes}</p></div>}
                                        {report.imageUrl && (
                                            <div class="attachments">
                                                <h3 class="attachments-title">المرفقات:</h3>
                                                <div class="image-gallery">
                                                    <a href={report.imageUrl} target="_blank" rel="noopener noreferrer" class="image-thumbnail">
                                                        <img src={report.imageUrl} alt="صورة مرفقة" loading="lazy" />
                                                    </a>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                    <div class="card-footer">
                                        <button type="button" class="action-btn delete-btn" data-delete-url={`/admin/projects/${id}/remains-reports?delete=${report.id}`}>حذف</button>
                                    </div>
                                </div>
                            </article>
                        ))}
                    </div>
                )}
            </section>
        </div>

        <div id="delete-modal" class="modal-overlay">
            <div class="modal-content">
                <p>هل أنت متأكد أنك تريد حذف هذا التقرير؟</p>
                <div class="modal-actions">
                    <button id="cancel-delete-btn" class="action-btn cancel-btn-toggle">إلغاء</button>
                    <a id="confirm-delete-btn" href="#" class="action-btn delete-btn">نعم، حذف</a>
                </div>
            </div>
        </div>
    </main>
</Layout>

<script>
    import { auth, db } from '../../../../firebase/client';
    import { onAuthStateChanged, signOut } from "firebase/auth";
    import { doc, getDoc } from "firebase/firestore";

    document.addEventListener('DOMContentLoaded', () => {
        const authLoadingMessage = document.getElementById('auth-loading-message');
        const loginContainer = document.getElementById('admin-login-container');
        const pageContent = document.getElementById('page-content');

        onAuthStateChanged(auth, async (user) => {
            if(authLoadingMessage) authLoadingMessage.style.display = 'none';
            if (user) {
                 try {
                    const userDocRef = doc(db, "users", user.uid);
                    const userDoc = await getDoc(userDocRef);
                    if (userDoc.exists() && userDoc.data().role === 'admin') {
                        if(pageContent) pageContent.style.display = 'block';
                        if(loginContainer) loginContainer.style.display = 'none';
                        const logoutButton = document.getElementById('logout-button');
                        if (logoutButton) {
                            logoutButton.addEventListener('click', async () => {
                                await signOut(auth);
                                window.location.href = '/admin';
                            });
                        }
                    } else {
                        await signOut(auth);
                        window.location.href = '/admin';
                    }
                } catch (error) {
                    console.error('Auth Check Error:', error);
                    await signOut(auth);
                    if(loginContainer) loginContainer.style.display = 'block';
                    if(pageContent) pageContent.style.display = 'none';
                }
            } else {
                if(pageContent) pageContent.style.display = 'none';
                if(loginContainer) loginContainer.style.display = 'block';
            }
        });
        const container = document.querySelector('.container');
        if (!container) return;
        container.addEventListener('click', (e) => {
            const target = e.target;
            if (target.matches('.delete-btn')) {
                const deleteUrl = target.dataset.deleteUrl;
                if(deleteUrl) showDeleteModal(deleteUrl);
            }
        });
        const deleteModal = document.getElementById('delete-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        function showDeleteModal(deleteUrl) {
            if(confirmDeleteBtn) confirmDeleteBtn.href = deleteUrl;
            if(deleteModal) deleteModal.style.display = 'flex';
        }
        function hideDeleteModal() { 
            if(deleteModal) deleteModal.style.display = 'none'; 
        }
        if(cancelDeleteBtn) cancelDeleteBtn.addEventListener('click', hideDeleteModal);
        if(deleteModal) deleteModal.addEventListener('click', e => { 
            if (e.target === deleteModal) hideDeleteModal(); 
        });
    });
</script>

<style>
.auth-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; width: 100%; }
.auth-container p { font-size: 1.2rem; }
.btn-logout { background-color: #ef4444; color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: background-color 0.2s; }
.btn-logout:hover { background-color: #dc2626; }
.page-header div:last-child { display: flex; align-items: center; gap: 1rem; }
:root { 
    --primary-color: #007bff; 
    --success-color: #28a745;
    --danger-color: #dc3545;
    --border-color: #e9ecef; 
    --card-shadow: 0 4px 15px rgba(0,0,0,0.06);
    --remains-color: #6f42c1; /* Purple for remains */
}
.reports-display-page { direction: rtl; font-family: 'Cairo', sans-serif; background-color: #f8f9fa; padding: 2.5rem; }
.container { max-width: 1100px; margin: 0 auto; }
.page-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1.5rem; margin-bottom: 2.5rem; }
h1 { font-size: 2.25rem; font-weight: 800; }
.page-subtitle { color: #6c757d; }
.back-link { color: var(--primary-color); font-weight: 600; text-decoration: none; background-color: #e7f3ff; padding: 0.6rem 1rem; border-radius: 8px; }

.feedback-banner { padding: 1rem 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; text-align: center; font-weight: 600; }
.feedback-banner.success { background-color: #d4edda; color: #155724; }
.feedback-banner.error { background-color: #f8d7da; color: #721c24; }

.no-items-card { background: #fff; border: 1px dashed #ced4da; border-radius: 12px; padding: 3rem; text-align: center; color: #6c757d; }
.list-container { display: flex; flex-direction: column; gap: 1.75rem; }

.card { background: #fff; border-radius: 12px; box-shadow: var(--card-shadow); border: 1px solid var(--border-color); overflow: hidden; }
.card-header { display: flex; justify-content: space-between; padding: 1rem 1.5rem; background: #fdfdff; border-bottom: 1px solid var(--border-color); font-size: 0.9rem; color: #6c757d; }

.card-body { padding: 1.5rem; }

/* New simplified display for remains item */
.remains-item-display {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 1.5rem;
    border-left: 5px solid var(--remains-color);
}
.remains-item-display p {
    margin: 0 0 0.75rem 0;
    font-size: 1.1rem;
    color: #495057;
}
.remains-item-display p:last-child {
    margin-bottom: 0;
}
.remains-item-display strong {
    font-weight: 700;
    color: #343a40;
    margin-left: 8px;
}

.notes-section, .attachments { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color); }
h4 { font-weight: 700; margin-bottom: 1rem; }
.attachments-title { font-size: 1rem; }
.notes-section p { line-height: 1.8; margin: 0; color: #495057; }

.image-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 0.75rem; }
.image-thumbnail img { width: 100%; height: 90px; object-fit: cover; border-radius: 8px; }

.card-footer { display: flex; justify-content: flex-end; gap: 0.75rem; padding: 1rem 1.5rem; background-color: #f8f9fa; border-top: 1px solid var(--border-color); }
.action-btn { padding: 0.5rem 1.25rem; border: none; border-radius: 8px; font-weight: 600; text-decoration: none; cursor: pointer; }
.delete-btn { background-color: var(--danger-color); color: #fff; }
.cancel-btn-toggle { background-color: #6c757d; color: #fff;}

.modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: none; align-items: center; justify-content: center; z-index: 1000; }
.modal-content { background: #fff; padding: 2rem; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); text-align: center; max-width: 400px; width: 90%; }
.modal-actions { display: flex; justify-content: center; gap: 1rem; margin-top: 2rem; }
</style>