---
import Layout from '../../../../layouts/Layout.astro';
import AdminLogin from '../../../../components/AdminLogin.astro';
import { db } from "../../../../firebase/admin";

export const prerender = false;

const { id } = Astro.params;
let project = null;
let items = [];
let error = null;
let success = null;

// Handle Add Item Form Submission
if (Astro.request.method === 'POST') {
    try {
        const formData = await Astro.request.formData();
        let name = formData.get('name'); // This will now hold the final value from the hidden input

        // If 'other' is selected, use the value from the 'other-name' input
        if (name === 'اخرى') {
            name = formData.get('other-name');
        }

        const unit = formData.get('unit');
        const quantity = parseFloat(formData.get('quantity'));
        const unitPrice = parseFloat(formData.get('unitPrice'));

        if (!name || !unit || isNaN(quantity) || isNaN(unitPrice)) {
            throw new Error('يرجى ملء جميع الحقول المطلوبة والتأكد من أن الكمية والسعر أرقام.');
        }

        const totalPrice = quantity * unitPrice;

        await db.collection('projects').doc(id).collection('items').add({
            name,
            unit,
            quantity,
            unitPrice,
            totalPrice,
            createdAt: new Date()
        });

        return Astro.redirect(`/admin/projects/${id}/items?success=true`);

    } catch (err) {
        error = err.message;
    }
}

if (Astro.url.searchParams.get('success') === 'true') {
    success = 'تمت إضافة البند بنجاح!';
}

// Fetch Project Details and Items
try {
    const projectDoc = await db.collection('projects').doc(id).get();
    if (projectDoc.exists) {
        project = { id: projectDoc.id, name: projectDoc.data().projectName };

        const itemsSnapshot = await db.collection('projects').doc(id).collection('items').orderBy('createdAt', 'desc').get();
        items = itemsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

    } else {
        return Astro.redirect('/404');
    }
} catch (err) {
    console.error("Error fetching project data in items.astro:", err);
    error = "حدث خطأ أثناء تحميل بيانات المشروع.";
}
---
<Layout title={`بنود المشروع: ${project ? project.name : ''}`}>
    <div id="auth-loading-message" class="auth-container">
        <p>جارٍ التحقق من صلاحيات الدخول...</p>
    </div>

    <div id="admin-login-container" class="auth-container" style="display: none;">
        <AdminLogin />
    </div>

    <main id="page-content" style="display: none;">
        <div class="container">
            <header class="page-header">
                <div>
                    <h1>بنود المشروع: {project ? project.name : '...'}</h1>
                    <p class="page-subtitle">هنا يمكنك عرض وإدارة بنود المشروع.</p>
                </div>
                <div class="header-actions">
                    <button id="toggle-form-btn" class="btn btn-primary">+ إضافة بند جديد</button>
                    <a href={`/admin/projects/${id}`} class="back-link">&larr; العودة للتفاصيل</a>
                    <button id="logout-button" class="btn-logout">تسجيل الخروج</button>
                </div>
            </header>

            {success && <p class="success-message">{success}</p>}
            {error && <p class="error-message">{error}</p>}

            <!-- Add Item Form (Hidden by default) -->
            <div id="add-item-form" style="display: none;" class="form-container">
                 <h2>نموذج إضافة بند جديد</h2>
                <form method="POST">
                    <!-- This hidden input will hold the final item name for submission -->
                    <input type="hidden" id="name" name="name" />

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="main-category">الفئة الرئيسية</label>
                            <select id="main-category" required>
                                <option value="" disabled selected>-- اختر فئة --</option>
                                <option value="بند العماله">بند العماله</option>
                                <option value="بند المقاول">بند المقاول</option>
                                <option value="بند الخرسانه">بند الخرسانه</option>
                                <option value="بند المباني">بند المباني</option>
                                <option value="بند الكهرباء">بند الكهرباء</option>
                                <option value="بند السباكه">بند السباكه</option>
                                <option value="بند المحاره">بند المحاره</option>
                                <option value="بند الرخام">بند الرخام</option>
                                <option value="بند الدهانات">بند الدهانات</option>
                                <option value="بند تشطيبات الكهرباء">بند تشطيبات الكهرباء</option>
                                <option value="بند المجلس">بند المجلس</option>
                                <option value="بند الحفر">بند الحفر</option>
                                <option value="بند الهدم">بند الهدم</option>
                                <option value="اخرى">اخرى</option>
                            </select>
                        </div>

                        <div class="form-group" id="sub-category-group" style="display: none;">
                            <label for="sub-category">البند الفرعي</label>
                            <select id="sub-category"></select>
                        </div>

                        <div class="form-group" id="other-name-group" style="display: none;">
                            <label for="other-name">اسم البند (آخر)</label>
                            <input type="text" id="other-name" name="other-name" placeholder="ادخل اسم البند الجديد">
                        </div>

                        <div class="form-group">
                            <label for="unit">الوحدة</label>
                            <input type="text" id="unit" name="unit" required>
                        </div>
                        <div class="form-group">
                            <label for="quantity">الكمية</label>
                            <input type="number" id="quantity" name="quantity" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="unitPrice">سعر الوحدة</label>
                            <input type="number" id="unitPrice" name="unitPrice" step="0.01" required>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn">حفظ البند</button>
                        <button type="button" id="cancel-btn" class="btn btn-secondary">إلغاء</button>
                    </div>
                </form>
            </div>

            <!-- Items Table -->
            <div class="content-area">
                 {items.length > 0 ? (
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th>اسم البند</th>
                                <th>الوحدة</th>
                                <th>الكمية</th>
                                <th>سعر الوحدة</th>
                                <th>الإجمالي</th>
                                <th>إجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                            {items.map(item => (
                                <tr>
                                    <td>{item.name}</td>
                                    <td>{item.unit}</td>
                                    <td>{item.quantity}</td>
                                    <td>{item.unitPrice.toFixed(2)}</td>
                                    <td>{item.totalPrice.toFixed(2)}</td>
                                    <td class="actions-cell">
                                        <a href="#" class="btn-action btn-edit">تعديل</a>
                                        <a href="#" class="btn-action btn-delete">حذف</a>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                ) : (
                    <p>لا توجد بنود حالياً في هذا المشروع. يمكنك إضافة بند جديد باستخدام الزر أعلاه.</p>
                )}
            </div>
        </div>
    </main>
</Layout>

<script>
    import { auth, db } from '../../../../firebase/client';
    import { onAuthStateChanged, signOut } from "firebase/auth";
    import { doc, getDoc } from "firebase/firestore";

    document.addEventListener('DOMContentLoaded', () => {
        // Auth Check Logic (remains the same)
        const authLoadingMessage = document.getElementById('auth-loading-message');
        const loginContainer = document.getElementById('admin-login-container');
        const pageContent = document.getElementById('page-content');

        onAuthStateChanged(auth, async (user) => {
            if(authLoadingMessage) authLoadingMessage.style.display = 'none';
            if (!user) {
                if(pageContent) pageContent.style.display = 'none';
                if(loginContainer) loginContainer.style.display = 'block';
                return;
            }
             try {
                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists() && userDoc.data().role === 'admin') {
                    if(pageContent) pageContent.style.display = 'block';
                    if(loginContainer) loginContainer.style.display = 'none';
                    setupPageInteractions();
                } else {
                    await signOut(auth);
                    window.location.href = '/admin';
                }
            } catch (error) {
                console.error('Auth Check Error:', error);
                await signOut(auth);
                if(loginContainer) loginContainer.style.display = 'block';
                if(pageContent) pageContent.style.display = 'none';
            }
        });

        function setupPageInteractions() {
            // Logout Button
            const logoutButton = document.getElementById('logout-button');
            if (logoutButton) {
                logoutButton.addEventListener('click', async () => {
                    await signOut(auth);
                    window.location.href = '/admin';
                });
            }

            // Form Toggle Logic
            const toggleBtn = document.getElementById('toggle-form-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            const addItemForm = document.getElementById('add-item-form');

            if (toggleBtn && addItemForm) {
                toggleBtn.addEventListener('click', () => {
                    const isHidden = addItemForm.style.display === 'none';
                    addItemForm.style.display = isHidden ? 'block' : 'none';
                    toggleBtn.textContent = isHidden ? '- إلغاء الإضافة' : '+ إضافة بند جديد';
                });
            }
             if (cancelBtn && addItemForm && toggleBtn) {
                cancelBtn.addEventListener('click', () => {
                    addItemForm.style.display = 'none';
                    toggleBtn.textContent = '+ إضافة بند جديد';
                });
            }

            // --- Dynamic Dropdown Logic ---
            const subCategories = {
                'بند العماله': ['بند المصروف اليومي', 'بند اجرة العمال'],
                'بند الخرسانه': ['الاسمنت', 'الحديد', 'الزلط', 'الرمله', 'المقاول'],
                'بند المباني': ['رمله', 'اسمنت', 'طوب', 'تشوين', 'اجرة مباني'],
                'بند الكهرباء': ['بند الاساسيات', 'بند اجرة التركيب'],
                'بند السباكه': ['بند الاساسيات', 'بند اجرة التركيب'],
                'بند المحاره': ['الاسمنت', 'الرمله', 'اجرة عمال', 'تشوين'],
                'بند الرخام': ['تمن الرخام', 'تمن التركيب'],
                'بند الدهانات': ['مونه', 'اجره'],
                'بند تشطيبات الكهرباء': ['مونه', 'اجره'],
                'بند المجلس': ['مصروف الرخصه', 'التصالح', 'المحاضر'],
                'بند الحفر': ['اجرة العمال', 'المعدات'],
                'بند الهدم': ['اجرة عمال', 'المعدات']
            };

            const mainCategorySelect = document.getElementById('main-category');
            const subCategoryGroup = document.getElementById('sub-category-group');
            const subCategorySelect = document.getElementById('sub-category');
            const otherNameGroup = document.getElementById('other-name-group');
            const otherNameInput = document.getElementById('other-name');
            const hiddenNameInput = document.getElementById('name');

            mainCategorySelect.addEventListener('change', () => {
                const selectedCategory = mainCategorySelect.value;
                // Reset all conditional fields
                subCategoryGroup.style.display = 'none';
                otherNameGroup.style.display = 'none';
                otherNameInput.required = false;
                hiddenNameInput.value = '';

                if (subCategories[selectedCategory]) {
                    // Category has sub-categories
                    subCategorySelect.innerHTML = ''; // Clear previous options
                    subCategories[selectedCategory].forEach(sub => {
                        const option = document.createElement('option');
                        option.value = sub;
                        option.textContent = sub;
                        subCategorySelect.appendChild(option);
                    });
                    subCategoryGroup.style.display = 'block';
                    // Set hidden input to the first sub-category by default
                    hiddenNameInput.value = subCategorySelect.value;
                } else if (selectedCategory === 'اخرى') {
                    // 'Other' category selected
                    otherNameGroup.style.display = 'block';
                    otherNameInput.required = true;
                    hiddenNameInput.value = 'اخرى'; // Special value for backend
                } else {
                    // Simple category with no sub-categories
                    hiddenNameInput.value = selectedCategory;
                }
            });

            // Update the hidden input when the sub-category changes
            subCategorySelect.addEventListener('change', () => {
                hiddenNameInput.value = subCategorySelect.value;
            });
        }
    });
</script>

<style>
    :root {
        --primary-color: #0056b3; /* Darker Blue */
        --secondary-color: #6c757d; /* Gray */
        --success-color: #28a745; /* Green */
        --danger-color: #dc3545; /* Red */
        --border-color: #dee2e6;
        --background-color: #f4f6f9; /* Lighter Gray */
        --white-color: #fff;
        --shadow: 0 4px 15px rgba(0,0,0,0.07);
    }
    main { direction: rtl; font-family: 'Cairo', sans-serif; background-color: var(--background-color); min-height: 100vh; padding: 2rem; }
    .container { max-width: 1400px; margin: 0 auto; }
    .page-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--border-color); padding-bottom: 1.5rem; margin-bottom: 1.5rem; }
    h1 { font-size: 2.2rem; font-weight: 800; color: #333; }
    .page-subtitle { color: var(--secondary-color); margin-top: 0.25rem; }
    .header-actions { display: flex; align-items: center; gap: 1rem; }
    .back-link { color: var(--primary-color); font-weight: 600; text-decoration: none; padding: 0.7rem 1.2rem; border-radius: 8px; transition: background-color 0.2s; }
    .back-link:hover { background-color: #e9ecef; }
    .btn { padding: 0.7rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1rem; text-decoration: none; text-align: center; border: none; transition: transform 0.2s, box-shadow 0.2s;}
    .btn-primary { background-color: var(--primary-color); color: var(--white-color); }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 86, 179, 0.25); }
    .btn-secondary { background-color: var(--secondary-color); color: var(--white-color); }
    .btn-logout { background-color: var(--danger-color); color: white;}

    .success-message, .error-message { padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; text-align: center; font-weight: 600; }
    .success-message { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .error-message { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    
    .form-container { background: var(--white-color); padding: 2rem; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 2rem; }
    .form-container h2 { font-size: 1.5rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem;}
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; align-items: start; }
    .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
    .form-group input, .form-group select { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; transition: box-shadow 0.2s, border-color 0.2s; background-color: #fff; }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 86, 179, 0.2); }
    .form-actions { display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem; }
    
    .content-area { background: var(--white-color); border-radius: 12px; padding: 2rem; box-shadow: var(--shadow); }
    .items-table { width: 100%; border-collapse: collapse; }
    .items-table th, .items-table td { padding: 1rem; text-align: right; border-bottom: 1px solid var(--border-color); }
    .items-table th { font-weight: 700; background-color: #f8f9fa; }
    .items-table tbody tr:hover { background-color: #f1f3f5; }
    .actions-cell { display: flex; gap: 0.5rem; }
    .btn-action { padding: 0.3rem 0.8rem; border-radius: 6px; text-decoration: none; font-size: 0.9rem;}
    .btn-edit { background-color: #ffc107; color: #333;}
    .btn-delete { background-color: #ef4444; color: white;}

    .auth-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; width: 100%; }
    .auth-container p { font-size: 1.2rem; }
</style>