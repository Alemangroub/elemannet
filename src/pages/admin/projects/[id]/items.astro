---
import Layout from '../../../../layouts/Layout.astro';
import AdminLogin from '../../../../components/AdminLogin.astro';
import { db } from "../../../../firebase/admin";
import { Timestamp } from "firebase-admin/firestore";

export const prerender = false;

const { id } = Astro.params;
let project = null;
let items = [];
let error = null;
let success = null;

// Handle Add Item Form Submission
if (Astro.request.method === 'POST') {
    try {
        const formData = await Astro.request.formData();
        const name = formData.get('name');
        const personName = formData.get('personName');
        const quantity = parseFloat(formData.get('quantity'));
        const unitPrice = parseFloat(formData.get('unitPrice'));
        const itemDate = formData.get('itemDate');
        const notes = formData.get('notes'); // Get notes from the form

        if (!name || !personName || isNaN(quantity) || isNaN(unitPrice) || !itemDate) {
            throw new Error('يرجى ملء جميع الحقول المطلوبة والتأكد من صحة البيانات.');
        }

        const totalPrice = quantity * unitPrice;
        const createdAt = Timestamp.fromDate(new Date(itemDate));

        await db.collection('projects').doc(id).collection('items').add({
            name,
            personName,
            quantity,
            unitPrice,
            totalPrice,
            notes, // Save notes
            createdAt
        });

        return Astro.redirect(`/admin/projects/${id}/items?success=true`);

    } catch (err) {
        console.error("Error adding item:", err);
        error = err.message;
    }
}

if (Astro.url.searchParams.get('success') === 'true') {
    success = 'تمت إضافة البند بنجاح!';
}

// Fetch Project Details and Items
try {
    const projectDoc = await db.collection('projects').doc(id).get();
    if (projectDoc.exists) {
        project = { id: projectDoc.id, name: projectDoc.data().projectName };

        const itemsSnapshot = await db.collection('projects').doc(id).collection('items').orderBy('createdAt', 'desc').get();
        items = itemsSnapshot.docs.map(doc => {
            const data = doc.data();
            return {
                id: doc.id,
                ...data,
                createdAt: data.createdAt.toDate().toLocaleDateString('en-CA') 
            };
        });

    } else {
        return Astro.redirect('/404');
    }
} catch (err) {
    console.error("Error fetching project data in items.astro:", err);
    error = "حدث خطأ أثناء تحميل بيانات المشروع.";
}

// Get unique item names for the filter dropdown
const uniqueItemNames = [...new Set(items.map(item => item.name))];
---
<Layout title={`بنود المشروع: ${project ? project.name : ''}`}>
    <div id="auth-loading-message" class="auth-container">
        <p>جارٍ التحقق من صلاحيات الدخول...</p>
    </div>

    <div id="admin-login-container" class="auth-container" style="display: none;">
        <AdminLogin />
    </div>

    <main id="page-content" style="display: none;">
        <div class="container">
            <header class="page-header">
                <div>
                    <h1>بنود المشروع: {project ? project.name : '...'}</h1>
                    <p class="page-subtitle">هنا يمكنك عرض وإدارة بنود المشروع.</p>
                </div>
                <div class="header-actions">
                    <button id="toggle-form-btn" class="btn btn-primary">+ إضافة بند جديد</button>
                    <a href={`/admin/projects/${id}`} class="back-link">&larr; العودة للتفاصيل</a>
                    <button id="logout-button" class="btn-logout">تسجيل الخروج</button>
                </div>
            </header>

            {success && <p class="success-message">{success}</p>}
            {error && <p class="error-message">{error}</p>}

            <!-- Add Item Form (Hidden by default) -->
            <div id="add-item-form" style="display: none;" class="form-container">
                 <h2>نموذج إضافة بند جديد</h2>
                <form method="POST">
                    <input type="hidden" id="name" name="name" />

                    <div class="form-grid">
                         <div class="form-group">
                            <label for="itemDate">التاريخ</label>
                            <input type="date" id="itemDate" name="itemDate" required>
                        </div>
                        <div class="form-group">
                            <label for="personName">اسم الشخص/الجهة</label>
                            <input type="text" id="personName" name="personName" required placeholder="ادخل اسم المقاول أو المورد">
                        </div>
                        <div class="form-group">
                            <label for="main-category">الفئة الرئيسية (لتحديد اسم البند)</label>
                            <select id="main-category" required>
                                <option value="" disabled selected>-- اختر فئة --</option>
                                <option value="بند العماله">بند العماله</option>
                                <option value="بند المقاول">بند المقاول</option>
                                <option value="بند الخرسانه">بند الخرسانه</option>
                                <option value="بند المباني">بند المباني</option>
                                <option value="بند الكهرباء">بند الكهرباء</option>
                                <option value="بند السباكه">بند السباكه</option>
                                <option value="بند المحاره">بند المحاره</option>
                                <option value="بند الرخام">بند الرخام</option>
                                <option value="بند الدهانات">بند الدهانات</option>
                                <option value="بند تشطيبات الكهرباء">بند تشطيبات الكهرباء</option>
                                <option value="بند المجلس">بند المجلس</option>
                                <option value="بند الحفر">بند الحفر</option>
                                <option value="بند الهدم">بند الهدم</option>
                                <option value="اخرى">اخرى</option>
                            </select>
                        </div>
                        <div class="form-group" id="sub-category-group" style="display: none;">
                            <label for="sub-category">البند الفرعي</label>
                            <select id="sub-category"></select>
                        </div>
                        <div class="form-group" id="other-name-group" style="display: none;">
                            <label for="other-name">اسم البند (آخر)</label>
                            <input type="text" id="other-name" name="other-name" placeholder="ادخل اسم البند الجديد">
                        </div>
                        <div class="form-group">
                            <label for="quantity">الكمية</label>
                            <input type="number" id="quantity" name="quantity" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="unitPrice">سعر الوحدة</label>
                            <input type="number" id="unitPrice" name="unitPrice" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="totalPrice">الإجمالي</label>
                            <input type="number" id="totalPrice" name="totalPrice" step="0.01" disabled style="background-color: #e9ecef;">
                        </div>
                         <div class="form-group form-group-full-width">
                            <label for="notes">ملاحظات</label>
                            <textarea id="notes" name="notes" rows="3" placeholder="أضف ملاحظات..."></textarea>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">حفظ البند</button>
                        <button type="button" id="cancel-btn" class="btn btn-secondary">إلغاء</button>
                    </div>
                </form>
            </div>

            <!-- Items Table -->
            <div class="content-area">
                <div class="table-header">
                    <h2 class="table-title">قائمة البنود الحالية</h2>
                    <div class="filter-container">
                        <label for="item-filter">فلترة حسب البند:</label>
                        <select id="item-filter">
                            <option value="" disabled selected>-- اختر بندًا لعرض الجدول --</option>
                            <option value="all">عرض الكل</option>
                            {uniqueItemNames.map(name => <option value={name}>{name}</option>)}
                        </select>
                    </div>
                </div>

                <div id="table-container" style="display: none;">
                     {items.length > 0 ? (
                        <div class="table-wrapper">
                            <table class="items-table">
                                <thead>
                                    <tr>
                                        <th>التاريخ</th>
                                        <th>اسم البند</th>
                                        <th>اسم الشخص/الجهة</th>
                                        <th>الكمية</th>
                                        <th>سعر الوحدة</th>
                                        <th>الإجمالي</th>
                                        <th>ملاحظات</th>
                                        <th>إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {items.map(item => (
                                        <tr class="item-row" data-item-name={item.name}>
                                            <td data-label="التاريخ">{item.createdAt}</td>
                                            <td data-label="اسم البند">{item.name}</td>
                                            <td data-label="اسم الشخص/الجهة">{item.personName || '-'}</td>
                                            <td data-label="الكمية">{item.quantity}</td>
                                            <td data-label="سعر الوحدة">{item.unitPrice.toFixed(2)}</td>
                                            <td data-label="الإجمالي">{item.totalPrice.toFixed(2)}</td>
                                            <td data-label="ملاحظات">{item.notes || '-'}</td>
                                            <td data-label="إجراءات" class="actions-cell">
                                                <a href="#" class="btn-action btn-edit">تعديل</a>
                                                <a href="#" class="btn-action btn-delete">حذف</a>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    ) : (
                        <p class="no-items-message">لا توجد بنود حالياً في هذا المشروع. يمكنك إضافة بند جديد باستخدام الزر أعلاه.</p>
                    )}
                </div>
                 <p id="initial-message" class="no-items-message">الرجاء اختيار بند من القائمة أعلاه لعرض البيانات.</p>
            </div>
        </div>
    </main>
</Layout>

<script>
    import { auth, db } from '../../../../firebase/client';
    import { onAuthStateChanged, signOut } from "firebase/auth";
    import { doc, getDoc } from "firebase/firestore";

    document.addEventListener('DOMContentLoaded', () => {
        // Auth Check Logic 
        const authLoadingMessage = document.getElementById('auth-loading-message');
        const loginContainer = document.getElementById('admin-login-container');
        const pageContent = document.getElementById('page-content');

        onAuthStateChanged(auth, async (user) => {
            if(authLoadingMessage) authLoadingMessage.style.display = 'none';
            if (!user) {
                if(pageContent) pageContent.style.display = 'none';
                if(loginContainer) loginContainer.style.display = 'block';
                return;
            }
             try {
                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists() && userDoc.data().role === 'admin') {
                    if(pageContent) pageContent.style.display = 'block';
                    if(loginContainer) loginContainer.style.display = 'none';
                    setupPageInteractions();
                } else {
                    await signOut(auth);
                    window.location.href = '/admin';
                }
            } catch (error) {
                console.error('Auth Check Error:', error);
                await signOut(auth);
                if(loginContainer) loginContainer.style.display = 'block';
                if(pageContent) pageContent.style.display = 'none';
            }
        });

        function setupPageInteractions() {
            // Logout Button
            const logoutButton = document.getElementById('logout-button');
            if (logoutButton) {
                logoutButton.addEventListener('click', async () => {
                    await signOut(auth);
                    window.location.href = '/admin';
                });
            }

            // --- Set default date ---
            const itemDateInput = document.getElementById('itemDate');
            if(itemDateInput) {
                // toLocaleDateString with 'en-CA' gives YYYY-MM-DD format
                itemDateInput.value = new Date().toLocaleDateString('en-CA'); 
            }

            // Form Toggle Logic
            const toggleBtn = document.getElementById('toggle-form-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            const addItemForm = document.getElementById('add-item-form');

            if (toggleBtn && addItemForm) {
                toggleBtn.addEventListener('click', () => {
                    const isHidden = addItemForm.style.display === 'none';
                    addItemForm.style.display = isHidden ? 'block' : 'none';
                    toggleBtn.textContent = isHidden ? '- إلغاء الإضافة' : '+ إضافة بند جديد';
                });
            }
             if (cancelBtn && addItemForm && toggleBtn) {
                cancelBtn.addEventListener('click', () => {
                    addItemForm.style.display = 'none';
                    toggleBtn.textContent = '+ إضافة بند جديد';
                });
            }

            // --- Dynamic Dropdown Logic ---
            const subCategories = {
                'بند العماله': ['بند المصروف اليومي', 'بند اجرة العمال'],
                 'بند المقاول': ['بند لبشه عاديه', 'بند لبشه مسلحه'],
                'بند الخرسانه': ['الاسمنت', 'الحديد', 'الزلط', 'الرمله', 'المقاول'],
                'بند المباني': ['رمله', 'اسمنت', 'طوب', 'تشوين', 'اجرة مباني'],
                'بند الكهرباء': ['بند الاساسيات', 'بند اجرة التركيب'],
                'بند السباكه': ['بند الاساسيات', 'بند اجرة التركيب'],
                'بند المحاره': ['الاسمنت', 'الرمله', 'اجرة عمال', 'تشوين'],
                'بند الرخام': ['تمن الرخام', 'تمن التركيب'],
                'بند الدهانات': ['مونه', 'اجره'],
                'بند تشطيبات الكهرباء': ['مونه', 'اجره'],
                'بند المجلس': ['مصروف الرخصه', 'التصالح', 'المحاضر'],
                'بند الحفر': ['اجرة العمال', 'المعدات'],
                'بند الهدم': ['اجرة عمال', 'المعدات']
            };

            const mainCategorySelect = document.getElementById('main-category');
            const subCategoryGroup = document.getElementById('sub-category-group');
            const subCategorySelect = document.getElementById('sub-category');
            const otherNameGroup = document.getElementById('other-name-group');
            const otherNameInput = document.getElementById('other-name');
            const hiddenNameInput = document.getElementById('name');

            function updateHiddenItemName() {
                const mainCategory = mainCategorySelect.value;
                if (mainCategory === 'اخرى') {
                    hiddenNameInput.value = otherNameInput.value;
                } else if (subCategories[mainCategory]) {
                    hiddenNameInput.value = subCategorySelect.value;
                } else {
                    hiddenNameInput.value = mainCategory;
                }
            }

            mainCategorySelect.addEventListener('change', () => {
                const selectedCategory = mainCategorySelect.value;
                subCategoryGroup.style.display = 'none';
                otherNameGroup.style.display = 'none';
                otherNameInput.required = false;
                
                if (subCategories[selectedCategory]) {
                    subCategorySelect.innerHTML = '';
                    subCategories[selectedCategory].forEach(sub => {
                        const option = document.createElement('option');
                        option.value = sub;
                        option.textContent = sub;
                        subCategorySelect.appendChild(option);
                    });
                    subCategoryGroup.style.display = 'block';
                } else if (selectedCategory === 'اخرى') {
                    otherNameGroup.style.display = 'block';
                    otherNameInput.required = true;
                }
                updateHiddenItemName();
            });

            subCategorySelect.addEventListener('change', updateHiddenItemName);
            otherNameInput.addEventListener('input', updateHiddenItemName);


            // --- Auto-calculate Total Price ---
            const quantityInput = document.getElementById('quantity');
            const unitPriceInput = document.getElementById('unitPrice');
            const totalPriceInput = document.getElementById('totalPrice');

            function calculateTotal() {
                const quantity = parseFloat(quantityInput.value) || 0;
                const unitPrice = parseFloat(unitPriceInput.value) || 0;
                const total = quantity * unitPrice;
                totalPriceInput.value = total.toFixed(2);
            }

            quantityInput.addEventListener('input', calculateTotal);
            unitPriceInput.addEventListener('input', calculateTotal);

            // --- Filter Logic ---
            const itemFilter = document.getElementById('item-filter');
            const tableContainer = document.getElementById('table-container');
            const initialMessage = document.getElementById('initial-message');
            const itemRows = document.querySelectorAll('.item-row');

            itemFilter.addEventListener('change', () => {
                const selectedValue = itemFilter.value;

                if (!selectedValue) {
                    tableContainer.style.display = 'none';
                    initialMessage.style.display = 'block';
                    return;
                }

                tableContainer.style.display = 'block';
                initialMessage.style.display = 'none';

                itemRows.forEach(row => {
                    if (selectedValue === 'all' || row.dataset.itemName === selectedValue) {
                        row.style.display = ''; // Show the row
                    } else {
                        row.style.display = 'none'; // Hide the row
                    }
                });
            });
             // Set initial name on load
            updateHiddenItemName();
        }
    });
</script>

<style>
    :root {
        --primary-color: #0056b3; 
        --secondary-color: #6c757d; 
        --success-color: #28a745; 
        --danger-color: #dc3545; 
        --warning-color: #ffc107; 
        --border-color: #dee2e6;
        --background-color: #f4f6f9; 
        --white-color: #fff;
        --shadow: 0 4px 15px rgba(0,0,0,0.07);
        --table-header-bg: #e9ecef;
        --table-hover-bg: #f8f9fa;
        --table-stripe-bg: #fdfdfd;
    }
    main { direction: rtl; font-family: 'Cairo', sans-serif; background-color: var(--background-color); min-height: 100vh; padding: 2rem; }
    .container { max-width: 1400px; margin: 0 auto; }
    .page-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--border-color); padding-bottom: 1.5rem; margin-bottom: 1.5rem; }
    h1 { font-size: 2.2rem; font-weight: 800; color: #333; }
    .page-subtitle { color: var(--secondary-color); margin-top: 0.25rem; }
    .header-actions { display: flex; align-items: center; gap: 1rem; }
    .back-link { color: var(--primary-color); font-weight: 600; text-decoration: none; padding: 0.7rem 1.2rem; border-radius: 8px; transition: background-color 0.2s; }
    .back-link:hover { background-color: #e9ecef; }
    .btn { padding: 0.7rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1rem; text-decoration: none; text-align: center; border: none; transition: transform 0.2s, box-shadow 0.2s;}
    .btn-primary { background-color: var(--primary-color); color: var(--white-color); }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 86, 179, 0.25); }
    .btn-secondary { background-color: var(--secondary-color); color: var(--white-color); }
    .btn-logout { background-color: var(--danger-color); color: white;}

    .success-message, .error-message { padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; text-align: center; font-weight: 600; }
    .success-message { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .error-message { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    
    .form-container { background: var(--white-color); padding: 2rem; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 2rem; }
    .form-container h2 { font-size: 1.5rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem;}
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; align-items: start; }
    .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; transition: box-shadow 0.2s, border-color 0.2s; background-color: #fff; }
    .form-group-full-width { grid-column: 1 / -1; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 86, 179, 0.2); }
    .form-group input:disabled { background-color: #e9ecef; cursor: not-allowed; }
    .form-actions { display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem; }
    
    .content-area { background: var(--white-color); border-radius: 12px; padding: 2rem; box-shadow: var(--shadow); }
    .table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    .table-title { font-size: 1.5rem; font-weight: 700; color: #333; margin: 0; }
    .filter-container { display: flex; align-items: center; gap: 0.5rem; }
    .filter-container label { font-weight: 600; font-size: 0.9rem; }
    .filter-container select { padding: 0.5rem 0.8rem; border-radius: 6px; border: 1px solid var(--border-color); }

    .table-wrapper { overflow-x: auto; }
    .items-table { width: 100%; border-collapse: collapse; }
    .items-table th, .items-table td { padding: 1.25rem 1rem; text-align: right; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
    .items-table thead th { background-color: var(--table-header-bg); font-weight: 800; color: #333; text-transform: uppercase; font-size: 0.85rem; letter-spacing: 0.5px; }
    .items-table tbody tr:nth-child(even) { background-color: var(--table-stripe-bg); }
    .items-table tbody tr:hover { background-color: var(--table-hover-bg); }
    .no-items-message { text-align: center; padding: 2rem; font-size: 1.1rem; color: var(--secondary-color); }

    .actions-cell { display: flex; gap: 0.75rem; justify-content: flex-end; }
    .btn-action { padding: 0.4rem 0.9rem; border-radius: 6px; text-decoration: none; font-size: 0.9rem; font-weight: 600; transition: transform 0.2s; border: none; color: var(--white-color);}
    .btn-action:hover { transform: translateY(-2px); }
    .btn-edit { background-color: var(--warning-color); color: #333;}
    .btn-delete { background-color: var(--danger-color);}

    @media (max-width: 992px) {
        .items-table thead { display: none; }
        .items-table tr { display: block; margin-bottom: 1rem; border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .items-table td { display: block; text-align: left; padding-left: 50%; position: relative; border-bottom: 1px solid var(--border-color); }
        .items-table td:last-child { border-bottom: none; }
        .items-table td::before { content: attr(data-label); position: absolute; left: 1rem; width: 40%; padding-right: 10px; font-weight: 700; text-align: right; }
        .actions-cell { justify-content: flex-start; padding-left: 50%; }
    }

    .auth-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; width: 100%; }
    .auth-container p { font-size: 1.2rem; }
</style>