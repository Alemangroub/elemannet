---
import Layout from '../../../../layouts/Layout.astro';
import AdminLogin from '../../../../components/AdminLogin.astro';
import { db } from "../../../../firebase/admin";
import { Timestamp } from "firebase-admin/firestore";

export const prerender = false;

const csrfToken = Astro.locals.csrfToken;

const { id } = Astro.params;
let project = null;
let items = [];
let error = null;
let success = null;

if (Astro.request.method === 'POST') {
    try {
        const formData = await Astro.request.formData();
        const name = formData.get('name');
        const personName = formData.get('personName');
        const quantity = parseFloat(formData.get('quantity'));
        const unitPrice = parseFloat(formData.get('unitPrice'));
        const itemDate = formData.get('itemDate');
        const notes = formData.get('notes');

        if (!name || !personName || isNaN(quantity) || isNaN(unitPrice) || !itemDate) {
            throw new Error('يرجى ملء جميع الحقول المطلوبة والتأكد من صحة البيانات.');
        }

        const totalPrice = quantity * unitPrice;
        const createdAt = Timestamp.fromDate(new Date(itemDate));

        await db.collection('projects').doc(id).collection('items').add({
            name,
            personName,
            quantity,
            unitPrice,
            totalPrice,
            notes,
            createdAt
        });

        return Astro.redirect(`/admin/projects/${id}/items?success=true`);

    } catch (err) {
        console.error("Error adding item:", err);
        error = err.message;
    }
}

if (Astro.url.searchParams.get('success') === 'true') {
    success = 'تمت إضافة البند بنجاح!';
}

try {
    const projectDoc = await db.collection('projects').doc(id).get();
    if (projectDoc.exists) {
        project = { id: projectDoc.id, name: projectDoc.data().projectName };

        const itemsSnapshot = await db.collection('projects').doc(id).collection('items').orderBy('createdAt', 'desc').get();
        items = itemsSnapshot.docs.map(doc => {
            const data = doc.data();
            return {
                id: doc.id,
                ...data,
                createdAt: data.createdAt.toDate().toLocaleDateString('en-CA') 
            };
        });

    } else {
        return Astro.redirect('/404');
    }
} catch (err) {
    console.error("Error fetching project data in items.astro:", err);
    error = "حدث خطأ أثناء تحميل بيانات المشروع.";
}

const grandTotal = items.reduce((sum, item) => sum + (item.totalPrice || 0), 0);
const uniqueItemNames = [...new Set(items.map(item => item.name))];
---
<Layout title={`بنود المشروع: ${project ? project.name : ''}`}>
    <div id="auth-loading-message" class="auth-container">
        <p>جارٍ التحقق من صلاحيات الدخول...</p>
    </div>

    <div id="admin-login-container" class="auth-container" style="display: none;">
        <AdminLogin />
    </div>

    <main id="page-content" style="display: none;">
        <div class="container">
            <header class="page-header">
                <div>
                    <h1>بنود المشروع: {project ? project.name : '...'}</h1>
                    <p class="page-subtitle">هنا يمكنك عرض وإدارة بنود المشروع.</p>
                </div>
                <div class="header-actions">
                    <button id="toggle-form-btn" class="btn btn-primary">+ إضافة بند جديد</button>
                    <a href={`/admin/projects/${id}`} class="back-link">&larr; العودة للتفاصيل</a>
                    <button id="logout-button" class="btn-logout">تسجيل الخروج</button>
                </div>
            </header>

            {success && <p class="success-message">{success}</p>}
            {error && <p class="error-message">{error}</p>}

            <div id="add-item-form" style="display: none;" class="form-container">
                 <h2>نموذج إضافة بند جديد</h2>
                <form method="POST">
                    <input type="hidden" name="csrf_token" value={csrfToken} />
                    <input type="hidden" id="name" name="name" />
                    <div class="form-grid">
                         <div class="form-group">
                            <label for="itemDate">التاريخ</label>
                            <input type="date" id="itemDate" name="itemDate" required>
                        </div>
                        <div class="form-group">
                            <label for="personName">اسم الشخص/الجهة</label>
                            <input type="text" id="personName" name="personName" required placeholder="ادخل اسم المقاول أو المورد">
                        </div>
                        <div class="form-group">
                            <label for="main-category">الفئة الرئيسية (لتحديد اسم البند)</label>
                            <select id="main-category" required>
                                <option value="" disabled selected>-- اختر فئة --</option>
                                <option value="بند العماله">بند العماله</option>
                                <option value="بند المقاول">بند المقاول</option>
                                <option value="بند الخرسانه">بند الخرسانه</option>
                                <option value="بند المباني">بند المباني</option>
                                <option value="بند الكهرباء">بند الكهرباء</option>
                                <option value="بند السباكه">بند السباكه</option>
                                <option value="بند المحاره">بند المحاره</option>
                                <option value="بند الرخام">بند الرخام</option>
                                <option value="بند الدهانات">بند الدهانات</option>
                                <option value="بند تشطيبات الكهرباء">بند تشطيبات الكهرباء</option>
                                <option value="بند المجلس">بند المجلس</option>
                                <option value="بند الحفر">بند الحفر</option>
                                <option value="بند الهدم">بند الهدم</option>
                                <option value="اخرى">اخرى</option>
                            </select>
                        </div>
                        <div class="form-group" id="sub-category-group" style="display: none;">
                            <label for="sub-category">البند الفرعي</label>
                            <select id="sub-category"></select>
                        </div>
                        <div class="form-group" id="other-name-group" style="display: none;">
                            <label for="other-name">اسم البند (آخر)</label>
                            <input type="text" id="other-name" name="other-name" placeholder="ادخل اسم البند الجديد">
                        </div>
                        <div class="form-group">
                            <label for="quantity">الكمية</label>
                            <input type="number" id="quantity" name="quantity" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="unitPrice">سعر الوحدة</label>
                            <input type="number" id="unitPrice" name="unitPrice" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="totalPrice">الإجمالي</label>
                            <input type="number" id="totalPrice" name="totalPrice" step="0.01" disabled>
                        </div>
                         <div class="form-group form-group-full-width">
                            <label for="notes">ملاحظات</label>
                            <textarea id="notes" name="notes" rows="3" placeholder="أضف ملاحظات..."></textarea>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">حفظ البند</button>
                        <button type="button" id="cancel-btn" class="btn btn-secondary">إلغاء</button>
                    </div>
                </form>
            </div>

            <div class="content-area" id="items-content-area">
                <div class="table-header">
                    <div class="table-controls-left">
                        <h2 class="table-title">قائمة البنود الحالية</h2>
                        <div class="filter-container">
                            <div class="form-group">
                                <label for="main-category-filter">الفئة الرئيسية:</label>
                                <select id="main-category-filter">
                                    <option value="" disabled selected>-- اختر فئة --</option>
                                    <option value="all">عرض الكل</option>
                                </select>
                            </div>
                            <div class="form-group" id="sub-category-filter-group" style="display: none;">
                                <label for="sub-category-filter">البند الفرعي:</label>
                                <select id="sub-category-filter"></select>
                            </div>
                        </div>
                    </div>
                    <div class="table-controls-right totals-container">
                        <div class="total-box">
                            <span class="total-label">إجمالي البنود المفلترة:</span>
                            <span id="filtered-total" class="total-value">0.00 ج.م</span>
                        </div>
                        <div class="total-box grand-total-box">
                            <span class="total-label">إجمالي كل البنود:</span>
                            <span id="grand-total" class="total-value">{grandTotal.toFixed(2)} ج.م</span>
                        </div>
                    </div>
                </div>

                <div id="table-container" style="display: none;">
                     {items.length > 0 ? (
                        <div class="table-wrapper">
                            <table class="items-table">
                                <thead>
                                    <tr>
                                        <th>التاريخ</th>
                                        <th>اسم البند</th>
                                        <th>اسم الشخص/الجهة</th>
                                        <th>الكمية</th>
                                        <th>سعر الوحدة</th>
                                        <th>الإجمالي</th>
                                        <th>ملاحظات</th>
                                        <th>إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="items-table-body">
                                    {items.map(item => (
                                        <tr class="item-row" data-item-id={item.id} data-item-name={item.name} data-project-id={project.id} id={`item-row-${item.id}`} data-total-price={item.totalPrice}>
										<td data-label="التاريخ" data-field="createdAt">{item.createdAt}</td>
										<td data-label="اسم البند" data-field="name">{item.name}</td>
										<td data-label="اسم الشخص/الجهة" data-field="personName">{item.personName || '-'}</td>
										<td data-label="الكمية" data-field="quantity">{item.quantity}</td>
										<td data-label="سعر الوحدة" data-field="unitPrice">{item.unitPrice.toFixed(2)}</td>
										<td data-label="الإجمالي" data-field="totalPrice">{item.totalPrice.toFixed(2)}</td>
										<td data-label="ملاحظات" data-field="notes">{item.notes || '-'}</td>
                                        <td data-label="إجراءات" class="actions-cell">
                                            <div class="action-buttons-view">
                                                <button class="btn-action btn-edit">تعديل</button>
                                                <button class="btn-action btn-delete" data-project-id={id} data-item-id={item.id}>حذف</button>
                                                <button class="btn-action btn-print">طباعة</button>
                                                <button class="btn-action btn-pdf">تصدير PDF</button>
                                                <button class="btn-action btn-excel">تصدير Excel</button>
                                            </div>
                                            <div class="action-buttons-edit" style="display: none;">
                                                <button class="btn-action btn-save">حفظ</button>
                                                <button class="btn-action btn-cancel">إلغاء</button>
                                            </div>
                                        </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    ) : (
                        <p class="no-items-message">لا توجد بنود حالياً في هذا المشروع.</p>
                    )}
                </div>
                 <p id="initial-message" class="no-items-message">الرجاء اختيار فئة رئيسية من القائمة أعلاه لعرض البيانات.</p>
            </div>
        </div>

        <div id="delete-confirm-modal" class="modal-overlay" style="display: none;">
          <div class="modal-content">
            <h4>تأكيد الحذف</h4>
            <p>هل أنت متأكد من رغبتك في حذف هذا البند؟ لا يمكن التراجع عن هذا الإجراء.</p>
            <div class="modal-actions">
              <button id="delete-modal-cancel-btn" class="btn btn-secondary">إلغاء</button>
              <button id="delete-modal-confirm-btn" class="btn btn-danger">تأكيد الحذف</button>
            </div>
          </div>
        </div>

        <div id="save-confirm-modal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
              <h4>تأكيد الحفظ</h4>
              <p>هل أنت متأكد من رغبتك في حفظ التعديلات؟</p>
              <div class="modal-actions">
                <button id="save-modal-cancel-btn" class="btn btn-secondary">إلغاء</button>
                <button id="save-modal-confirm-btn" class="btn btn-primary">تأكيد الحفظ</button>
              </div>
            </div>
          </div>
    </main>
</Layout>

<script>
    console.log("Deployment version: 2"); // Diagnostic flag
    import { auth, db } from '../../../../firebase/client';
    import { onAuthStateChanged, signOut } from "firebase/auth";
    import { doc, getDoc, deleteDoc } from "firebase/firestore";

    document.addEventListener('DOMContentLoaded', () => {
        const authLoadingMessage = document.getElementById('auth-loading-message');
        const loginContainer = document.getElementById('admin-login-container');
        const pageContent = document.getElementById('page-content');

        onAuthStateChanged(auth, async (user) => {
            if(authLoadingMessage) authLoadingMessage.style.display = 'none';
            if (!user) {
                if(pageContent) pageContent.style.display = 'none';
                if(loginContainer) loginContainer.style.display = 'block';
                return;
            }
             try {
                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists() && userDoc.data().role === 'admin') {
                    if(pageContent) pageContent.style.display = 'block';
                    if(loginContainer) loginContainer.style.display = 'none';
                    setupPageInteractions();
                } else {
                    await signOut(auth);
                    window.location.href = '/admin';
                }
            } catch (error) {
                console.error('Auth Check Error:', error);
                if(loginContainer) loginContainer.style.display = 'block';
                if(pageContent) pageContent.style.display = 'none';
            }
        });

        function setupPageInteractions() {
            const logoutButton = document.getElementById('logout-button');
            if (logoutButton) {
                logoutButton.addEventListener('click', async () => {
                    await signOut(auth);
                    window.location.href = '/admin';
                });
            }

            const deleteModal = document.getElementById('delete-confirm-modal');
            const deleteModalConfirmBtn = document.getElementById('delete-modal-confirm-btn');
            const deleteModalCancelBtn = document.getElementById('delete-modal-cancel-btn');
            const saveModal = document.getElementById('save-confirm-modal');
            const saveModalConfirmBtn = document.getElementById('save-modal-confirm-btn');
            const saveModalCancelBtn = document.getElementById('save-modal-cancel-btn');
            
            let itemToDelete = null;
            let itemToSave = null;
            let currentEditRow = null;

            const itemsTableBody = document.getElementById('items-table-body');
            if (itemsTableBody) {
                itemsTableBody.addEventListener('click', (e) => {
                    const target = e.target.closest('.btn-action');
                    if (!target) return;
                    const row = target.closest('.item-row');
                    if (!row) return;

                    if (target.classList.contains('btn-delete')) handleDeleteClick(target);
                    else if (target.classList.contains('btn-edit')) handleEditClick(row);
                    else if (target.classList.contains('btn-cancel')) handleCancelClick(row);
                    else if (target.classList.contains('btn-save')) handleSaveClick(row);
                    else if (target.classList.contains('btn-print')) handlePrintItem(row);
                    else if (target.classList.contains('btn-pdf')) handlePdfExport(row, target);
                    else if (target.classList.contains('btn-excel')) handleExcelExport(row, target);
                });
            }

            function handleDeleteClick(button) {
                 itemToDelete = {
                     projectId: button.dataset.projectId,
                     itemId: button.dataset.itemId
                 };
                 if (deleteModal) deleteModal.style.display = 'flex';
            }

            function handleEditClick(row) {
                if (currentEditRow && currentEditRow !== row) {
                    handleCancelClick(currentEditRow);
                }
                currentEditRow = row;
                toggleEditState(row, true);
            }

            function handleCancelClick(row) {
                toggleEditState(row, false);
                currentEditRow = null;
            }

            function handleSaveClick(row) {
                itemToSave = row;
                if(saveModal) saveModal.style.display = 'flex';
            }
            
            function createPrintableContent(row, title) {
                const projectName = document.querySelector('h1').textContent || "تفاصيل البند";
                const cells = row.querySelectorAll('td[data-label]');
                let content = `
                    <h1>${projectName}</h1>
                    <h2>${title}</h2>
                    <table>
                        <tbody>`;

                cells.forEach(cell => {
                    const label = cell.getAttribute('data-label');
                    if (label === 'إجراءات') return; 
                    const value = cell.dataset.originalValue || cell.textContent.trim();
                    content += `<tr><th>${label}</th><td>${value}</td></tr>`;
                });

                content += `</tbody></table>`;
                return content;
            }

            function handlePrintItem(row) {
                const printContent = createPrintableContent(row, "تفاصيل البند");
                const printWindow = window.open('', '', 'height=700,width=800');
                
                if (!printWindow) {
                    alert('فشل فتح نافذة الطباعة. يرجى التأكد من السماح بالنوافذ المنبثقة (Pop-ups) لهذا الموقع.');
                    return;
                }
                
                const styles = `<style>
                        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
                        body { font-family: 'Cairo', sans-serif; direction: rtl; margin: 20px; }
                        h1, h2 { text-align: center; color: #333; }
                        h1 { font-size: 1.5rem; }
                        h2 { font-size: 1.2rem; color: #555; margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                        tr { border-bottom: 1px solid #eee; }
                        th, td { padding: 12px 15px; text-align: right; }
                        th { background-color: #f8f8f8; font-weight: 700; color: #555; width: 30%; }
                        @media print { body { -webkit-print-color-adjust: exact; } h1 {color: #000;} }
                    </style>`;

                printWindow.document.write(styles + printContent);
                printWindow.document.close();
                printWindow.focus();
                setTimeout(() => { printWindow.print(); }, 500);
            }

            async function handlePdfExport(row, button) {
                button.disabled = true;
                button.textContent = 'جارٍ...';
                try {
                    const { default: html2canvas } = await import('html2canvas');
                    const { jsPDF } = await import('jspdf');
                    
                    const contentToCapture = document.createElement('div');
                    contentToCapture.innerHTML = createPrintableContent(row, "تفاصيل البند");
                    contentToCapture.style.fontFamily = "'Cairo', sans-serif";
                    contentToCapture.style.direction = "rtl";
                    document.body.appendChild(contentToCapture);

                    const canvas = await html2canvas(contentToCapture, {
                        scale: 2, useCORS: true,
                        onclone: (doc) => {
                            const style = doc.createElement('style');
                            style.innerHTML = `
                            @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
                            body, div { font-family: 'Cairo', sans-serif !important; direction: rtl;}
                            table { width: 100%; border-collapse: collapse; } h1, h2 { text-align: center; } h1{font-size: 1.2em;} h2{font-size: 1em;}
                            tr { border-bottom: 1px solid #ddd; } th, td { padding: 8px; text-align: right; }
                            th { background-color: #f2f2f2; width: 30%; }`;
                            doc.body.appendChild(style);
                        }
                    });
                    
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const canvasWidth = canvas.width;
                    const canvasHeight = canvas.height;
                    const ratio = canvasWidth / canvasHeight;
                    const height = pdfWidth / ratio;

                    pdf.addImage(imgData, 'PNG', 10, 10, pdfWidth - 20, height - 10);
                    const itemName = row.querySelector('td[data-field="name"]').textContent.trim();
                    pdf.save(`item-${itemName}.pdf`);
                    document.body.removeChild(contentToCapture);
                } catch (err) {
                    console.error("PDF Export Error:", err);
                    alert("فشل تصدير PDF. يرجى المحاولة مرة أخرى.");
                } finally {
                    button.disabled = false;
                    button.textContent = 'تصدير PDF';
                }
            }

            async function handleExcelExport(row, button) {
                button.disabled = true;
                button.textContent = 'جارٍ...';
                try {
                    const XLSX = await import('xlsx');
                    const data = [];
                    const headers = [];
                    row.querySelectorAll('td[data-label]').forEach(cell => {
                        const label = cell.getAttribute('data-label');
                        if (label === 'إجراءات') return;
                        headers.push(label);
                        data.push(cell.textContent.trim());
                    });

                    const dataForSheet = [headers, data];
                    const ws = XLSX.utils.aoa_to_sheet(dataForSheet);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Item Details");

                    const itemName = row.querySelector('td[data-field="name"]').textContent.trim();
                    XLSX.writeFile(wb, `item-${itemName}.xlsx`);
                } catch (err) {
                    console.error("Excel Export Error:", err);
                    alert("فشل تصدير Excel. يرجى المحاولة مرة أخرى.");
                } finally {
                    button.disabled = false;
                    button.textContent = 'تصدير Excel';
                }
            }

            async function executeSave(row) {
                const itemId = row.dataset.itemId;
                const projectId = row.dataset.projectId;

                const updates = {};
                row.querySelectorAll('input, select').forEach(input => {
                    updates[input.name] = input.value;
                });

                if (!updates.name || !updates.personName || !updates.quantity || !updates.unitPrice || !updates.createdAt) {
                    alert('يرجى ملء جميع الحقول المطلوبة.');
                    return;
                }
                
                try {
                    const response = await fetch('/api/updateItem', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ projectId, itemId, ...updates }),
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error || 'فشل تحديث البند.');

                    row.querySelectorAll('td[data-field]').forEach(cell => {
                        const field = cell.dataset.field;
                        let newValue = result.data[field];
                        if (field === 'unitPrice' || field === 'totalPrice') {
                            newValue = parseFloat(newValue).toFixed(2);
                        }
                        cell.textContent = newValue;
                        cell.dataset.originalValue = newValue;
                    });
                    row.dataset.itemName = result.data.name; 

                    toggleEditState(row, false);
                    currentEditRow = null;
                } catch (error) {
                    console.error('Save Error:', error);
                    alert(`خطأ: ${error.message}`);
                    handleCancelClick(row); 
                }
            }

            function toggleEditState(row, isEditing) {
                const viewButtons = row.querySelector('.action-buttons-view');
                const editButtons = row.querySelector('.action-buttons-edit');

                if (isEditing) {
                    viewButtons.style.display = 'none';
                    editButtons.style.display = 'flex';
                    row.classList.add('editing');

                    row.querySelectorAll('td[data-field]').forEach(cell => {
                        const field = cell.dataset.field;
                        const currentValue = cell.textContent.trim();
                        cell.dataset.originalValue = currentValue;
                        let inputHtml;
                        switch (field) {
                            case 'createdAt': inputHtml = `<input type="date" name="createdAt" value="${currentValue}" class="form-control-inline">`; break;
                            case 'quantity':
                            case 'unitPrice': inputHtml = `<input type="number" name="${field}" value="${currentValue}" step="0.01" class="form-control-inline">`; break;
                            case 'name':
                            case 'personName':
                            case 'notes': inputHtml = `<input type="text" name="${field}" value="${currentValue}" class="form-control-inline">`; break;
                            case 'totalPrice': return;
                            default: return;
                        }
                        cell.innerHTML = inputHtml;
                    });

                    const quantityInput = row.querySelector('input[name="quantity"]');
                    const unitPriceInput = row.querySelector('input[name="unitPrice"]');
                    const totalPriceCell = row.querySelector('td[data-field="totalPrice"]');
                    const updateInlineTotal = () => {
                        const quantity = parseFloat(quantityInput.value) || 0;
                        const unitPrice = parseFloat(unitPriceInput.value) || 0;
                        totalPriceCell.textContent = (quantity * unitPrice).toFixed(2);
                    };
                    if (quantityInput && unitPriceInput) {
                        quantityInput.addEventListener('input', updateInlineTotal);
                        unitPriceInput.addEventListener('input', updateInlineTotal);
                    }
                } else {
                    viewButtons.style.display = 'flex';
                    editButtons.style.display = 'none';
                    row.classList.remove('editing');
                    row.querySelectorAll('td[data-field]').forEach(cell => {
                        if (cell.querySelector('input, select')) {
                           cell.textContent = cell.dataset.originalValue;
                        }
                    });
                }
            }

            if (deleteModalCancelBtn) {
                deleteModalCancelBtn.addEventListener('click', () => {
                    if (deleteModal) deleteModal.style.display = 'none';
                    itemToDelete = null;
                });
            }
            if (deleteModalConfirmBtn) {
                deleteModalConfirmBtn.addEventListener('click', async () => {
                    if (!itemToDelete) return;
                    const { projectId, itemId } = itemToDelete;
                    const row = document.getElementById(`item-row-${itemId}`);
                    deleteModalConfirmBtn.disabled = true;
                    deleteModalConfirmBtn.textContent = 'جاري الحذف...';
                    try {
                        const itemRef = doc(db, 'projects', projectId, 'items', itemId);
                        await deleteDoc(itemRef);
                        if(row) row.remove();
                    } catch (error) {
                        console.error("Error deleting item: ", error);
                        alert("حدث خطأ أثناء محاولة الحذف. يرجى المحاولة مرة أخرى.");
                    } finally {
                        if (deleteModal) deleteModal.style.display = 'none';
                        itemToDelete = null;
                        deleteModalConfirmBtn.disabled = false;
                        deleteModalConfirmBtn.textContent = 'تأكيد الحذف';
                    }
                });
            }

            if (saveModalCancelBtn) {
                saveModalCancelBtn.addEventListener('click', () => {
                    if (saveModal) saveModal.style.display = 'none';
                    itemToSave = null;
                });
            }
            if (saveModalConfirmBtn) {
                saveModalConfirmBtn.addEventListener('click', async () => {
                    if (!itemToSave) return;
                    saveModalConfirmBtn.disabled = true;
                    saveModalConfirmBtn.textContent = 'جاري الحفظ...';
                    await executeSave(itemToSave);
                    if (saveModal) saveModal.style.display = 'none';
                    itemToSave = null;
                    saveModalConfirmBtn.disabled = false;
                    saveModalConfirmBtn.textContent = 'تأكيد الحفظ';
                });
            }

            const itemDateInput = document.getElementById('itemDate');
            if(itemDateInput) itemDateInput.value = new Date().toLocaleDateString('en-CA');

            const toggleBtn = document.getElementById('toggle-form-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            const addItemForm = document.getElementById('add-item-form');

            if (toggleBtn && addItemForm) {
                toggleBtn.addEventListener('click', () => {
                    const isHidden = addItemForm.style.display === 'none';
                    addItemForm.style.display = isHidden ? 'block' : 'none';
                    toggleBtn.textContent = isHidden ? '- إلغاء الإضافة' : '+ إضافة بند جديد';
                });
            }
            if (cancelBtn && addItemForm && toggleBtn) {
                cancelBtn.addEventListener('click', () => {
                    addItemForm.style.display = 'none';
                    toggleBtn.textContent = '+ إضافة بند جديد';
                });
            }

            const subCategories = { 'بند العماله': ['بند المصروف اليومي','بند اجرة العمال'],'بند المقاول':['بند لبشه عاديه','بند لبشه مسلحه'],'بند الخرسانه':['الاسمنت','الحديد','الزلط','الرمله','المقاول'],'بند المباني':['رمله','اسمنت','طوب','تشوين','اجرة مباني'],'بند الكهرباء':['بند الاساسيات','بند اجرة التركيب'],'بند السباكه':['بند الاساسيات','بند اجرة التركيب'],'بند المحاره':['الاسمنت','الرمله','اجرة عمال','تشوين'],'بند الرخام':['تمن الرخام','تمن التركيب'],'بند الدهانات':['مونه','اجره'],'بند تشطيبات الكهرباء':['مونه','اجره'],'بند المجلس':['مصروف الرخصه','التصالح','المحاضر'],'بند الحفر':['اجرة العمال','المعدات'],'بند الهدم':['اجرة عمال','المعدات'] };
            
            const mainCategorySelect=document.getElementById('main-category');
            const subCategoryGroup=document.getElementById('sub-category-group');
            const subCategorySelect=document.getElementById('sub-category');
            const otherNameGroup=document.getElementById('other-name-group');
            const otherNameInput=document.getElementById('other-name');
            const hiddenNameInput=document.getElementById('name');
            function updateHiddenItemName(){const mainCategory=mainCategorySelect.value;if(mainCategory==='اخرى'){hiddenNameInput.value=otherNameInput.value}else if(subCategories[mainCategory]){hiddenNameInput.value=subCategorySelect.value}else{hiddenNameInput.value=mainCategory}}mainCategorySelect.addEventListener('change',()=>{const selectedCategory=mainCategorySelect.value;subCategorySelect.innerHTML='';otherNameGroup.style.display='none';otherNameInput.required=false;if(subCategories[selectedCategory]){subCategories[selectedCategory].forEach(sub=>{const option=document.createElement('option');option.value=sub;option.textContent=sub;subCategorySelect.appendChild(option)});subCategoryGroup.style.display='block'}else if(selectedCategory==='اخرى'){otherNameGroup.style.display='block';otherNameInput.required=true}updateHiddenItemName()});subCategorySelect.addEventListener('change',updateHiddenItemName);otherNameInput.addEventListener('input',updateHiddenItemName);updateHiddenItemName();

            const quantityInput = document.getElementById('quantity');
            const unitPriceInput = document.getElementById('unitPrice');
            const totalPriceInput = document.getElementById('totalPrice');
            function calculateTotal(){const quantity=parseFloat(quantityInput.value)||0;const unitPrice=parseFloat(unitPriceInput.value)||0;totalPriceInput.value=(quantity*unitPrice).toFixed(2)}if(quantityInput&&unitPriceInput){quantityInput.addEventListener('input',calculateTotal);unitPriceInput.addEventListener('input',calculateTotal);}

            const mainCategoryFilter = document.getElementById('main-category-filter');
            const subCategoryFilterGroup = document.getElementById('sub-category-filter-group');
            const subCategoryFilter = document.getElementById('sub-category-filter');
            const tableContainer = document.getElementById('table-container');
            const initialMessage = document.getElementById('initial-message');
            const filteredTotalEl = document.getElementById('filtered-total');

            function updateFilteredTotal() {
                const allRows = document.querySelectorAll('#items-table-body .item-row');
                let filteredTotal = 0;
                allRows.forEach(row => {
                    if (row.style.display !== 'none') {
                        const price = parseFloat(row.dataset.totalPrice) || 0;
                        filteredTotal += price;
                    }
                });
                if (filteredTotalEl) {
                    filteredTotalEl.textContent = `${filteredTotal.toFixed(2)} ج.م`;
                }
            }
            
            if(mainCategoryFilter) {
                const allRows = Array.from(document.querySelectorAll('.item-row'));
                const mainCategories = Object.keys(subCategories);
                mainCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    mainCategoryFilter.appendChild(option);
                });

                mainCategoryFilter.addEventListener('change', () => {
                    const selectedMain = mainCategoryFilter.value;

                    if (!selectedMain || selectedMain === 'all') {
                        if(subCategoryFilterGroup) subCategoryFilterGroup.style.display = 'none';
                        if(tableContainer) tableContainer.style.display = selectedMain === 'all' ? 'block' : 'none';
                        if(initialMessage) initialMessage.style.display = selectedMain === 'all' ? 'none' : 'block';
                        allRows.forEach(row => row.style.display = '');
                        updateFilteredTotal();
                        return;
                    }

                    const subs = subCategories[selectedMain];
                    if (subs && subs.length > 0) {
                        if(subCategoryFilter) {
                            subCategoryFilter.innerHTML = ''; 
                            const allSubsOption = document.createElement('option');
                            allSubsOption.value = 'all-subs';
                            allSubsOption.textContent = `جميع بنود ${selectedMain}`;
                            subCategoryFilter.appendChild(allSubsOption);

                            subs.forEach(sub => {
                                const option = document.createElement('option');
                                option.value = sub;
                                option.textContent = sub;
                                subCategoryFilter.appendChild(option);
                            });
                            if(subCategoryFilterGroup) subCategoryFilterGroup.style.display = 'block';
                            subCategoryFilter.dispatchEvent(new Event('change')); 
                        }
                    } else {
                        if(subCategoryFilterGroup) subCategoryFilterGroup.style.display = 'none';
                        if(tableContainer) tableContainer.style.display = 'block';
                        if(initialMessage) initialMessage.style.display = 'none';
                        allRows.forEach(row => {
                            row.style.display = row.dataset.itemName === selectedMain ? '' : 'none';
                        });
                         updateFilteredTotal();
                    }
                });

                if (subCategoryFilter) {
                    subCategoryFilter.addEventListener('change', () => {
                        const selectedMain = mainCategoryFilter.value;
                        const selectedSub = subCategoryFilter.value;
                        const mainSubs = subCategories[selectedMain] || [];

                        if(tableContainer) tableContainer.style.display = 'block';
                        if(initialMessage) initialMessage.style.display = 'none';

                        allRows.forEach(row => {
                            const itemName = row.dataset.itemName;
                            let show = false;
                            if (selectedSub === 'all-subs') {
                                if (mainSubs.includes(itemName)) {
                                    show = true;
                                }
                            } else {
                                if (itemName === selectedSub) {
                                    show = true;
                                }
                            }
                            row.style.display = show ? '' : 'none';
                        });
                        updateFilteredTotal();
                    });
                }
            }
            
            const successMessage = document.querySelector('.success-message');
            if (successMessage) {
                setTimeout(() => {
                    successMessage.style.opacity = '0';
                    setTimeout(() => {
                        successMessage.remove();
                        const url = new URL(window.location);
                        url.searchParams.delete('success');
                        history.replaceState(null, '', url.toString());
                    }, 500);
                }, 5000);
            }

        }
    });
</script>

<style>
    :root {
        --primary-color: #0056b3; 
        --secondary-color: #6c757d; 
        --success-color: #28a745; 
        --danger-color: #dc3545; 
        --warning-color: #ffc107; 
        --info-color: #17a2b8;
        --border-color: #dee2e6;
        --background-color: #f4f6f9; 
        --white-color: #fff;
        --shadow: 0 4px 15px rgba(0,0,0,0.07);
        --table-header-bg: #e9ecef;
        --table-hover-bg: #f8f9fa;
        --table-stripe-bg: #fdfdfd;
    }
    main { direction: rtl; font-family: 'Cairo', sans-serif; background-color: var(--background-color); min-height: 100vh; padding: 2rem; }
    .container { max-width: 1400px; margin: 0 auto; }
    .page-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--border-color); padding-bottom: 1.5rem; margin-bottom: 1.5rem; }
    h1 { font-size: 2.2rem; font-weight: 800; color: #333; }
    .page-subtitle { color: var(--secondary-color); margin-top: 0.25rem; }
    .header-actions { display: flex; align-items: center; gap: 1rem; }
    .back-link { color: var(--primary-color); font-weight: 600; text-decoration: none; padding: 0.7rem 1.2rem; border-radius: 8px; transition: background-color 0.2s; }
    .back-link:hover { background-color: #e9ecef; }
    .btn { padding: 0.7rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1rem; text-decoration: none; text-align: center; border: none; transition: all 0.2s;}
    .btn-primary { background-color: var(--primary-color); color: var(--white-color); }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 86, 179, 0.25); }
    .btn-secondary { background-color: var(--secondary-color); color: var(--white-color); }
    .btn-logout { background-color: var(--danger-color); color: white;}
    .btn-danger { background-color: var(--danger-color); color: var(--white-color); }

    .success-message, .error-message { padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; text-align: center; font-weight: 600; transition: opacity 0.5s ease-out; }
    .success-message { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .error-message { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    
    .form-container { background: var(--white-color); padding: 2rem; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 2rem; }
    .form-container h2 { font-size: 1.5rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem;}
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; align-items: start; }
    .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; transition: box-shadow 0.2s, border-color 0.2s; background-color: #fff; }
    .form-group-full-width { grid-column: 1 / -1; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 86, 179, 0.2); }
    .form-group input:disabled { background-color: #e9ecef; cursor: not-allowed; }
    .form-actions { display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem; }
    
    .content-area { background: var(--white-color); border-radius: 12px; padding: 2rem; box-shadow: var(--shadow); }
    
    .table-header { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem; }
    .table-controls-left { display: flex; flex-direction: column; gap: 1rem; flex-grow: 1; }
    .table-title { font-size: 1.5rem; font-weight: 700; color: #333; margin: 0; }
    .filter-container { display: flex; align-items: flex-end; gap: 1rem; flex-wrap: wrap;}
    
    .totals-container { display: flex; gap: 1rem; flex-wrap: wrap; align-self: flex-end; }
    .total-box { background-color: var(--table-header-bg); padding: 0.75rem 1.25rem; border-radius: 8px; text-align: right; border: 1px solid var(--border-color); }
    .total-box.grand-total-box { background-color: #e8f0fe; border-color: #a8c5ff; }
    .total-label { display: block; color: var(--secondary-color); font-size: 0.9rem; margin-bottom: 0.25rem; font-weight: 500; }
    .total-value { display: block; font-size: 1.4rem; font-weight: 700; }
    .grand-total-box .total-value { color: #0b57d0; }
    #filtered-total { color: #333; }
    
    .table-wrapper { overflow-x: auto; }
    .items-table { width: 100%; border-collapse: collapse; }
    .items-table th, .items-table td { padding: 1.25rem 1rem; text-align: right; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
    .items-table thead th { background-color: var(--table-header-bg); font-weight: 800; color: #333; text-transform: uppercase; font-size: 0.85rem; letter-spacing: 0.5px; }
    .items-table tbody tr:nth-child(even) { background-color: var(--table-stripe-bg); }
    .items-table tbody tr:hover { background-color: var(--table-hover-bg); }
    .no-items-message { text-align: center; padding: 2rem; font-size: 1.1rem; color: var(--secondary-color); }
    
    .items-table tr.editing td { padding-top: 0.75rem; padding-bottom: 0.75rem; }
    .form-control-inline { width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.95rem; }

    .actions-cell .action-buttons-view, .actions-cell .action-buttons-edit { display: flex; gap: 0.5rem; justify-content: flex-end; align-items: center; flex-wrap: wrap; }
    .btn-action { padding: 0.4rem 0.8rem; border-radius: 6px; text-decoration: none; font-size: 0.85rem; font-weight: 600; transition: transform 0.2s; border: none; color: var(--white-color); cursor: pointer; margin: 2px 0; }
    .btn-action:hover { transform: translateY(-2px); }
    .btn-edit { background-color: var(--warning-color); color: #333;}
    .btn-delete { background-color: var(--danger-color);}
    .btn-save { background-color: var(--success-color); }
    .btn-cancel { background-color: var(--secondary-color); }
    .btn-print { background-color: var(--primary-color); }
    .btn-pdf { background-color: #E63946; } 
    .btn-excel { background-color: #1D6F42; }

    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .modal-content { background: #fff; padding: 2.5rem; border-radius: 12px; width: 90%; max-width: 450px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .modal-content h4 { margin-top: 0; font-size: 1.5rem; color: #333; font-weight: 800; }
    .modal-content p { margin-bottom: 1rem; color: #555; font-size: 1.1rem; }
    .modal-actions { display: flex; justify-content: center; gap: 1rem; margin-top: 2rem; }
    .modal-actions .btn { font-size: 1rem; padding: 0.7rem 1.5rem; }
    .modal-actions .btn-danger { background-color: var(--danger-color) !important; color: var(--white-color) !important; }

    @media (max-width: 992px) {
        .items-table thead { display: none; }
        .items-table tr { display: block; margin-bottom: 1rem; border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .items-table td { display: block; text-align: left; padding-left: 50%; position: relative; border-bottom: 1px solid var(--border-color); }
        .items-table td:last-child { border-bottom: none; }
        .items-table td::before { content: attr(data-label); position: absolute; left: 1rem; width: 40%; padding-right: 10px; font-weight: 700; text-align: right; }
        .actions-cell { justify-content: flex-start; padding-left: 50%; }
        .actions-cell .action-buttons-view { justify-content: flex-start; }
        .table-header { align-items: stretch; } 
        .totals-container { justify-content: space-around; width: 100%; }
        .total-box { flex-grow: 1; text-align: center; }
    }

    .auth-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; width: 100%; }
    .auth-container p { font-size: 1.2rem; }
</style>
