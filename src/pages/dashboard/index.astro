---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="لوحة تحكم المشرف">
  <main class="supervisor-dashboard-page">

    <!-- Auth Loading State -->
    <div id="auth-loading-message"><p>جارٍ التحقق من صلاحيات الدخول...</p></div>

    <!-- Main Dashboard Content (hidden by default) -->
    <div id="dashboard-content" style="display: none;">
      <header class="dashboard-header">
        <div>
          <h1>لوحة تحكم المشرف</h1>
          <p>مرحباً بك، <span id="user-name-placeholder"></span>! هذه هي المشاريع المسؤول عنها.</p>
        </div>
        <button id="logout-button" class="btn btn-logout">تسجيل الخروج</button>
      </header>
      <div id="projects-list" class="projects-container"></div>
      <div id="no-projects-message" class="info-message" style="display: none;"><p>لم يتم تعيين أي مشاريع لك حتى الآن.</p></div>
    </div>

  </main>

</Layout>

<script>
  import { auth, db, storage } from '../../firebase/client';
  import { onAuthStateChanged, signOut } from "firebase/auth";
  import { collection, getDocs, query, where, getDoc, doc, addDoc, serverTimestamp } from "firebase/firestore";
  import { ref, uploadBytesResumable, getDownloadURL } from "firebase/storage";

  function initializeDashboard() {
    let currentSupervisor = { uid: null, name: '' };
    let stagedExpenses = {};
    let stagedLeftovers = {};

    const loadingMessage = document.getElementById('auth-loading-message');
    const dashboardContent = document.getElementById('dashboard-content');
    const userNamePlaceholder = document.getElementById('user-name-placeholder');
    const projectsList = document.getElementById('projects-list');
    const noProjectsMessage = document.getElementById('no-projects-message');
    const logoutButton = document.getElementById('logout-button');

    if (!dashboardContent || !projectsList) return;

    async function handleFormSubmit(e) {
        e.preventDefault();
        const form = e.target;
        const projectId = form.dataset.projectId;
        const submitButton = form.querySelector('button[type="submit"]');
        const isDailyReportForm = form.matches('.report-form');

        submitButton.disabled = true;
        submitButton.textContent = 'جارٍ الحفظ...';

        try {
            if (isDailyReportForm) {
                await saveDailyReport(form, projectId);
            } else if (form.matches('.expense-form')) {
                await saveExpenseReport(form, projectId);
            } else if (form.matches('.leftovers-form')) {
                await saveLeftoversReport(form, projectId);
            }

            alert('تم حفظ التقرير بنجاح!');

            if (isDailyReportForm) {
                window.location.reload();
            } else {
                form.reset();
                const projectGroup = document.querySelector(`[data-project-group-id="${projectId}"]`);
                if (projectGroup) {
                    const formCard = form.closest('.form-card');
                    if (formCard) formCard.style.display = 'none';
                }
            }

        } catch (error) {
            console.error("Submission Error:", error);
            let errorMessage = 'حدث خطأ أثناء حفظ التقرير. يرجى المحاولة مرة أخرى.';
            if (error instanceof Error) {
                if (error.message === 'At least one expense item is required') {
                    errorMessage = 'يجب إضافة بند مصروف واحد على الأقل قبل الحفظ.';
                } else if (error.message === 'At least one leftover item is required') {
                    errorMessage = 'يجب إضافة بند باقٍ واحد على الأقل قبل الحفظ.';
                } else if (error.message === 'Report text is required') {
                    errorMessage = 'نص التقرير مطلوب للحفظ.';
                }
            }
            alert(errorMessage);
        } finally {
            // Only re-enable the button if the page is not going to be reloaded
            if (!isDailyReportForm) {
                submitButton.disabled = false;
                 if (form.matches('.expense-form')) {
                    submitButton.textContent = 'حفظ المصروفات';
                } else if (form.matches('.leftovers-form')) {
                    submitButton.textContent = 'حفظ البواقي';
                }
            }
        }
    }

    projectsList.addEventListener('submit', handleFormSubmit);

    projectsList.addEventListener('click', (e) => {
        const target = e.target;
        const projectGroup = target.closest('.project-group');
        if (!projectGroup) return;
        const projectId = projectGroup.dataset.projectGroupId;

        if (target.matches('.btn-toggle-expense')) {
            projectGroup.querySelector('.expense-card').style.display = 'block';
            projectGroup.querySelector('.report-card').style.display = 'none';
            projectGroup.querySelector('.leftovers-card').style.display = 'none';
        }

        if (target.matches('.btn-toggle-report')) {
            projectGroup.querySelector('.expense-card').style.display = 'none';
            projectGroup.querySelector('.report-card').style.display = 'block';
            projectGroup.querySelector('.leftovers-card').style.display = 'none';
        }

        if (target.matches('.btn-toggle-leftovers')) {
            projectGroup.querySelector('.expense-card').style.display = 'none';
            projectGroup.querySelector('.report-card').style.display = 'none';
            projectGroup.querySelector('.leftovers-card').style.display = 'block';
        }

        if (target.matches('.btn-cancel-expense')) {
            projectGroup.querySelector('.expense-card').style.display = 'none';
            stagedExpenses[projectId] = [];
            renderStagedItems(projectId, projectGroup.querySelector('.expense-form'), 'staged-expenses-list', stagedExpenses);
        }
         if (target.matches('.btn-cancel-report')) {
            projectGroup.querySelector('.report-card').style.display = 'none';
        }

        if (target.matches('.btn-cancel-leftovers')) {
            projectGroup.querySelector('.leftovers-card').style.display = 'none';
            stagedLeftovers[projectId] = [];
             renderStagedItems(projectId, projectGroup.querySelector('.leftovers-form'), 'staged-leftovers-list', stagedLeftovers);
        }

        if (target.matches('.btn-add-item')) {
            const form = target.closest('form');
            const isLeftovers = form.matches('.leftovers-form');
            const itemNameInput = form.querySelector('.item-name');
            const amountInput = form.querySelector('.item-amount');

            const itemName = itemNameInput.value.trim();
            const amount = amountInput.value.trim();

            if (!itemName) { alert(`يرجى إدخال ${isLeftovers ? 'الصنف' : 'البند'}.`); return; }
            if (!amount) { alert('يرجى إدخال الكمية.'); return; }

            const stagedItems = isLeftovers ? stagedLeftovers : stagedExpenses;
            const listClassName = isLeftovers ? 'staged-leftovers-list' : 'staged-expenses-list';

            if (!stagedItems[projectId]) stagedItems[projectId] = [];
            stagedItems[projectId].push({ id: Date.now(), name: itemName, amount: amount });
            renderStagedItems(projectId, form, listClassName, stagedItems);

            itemNameInput.value = '';
            amountInput.value = '';
        }

        if (target.matches('.btn-delete-item')) {
            const form = target.closest('form');
            const isLeftovers = form.matches('.leftovers-form');
            const stagedItems = isLeftovers ? stagedLeftovers : stagedExpenses;
            const listClassName = isLeftovers ? 'staged-leftovers-list' : 'staged-expenses-list';
            const itemId = parseInt(target.getAttribute('data-id'), 10);
            if(stagedItems[projectId]) {
                stagedItems[projectId] = stagedItems[projectId].filter(item => item.id !== itemId);
                renderStagedItems(projectId, form, listClassName, stagedItems);
            }
        }
    });

    onAuthStateChanged(auth, async (user) => {
      if (user) {
          const userDocRef = doc(db, "users", user.uid);
          const userDoc = await getDoc(userDocRef);
          if (userDoc.exists() && userDoc.data().role === 'supervisor') {
              currentSupervisor.uid = user.uid;
              currentSupervisor.name = userDoc.data().name || 'المشرف';
              userNamePlaceholder.textContent = currentSupervisor.name;
              await fetchAndDisplayProjects(currentSupervisor.uid);
              loadingMessage.style.display = 'none';
              dashboardContent.style.display = 'block';
          } else { window.location.href = '/admin'; }
      } else { window.location.href = '/admin'; }
    });

    async function uploadFiles(files, projectId, folder) {
        const uploadPromises = Array.from(files).map(file => {
            const storageRef = ref(storage, `${folder}/${projectId}/${Date.now()}_${file.name}`);
            const uploadTask = uploadBytesResumable(storageRef, file);
            return new Promise((resolve, reject) => {
                uploadTask.on('state_changed', 
                    (snapshot) => { /* Progress */ }, 
                    (error) => reject(error), 
                    () => getDownloadURL(uploadTask.snapshot.ref).then(resolve)
                );
            });
        });
        return Promise.all(uploadPromises);
    }

    async function saveDailyReport(form, projectId) {
        const reportText = form.querySelector('.report-text').value;
        if (!reportText.trim()) throw new Error('Report text is required');
        const imageFiles = form.querySelector('.report-images').files;

        const imageUrls = await uploadFiles(imageFiles, projectId, 'daily_reports');

        await addDoc(collection(db, 'daily_reports'), {
            projectId: projectId,
            supervisorId: currentSupervisor.uid,
            supervisorName: currentSupervisor.name, 
            reportText: reportText,
            imageUrls: imageUrls,
            isRead: false,
            createdAt: serverTimestamp()
        });
    }

    async function saveExpenseReport(form, projectId) {
        const items = stagedExpenses[projectId] || [];
        if (items.length === 0) throw new Error('At least one expense item is required');
        const notes = form.querySelector('.expense-notes').value;
        const imageFiles = form.querySelector('.expense-images').files;

        const imageUrls = await uploadFiles(imageFiles, projectId, 'daily_expenses');

        await addDoc(collection(db, 'daily_expenses'), {
            projectId: projectId,
            supervisorId: currentSupervisor.uid,
            supervisorName: currentSupervisor.name,
            items: items.map(item => ({ name: item.name, amount: parseFloat(item.amount) })), // Storing clean data
            notes: notes,
            imageUrls: imageUrls,
            isRead: false,
            createdAt: serverTimestamp()
        });
        stagedExpenses[projectId] = []; // Clear staged items after saving
    }

    async function saveLeftoversReport(form, projectId) {
        const items = stagedLeftovers[projectId] || [];
        if (items.length === 0) throw new Error('At least one leftover item is required');
        const notes = form.querySelector('.leftovers-notes').value;

        await addDoc(collection(db, 'remains_reports'), {
            projectId: projectId,
            supervisorId: currentSupervisor.uid,
            supervisorName: currentSupervisor.name,
            items: items, // Storing items as they are
            notes: notes,
            isRead: false,
            createdAt: serverTimestamp()
        });
        stagedLeftovers[projectId] = []; // Clear staged items after saving
    }

    async function fetchAndDisplayProjects(supervisorUid) {
      try {
          const projectsQuery = query(collection(db, "projects"), where("supervisorIds", "array-contains", supervisorUid));
          const projectsSnapshot = await getDocs(projectsQuery);
          const supervisedProjects = projectsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

          if (supervisedProjects.length === 0) {
              noProjectsMessage.style.display = 'block';
              projectsList.innerHTML = '';
              return;
          }

          const allSupervisorIds = [...new Set(supervisedProjects.flatMap(p => p.supervisorIds || []))];
          const supervisorsMap = new Map();
          if (allSupervisorIds.length > 0) {
              const supervisorDocs = await Promise.all(allSupervisorIds.map(id => getDoc(doc(db, "users", id))));
              supervisorDocs.forEach(doc => {
                  if (doc.exists()) supervisorsMap.set(doc.id, doc.data().name || 'اسم غير معروف');
              });
          }

          const enrichedProjects = supervisedProjects.map(project => ({
              ...project,
              supervisorNames: (project.supervisorIds || []).map(id => supervisorsMap.get(id) || 'اسم غير معروف')
          }));

          noProjectsMessage.style.display = 'none';
          projectsList.innerHTML = enrichedProjects.map(createProjectCards).join('');

      } catch (error) {
          console.error("Error fetching supervisor projects:", error);
          projectsList.innerHTML = '<p class="error-message">حدث خطأ أثناء تحميل المشاريع.</p>';
      }
    }

    function createProjectCards(project) {
        stagedExpenses[project.id] = [];
        stagedLeftovers[project.id] = [];
        const supervisorNamesHtml = project.supervisorNames.join(', ');
        return `
          <div class="project-group" data-project-group-id="${project.id}">
              <div class="project-card">
                  <div class="card-details">
                      <div class="card-item"><span class="item-label">اسم المشروع</span><p class="item-value">${project.projectName}</p></div>
                      <div class="card-item"><span class="item-label">عنوان المشروع</span><p class="item-value">${project.projectAddress || 'غير محدد'}</p></div>
                      <div class="card-item"><span class="item-label">المشرفون</span><p class="item-value">${supervisorNamesHtml}</p></div>
                  </div>
                  <div class="card-actions">
                      <button class="btn btn-action btn-toggle-expense">مصروفات يومية</button>
                      <button class="btn btn-action btn-toggle-report">تقرير يومي</button>
                      <button class="btn btn-action btn-toggle-leftovers">تقرير البواقي</button>
                  </div>
              </div>
              
              <div class="form-card expense-card" style="display: none;">
                   <form class="expense-form" data-project-id="${project.id}">
                      <header class="form-card-header"><h2>إضافة مصروفات يومية لمشروع: ${project.projectName}</h2></header>
                      <div class="form-section-title">إضافة بند مصروف</div>
                      <div class="add-item-container">
                          <div class="form-group"><label>اختر البند</label><input type="text" class="item-name" placeholder="اسم البند"></div>
                          <div class="form-group"><label>المبلغ (ج.م)</label><input type="number" class="item-amount" placeholder="0.00"></div>
                          <button type="button" class="btn btn-add-item">+ إضافة البند</button>
                      </div>
                      <div class="staged-items-container" style="display: none;"><div class="form-section-title">البنود المضافة</div><ul class="staged-expenses-list"></ul></div>
                      <div class="form-section-title">تفاصيل إضافية</div>
                      <div class="form-group"><label>ملاحظات (اختياري)</label><textarea class="expense-notes" rows="3"></textarea></div>
                      <div class="form-group"><label>إرفاق صور (اختياري)</label><input type="file" class="expense-images" multiple accept="image/*"></div>
                      <div class="upload-progress" style="display: none;"></div>
                      <div class="form-actions"><button type="submit" class="btn btn-submit">حفظ المصروفات</button><button type="button" class="btn btn-cancel-expense">إلغاء</button></div>
                  </form>
              </div>

              <div class="form-card leftovers-card" style="display: none;">
                   <form class="leftovers-form" data-project-id="${project.id}">
                      <header class="form-card-header"><h2>إضافة تقرير بواقي لمشروع: ${project.projectName}</h2></header>
                      <div class="form-section-title">إضافة بند باقي</div>
                      <div class="add-item-container">
                          <div class="form-group"><label>الصنف</label><input type="text" class="item-name" placeholder="اسم الصنف"></div>
                          <div class="form-group"><label>الكمية</label><input type="text" class="item-amount" placeholder="مثال: 10 شكاير"></div>
                          <button type="button" class="btn btn-add-item">+ إضافة البند</button>
                      </div>
                      <div class="staged-items-container" style="display: none;"><div class="form-section-title">البنود المضافة</div><ul class="staged-leftovers-list"></ul></div>
                      <div class="form-section-title">تفاصيل إضافية</div>
                      <div class="form-group"><label>ملاحظات (اختياري)</label><textarea class="leftovers-notes" rows="3"></textarea></div>
                      <div class="form-actions"><button type="submit" class="btn btn-submit">حفظ البواقي</button><button type="button" class="btn btn-cancel-leftovers">إلغاء</button></div>
                  </form>
              </div>

              <div class="form-card report-card" style="display: none;">
                  <form class="report-form" data-project-id="${project.id}">
                      <header class="form-card-header"><h2>إضافة تقرير يومي لمشروع: ${project.projectName}</h2></header>
                      <div class="form-group"><label>نص التقرير</label><textarea class="report-text" rows="6" required placeholder="اكتب هنا تفاصيل سير العمل، المشاكل، التقدم المحرز..."></textarea></div>
                      <div class="form-group"><label>إرفاق صور (اختياري)</label><input type="file" class="report-images" multiple accept="image/*"></div>
                      <div class="upload-progress" style="display: none;"></div>
                      <div class="form-actions"><button type="submit" class="btn btn-submit">حفظ التقرير</button><button type="button" class="btn-cancel-report">إلغاء</button></div>
                  </form>
              </div>
          </div>
        `;
    }

    function renderStagedItems(projectId, form, listClassName, stagedItems) {
      const list = form.querySelector(`.${listClassName}`);
      const container = form.closest('.form-card').querySelector('.staged-items-container');
      if (!list || !container) return;
      
      list.innerHTML = '';
      if (!stagedItems[projectId] || stagedItems[projectId].length === 0) {
          container.style.display = 'none';
          return;
      }
      
      container.style.display = 'block';
      stagedItems[projectId].forEach(item => {
          const li = document.createElement('li');
          li.className = 'staged-item';
          const unit = listClassName === 'staged-leftovers-list' ? '' : ' ج.م';
          const amountDisplay = listClassName === 'staged-leftovers-list' ? item.amount : parseFloat(item.amount).toFixed(2);
          li.innerHTML = `<span>${item.name}</span> <span class="item-amount">${amountDisplay}${unit}</span><button type="button" class="btn-delete-item" data-id="${item.id}">&times;</button>`;
          list.appendChild(li);
      });
    }

    if (logoutButton) logoutButton.addEventListener('click', async () => {
        try { await signOut(auth); window.location.href = '/admin'; } 
        catch (error) { console.error("Logout Error:", error); }
    });
  }

  initializeDashboard();
  document.addEventListener('astro:after-swap', initializeDashboard);

</script>

<style is:global>
  :root { --primary-color: #3b82f6; --secondary-color: #10b981; --danger-color: #ef4444; --gray-color: #6b7280; --warning-color: #f59e0b; }
  .supervisor-dashboard-page { direction: rtl; font-family: 'Cairo', sans-serif; background-color: #f4f7f6; min-height: 100vh; padding: 2rem; }
  #auth-loading-message, .info-message { text-align: center; padding: 5rem 1rem; font-size: 1.2rem; color: #555; }
  .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 3rem; padding-bottom: 1.5rem; border-bottom: 2px solid #e2e8f0; }
  .btn-logout { background-color: var(--danger-color); color: white; }
  .projects-container { display: flex; flex-direction: column; gap: 1.5rem; width: 100%; max-width: 900px; margin: 0 auto; }
  
  .project-card, .form-card { background: #ffffff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.07); padding: 1.5rem 2rem; }
  .project-card { display: flex; flex-direction: column; align-items: stretch; gap: 1.5rem; }
  .card-details { display: flex; justify-content: space-between; flex-wrap: wrap; gap: 1rem; }
  .card-item { min-width: 200px; flex-grow: 1; }
  .item-label { font-size: 0.9rem; font-weight: 700; color: #718096; }
  .item-value { font-size: 1.2rem; font-weight: 600; color: #2d3748; }
  
  .card-actions { display: flex; gap: 1rem; justify-content: center; }
  .btn-action { font-weight: 700; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; transition: all 0.2s; flex-grow: 1; text-align: center; }
  .btn-toggle-expense { background-color: var(--primary-color); color: white; }
  .btn-toggle-report { background-color: var(--secondary-color); color: white; }
  .btn-toggle-leftovers { background-color: var(--warning-color); color: white; }

  .form-card { margin-top: -1rem; border-top-left-radius: 0; border-top-right-radius: 0; border-top: 1px solid #e2e8f0; }
  .form-card-header { padding-bottom: 1rem; margin-bottom: 1.5rem; border-bottom: 2px solid #e2e8f0; }
  .form-card-header h2 { font-size: 1.4rem; font-weight: 700; color: #1a202c; }

  .expense-form, .report-form, .leftovers-form { display: flex; flex-direction: column; gap: 1.5rem; }
  .form-group { margin: 0; }
  label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
  input, select, textarea { width: 100%; padding: 0.75rem; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 1rem; box-sizing: border-box; }

  .form-section-title { font-size: 1.2rem; font-weight: 700; margin-top: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #e5e7eb; }
  .add-item-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; align-items: flex-end; }
  .other-description-group { grid-column: 1 / -1; }
  .btn-add-item { background-color: var(--secondary-color); color: white; grid-column: 1 / -1; padding: 0.8rem; }

  .staged-items-container { background-color: #f9fafb; border-radius: 8px; padding: 1rem; }
  .staged-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0.5rem; border-bottom: 1px solid #e5e7eb; }
  .item-amount { font-weight: 700; color: #059669; }
  .btn-delete-item { background: #fee2e2; color: var(--danger-color); border-radius: 50%; width: 28px; height: 28px; font-size: 1.2rem; }

  .form-actions { display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem; }
  .btn, .btn-submit, .btn-cancel-expense, .btn-cancel-report, .btn-logout, .btn-add-item, .btn-delete-item { font-weight: 700; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
  .btn-submit { background-color: var(--primary-color); color: white; padding: 0.8rem 1.5rem; }
  .btn-cancel-expense, .btn-cancel-report, .btn-cancel-leftovers { background-color: var(--gray-color); color: white; padding: 0.8rem 1.5rem; }
</style>