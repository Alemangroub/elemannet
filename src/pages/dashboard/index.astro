---
import Layout from '../../layouts/Layout.astro';
--- 

<Layout title="لوحة تحكم المشرف">
  <main class="supervisor-dashboard-page">

    <!-- Auth Loading State -->
    <div id="auth-loading-message">
        <p>جارٍ التحقق من صلاحيات الدخول...</p>
    </div>

    <!-- Main Dashboard Content (hidden by default) -->
    <div id="dashboard-content" style="display: none;">
      <header class="dashboard-header">
        <div>
          <h1>لوحة تحكم المشرف</h1>
          <p>مرحباً بك، <span id="user-name-placeholder"></span>! هذه هي المشاريع المسؤولة عنها.</p>
        </div>
        <button id="logout-button" class="btn btn-logout">تسجيل الخروج</button>
      </header>

      <div id="projects-list" class="projects-grid"></div>
      <div id="no-projects-message" class="info-message" style="display: none;">
        <p>لم يتم تعيين أي مشاريع لك حتى الآن.</p>
      </div>
    </div>

  </main>
</Layout>

<script>
  import { auth, db } from '../../firebase/client';
  import { onAuthStateChanged, signOut } from "firebase/auth";
  import { collection, getDocs, query, where, getDoc, doc } from "firebase/firestore";

  const loadingMessage = document.getElementById('auth-loading-message')!;
  const dashboardContent = document.getElementById('dashboard-content')!;
  const userNamePlaceholder = document.getElementById('user-name-placeholder')!;
  const projectsList = document.getElementById('projects-list')!;
  const noProjectsMessage = document.getElementById('no-projects-message')!;
  const logoutButton = document.getElementById('logout-button')!;

  onAuthStateChanged(auth, async (user) => {
    if (user) {
        // User is authenticated, now check their role
        const userDocRef = doc(db, "users", user.uid);
        const userDoc = await getDoc(userDocRef);

        if (userDoc.exists() && userDoc.data().role === 'supervisor') {
            // User is a supervisor, proceed to fetch projects
            userNamePlaceholder.textContent = userDoc.data().name || 'المشرف';
            await fetchAndDisplayProjects(user.uid);
            loadingMessage.style.display = 'none';
            dashboardContent.style.display = 'block';
        } else {
            // User is not a supervisor or data is missing, redirect
            window.location.href = '/admin';
        }
    } else {
        // No user is logged in, redirect to login page
        window.location.href = '/admin';
    }
  });

  async function fetchAndDisplayProjects(supervisorUid) {
    try {
        // Use a more efficient query with 'array-contains'
        const q = query(collection(db, "projects"), where("supervisorIds", "array-contains", supervisorUid));
        const querySnapshot = await getDocs(q);

        const supervisedProjects = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        if (supervisedProjects.length === 0) {
            noProjectsMessage.style.display = 'block';
            projectsList.innerHTML = '';
        } else {
            noProjectsMessage.style.display = 'none';
            projectsList.innerHTML = supervisedProjects.map(project => {
                return '<a href="/projects/' + project.id + '" class="project-card-link">' +
                          '<div class="project-card">' +
                              '<h3>' + project.projectName + '</h3>' +
                              '<p>' + (project.projectAddress || 'العنوان غير محدد') + '</p>' +
                          '</div>' +
                       '</a>';
            }).join('');
        }
    } catch (error) {
        console.error("Error fetching projects: ", error);
        projectsList.innerHTML = '<p class="error-message">حدث خطأ أثناء تحميل المشاريع.</p>';
    }
  }

  logoutButton.addEventListener('click', async () => {
      try {
          await signOut(auth);
          // onAuthStateChanged will handle the redirect
      } catch (error) {
          console.error("Logout Error:", error);
          alert("فشل تسجيل الخروج. يرجى المحاولة مرة أخرى.");
      }
  });

</script>

<style>
  .supervisor-dashboard-page { direction: rtl; font-family: 'Cairo', sans-serif; background-color: #f4f7f6; min-height: 100vh; padding: 2rem; }
  #auth-loading-message { text-align: center; padding-top: 5rem; font-size: 1.2rem; }
  .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 2px solid #e2e8f0; }
  .dashboard-header h1 { font-size: 2.2rem; color: #1a202c; font-weight: 800; }
  .dashboard-header p { color: #4a5568; }
  .btn-logout { background-color: #ef4444; color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: background-color 0.2s; }
  .btn-logout:hover { background-color: #dc2626; }
  .projects-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
  .project-card-link { text-decoration: none; }
  .project-card { background-color: #fff; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.07); transition: transform 0.2s ease, box-shadow 0.2s ease; }
  .project-card:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
  .project-card h3 { font-size: 1.4rem; font-weight: 700; color: #3f51b5; margin: 0 0 0.5rem 0; }
  .project-card p { font-size: 1rem; color: #6b7280; margin: 0; }
  .info-message, .error-message { text-align: center; font-size: 1.1rem; color: #555; background-color: #fff; border-radius: 8px; padding: 2rem; }
</style>
