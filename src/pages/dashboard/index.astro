---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="لوحة تحكم المشرف">
  <main class="supervisor-dashboard-page">

    <!-- Auth Loading State -->
    <div id="auth-loading-message">
        <p>جارٍ التحقق من صلاحيات الدخول...</p>
    </div>

    <!-- Main Dashboard Content (hidden by default) -->
    <div id="dashboard-content" style="display: none;">
      <header class="dashboard-header">
        <div>
          <h1>لوحة تحكم المشرف</h1>
          <p>مرحباً بك، <span id="user-name-placeholder"></span>! هذه هي المشاريع المسؤولة عنها.</p>
        </div>
        <button id="logout-button" class="btn btn-logout">تسجيل الخروج</button>
      </header>

      <div id="projects-list" class="projects-grid"></div>
      <div id="no-projects-message" class="info-message" style="display: none;">
        <p>لم يتم تعيين أي مشاريع لك حتى الآن.</p>
      </div>
    </div>

  </main>
</Layout>

<script>
  import { auth, db } from '../../firebase/client';
  import { onAuthStateChanged, signOut } from "firebase/auth";
  import { collection, getDocs, query, where, getDoc, doc } from "firebase/firestore";

  const loadingMessage = document.getElementById('auth-loading-message')!;
  const dashboardContent = document.getElementById('dashboard-content')!;
  const userNamePlaceholder = document.getElementById('user-name-placeholder')!;
  const projectsList = document.getElementById('projects-list')!;
  const noProjectsMessage = document.getElementById('no-projects-message')!;
  const logoutButton = document.getElementById('logout-button')!;

  onAuthStateChanged(auth, async (user) => {
    if (user) {
        const userDocRef = doc(db, "users", user.uid);
        const userDoc = await getDoc(userDocRef);

        if (userDoc.exists() && userDoc.data().role === 'supervisor') {
            userNamePlaceholder.textContent = userDoc.data().name || 'المشرف';
            await fetchAndDisplayProjects(user.uid);
            loadingMessage.style.display = 'none';
            dashboardContent.style.display = 'block';
        } else {
            window.location.href = '/admin';
        }
    } else {
        window.location.href = '/admin';
    }
  });

  async function fetchAndDisplayProjects(supervisorUid) {
    try {
        const q = query(collection(db, "projects"), where("supervisorIds", "array-contains", supervisorUid));
        const querySnapshot = await getDocs(q);
        const supervisedProjects = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        if (supervisedProjects.length === 0) {
            noProjectsMessage.style.display = 'block';
            projectsList.innerHTML = '';
        } else {
            noProjectsMessage.style.display = 'none';
            projectsList.innerHTML = supervisedProjects.map(project => {
                // Card layout corrected with global styles in mind
                return `<a href="/dashboard/project/${project.id}" class="project-card">
                          <div class="project-card-content">
                            <h3>${project.projectName}</h3>
                            <p class="project-address">${project.projectAddress || 'العنوان غير محدد'}</p>
                            <div class="project-card-action">
                              <span>عرض التفاصيل</span>
                              <span class="arrow-icon">→</span>
                            </div>
                          </div>
                          <div class="project-card-icon-wrapper">
                            <svg xmlns="http://www.w3.org/2000/svg" class="card-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8h5z"/></svg>
                          </div>
                        </a>`;
            }).join('');
        }
    } catch (error) {
        console.error("Error fetching projects: ", error);
        projectsList.innerHTML = '<p class="error-message">حدث خطأ أثناء تحميل المشاريع.</p>';
    }
  }

  logoutButton.addEventListener('click', async () => {
      try {
          await signOut(auth);
      } catch (error) {
          console.error("Logout Error:", error);
          alert("فشل تسجيل الخروج. يرجى المحاولة مرة أخرى.");
      }
  });

</script>

<style is:global>
  .supervisor-dashboard-page { direction: rtl; font-family: 'Cairo', sans-serif; background-color: #f4f7f6; min-height: 100vh; padding: 2rem; }
  #auth-loading-message { text-align: center; padding-top: 5rem; font-size: 1.2rem; }
  .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 2px solid #e2e8f0; }
  .dashboard-header h1 { font-size: 2.2rem; color: #1a202c; font-weight: 800; }
  .dashboard-header p { color: #4a5568; }
  .btn-logout { background-color: #ef4444; color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: background-color 0.2s; }
  .btn-logout:hover { background-color: #dc2626; }
  
  .projects-grid { 
    display: grid; 
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); 
    gap: 2rem; 
  }

  .project-card { 
    display: flex;
    background: #ffffff;
    border-radius: 12px; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.07); 
    overflow: hidden;
    text-decoration: none;
    color: inherit;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .project-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.12);
  }

  .project-card-content {
    flex-grow: 1;
    padding: 1.25rem;
    display: flex;
    flex-direction: column;
    text-align: right; /* Ensure text is right-aligned in RTL */
  }

  .project-card h3 { 
    font-size: 1.4rem; 
    font-weight: 700; 
    color: #2d3748; 
    margin: 0 0 0.5rem 0;
  }

  .project-address { 
    font-size: 1rem; 
    color: #718096; 
    margin: 0;
    flex-grow: 1;
  }

  .project-card-action {
    margin-top: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 600;
    color: #3f51b5;
  }
  
  .project-card:hover .project-card-action {
    color: #36469e;
  }
  
  .arrow-icon {
    font-size: 1.5rem;
    transition: transform 0.2s;
  }
  /* Correct arrow direction for RTL */
  .project-card:hover .arrow-icon {
    transform: translateX(-5px);
  }

  .project-card-icon-wrapper {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 110px;
    background-color: #f0f2f9;
  }

  .card-icon {
    width: 40px;
    height: 40px;
    color: #3f51b5;
  }

  .info-message, .error-message { text-align: center; font-size: 1.1rem; color: #555; background-color: #fff; border-radius: 8px; padding: 2rem; }
</style>