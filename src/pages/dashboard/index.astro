---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="لوحة تحكم المشرف">
  <main class="supervisor-dashboard-page">

    <!-- Auth Loading State -->
    <div id="auth-loading-message">
        <p>جارٍ التحقق من صلاحيات الدخول...</p>
    </div>

    <!-- Main Dashboard Content (hidden by default) -->
    <div id="dashboard-content" style="display: none;">
      <header class="dashboard-header">
        <div>
          <h1>لوحة تحكم المشرف</h1>
          <p>مرحباً بك، <span id="user-name-placeholder"></span>! هذه هي المشاريع المسؤولة عنها.</p>
        </div>
        <button id="logout-button" class="btn btn-logout">تسجيل الخروج</button>
      </header>

      <div id="projects-list" class="projects-container"></div>
      
      <div id="no-projects-message" class="info-message" style="display: none;">
        <p>لم يتم تعيين أي مشاريع لك حتى الآن.</p>
      </div>
    </div>

  </main>
</Layout>

<script>
  import { auth, db } from '../../firebase/client';
  import { onAuthStateChanged, signOut } from "firebase/auth";
  import { collection, getDocs, query, where, getDoc, doc } from "firebase/firestore";

  const loadingMessage = document.getElementById('auth-loading-message')!;
  const dashboardContent = document.getElementById('dashboard-content')!;
  const userNamePlaceholder = document.getElementById('user-name-placeholder')!;
  const projectsList = document.getElementById('projects-list')!;
  const noProjectsMessage = document.getElementById('no-projects-message')!;
  const logoutButton = document.getElementById('logout-button')!;

  onAuthStateChanged(auth, async (user) => {
    if (user) {
        const userDocRef = doc(db, "users", user.uid);
        const userDoc = await getDoc(userDocRef);

        if (userDoc.exists() && userDoc.data().role === 'supervisor') {
            const supervisorName = userDoc.data().name || 'المشرف';
            userNamePlaceholder.textContent = supervisorName;
            await fetchAndDisplayProjects(user.uid, supervisorName);
            loadingMessage.style.display = 'none';
            dashboardContent.style.display = 'block';
        } else {
            window.location.href = '/admin';
        }
    } else {
        window.location.href = '/admin';
    }
  });

  async function fetchAndDisplayProjects(supervisorUid, supervisorName) {
    try {
        const q = query(collection(db, "projects"), where("supervisorIds", "array-contains", supervisorUid));
        const querySnapshot = await getDocs(q);
        const supervisedProjects = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        if (supervisedProjects.length === 0) {
            noProjectsMessage.style.display = 'block';
            projectsList.innerHTML = '';
        } else {
            noProjectsMessage.style.display = 'none';
            projectsList.innerHTML = supervisedProjects.map(project => {
                return `<div class="project-card">
                          <div class="card-item">
                            <span class="item-label">اسم المشروع</span>
                            <p class="item-value">${project.projectName}</p>
                          </div>
                          <div class="card-item">
                            <span class="item-label">اسم المشرف</span>
                            <p class="item-value">${supervisorName}</p>
                          </div>
                           <div class="card-item">
                            <span class="item-label">عنوان المشروع</span>
                            <p class="item-value">${project.projectAddress || 'غير محدد'}</p>
                          </div>
                        </div>`;
            }).join('');
        }
    } catch (error) {
        console.error("Error fetching projects: ", error);
        projectsList.innerHTML = '<p class="error-message">حدث خطأ أثناء تحميل المشاريع.</p>';
    }
  }

  logoutButton.addEventListener('click', async () => {
      try {
          await signOut(auth);
      } catch (error) {
          console.error("Logout Error:", error);
          alert("فشل تسجيل الخروج. يرجى المحاولة مرة أخرى.");
      }
  });

</script>

<style is:global>
  .supervisor-dashboard-page { 
    direction: rtl; 
    font-family: 'Cairo', sans-serif; 
    background-color: #f4f7f6; 
    min-height: 100vh; 
    padding: 2rem;
  }
  
  #auth-loading-message { 
    text-align: center; 
    padding-top: 5rem; 
    font-size: 1.2rem; 
  }
  
  .dashboard-header { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    margin-bottom: 3rem;
    padding-bottom: 1.5rem; 
    border-bottom: 2px solid #e2e8f0; 
  }
  
  .dashboard-header h1 { font-size: 2.2rem; color: #1a202c; font-weight: 800; }
  .dashboard-header p { color: #4a5568; }
  
  .btn-logout { background-color: #ef4444; color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: background-color 0.2s; }
  .btn-logout:hover { background-color: #dc2626; }
  
  .projects-container { 
    display: flex; 
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 1.5rem;
    width: 100%;
  }

  .project-card { 
    width: 100%;
    max-width: 800px;
    background: #ffffff;
    border-radius: 12px; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.07); 
    padding: 1.5rem 2rem;
    display: flex;
    flex-direction: row; /* Changed to row */
    justify-content: space-between; /* Distribute items */
    align-items: flex-start; /* Align to the top */
    flex-wrap: wrap; /* Allow items to wrap on small screens */
    gap: 1rem;
  }

  .card-item {
    flex-grow: 1; /* Allow items to grow */
    min-width: 200px; /* Give a minimum width to prevent squishing */
  }

  .item-label {
    display: block;
    font-size: 0.9rem;
    font-weight: 700;
    color: #718096;
    margin-bottom: 0.25rem;
  }

  .item-value {
    font-size: 1.2rem;
    font-weight: 600;
    color: #2d3748;
    margin: 0;
  }

  .info-message, .error-message { 
    text-align: center; 
    font-size: 1.1rem; 
    color: #555; 
    background-color: #fff; 
    border-radius: 8px; 
    padding: 2rem; 
    max-width: 800px;
    margin: 0 auto;
  }
</style>
